<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ClinCalc â€” è‡¨åºŠæ±ºç­–è¼”åŠ©å¹³å° v7</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>

:root{
  --c0:#060810;--c1:#0d1220;--c2:#141c2e;--c3:#1a2438;--c4:#1e2840;
  --teal:#00c9a7;--teal2:#00a389;--teall:rgba(0,201,167,.12);
  --amber:#f59e0b;--ambl:rgba(245,158,11,.1);
  --rose:#f43f5e;--rosel:rgba(244,63,94,.1);
  --sky:#38bdf8;--skyl:rgba(56,189,248,.1);
  --violet:#a78bfa;--violetl:rgba(167,139,250,.1);
  --emerald:#10b981;
  --t1:#e8edf8;--t2:#8896b0;--t3:#4a566e;
  --bd:rgba(255,255,255,.06);--bda:rgba(0,201,167,.2);
  --r:10px;
  --ff-h:'Syne',sans-serif;
  --ff-b:'Noto Sans TC',sans-serif;
  --ff-m:'JetBrains Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:var(--ff-b);background:var(--c0);color:var(--t1);min-height:100vh;
  background-image:
    radial-gradient(ellipse 60% 40% at 10% 5%,rgba(0,201,167,.07) 0%,transparent 55%),
    radial-gradient(ellipse 50% 35% at 90% 95%,rgba(56,189,248,.05) 0%,transparent 55%),
    url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='g' width='60' height='60' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='30' cy='30' r='.4' fill='rgba(255,255,255,.02)'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23g)'/%3E%3C/svg%3E");
}

/* TOPNAV */
.tnav{position:fixed;top:0;left:0;right:0;height:56px;background:rgba(6,8,16,.92);
  backdrop-filter:blur(24px);border-bottom:1px solid var(--bd);z-index:300;
  display:flex;align-items:center;padding:0 20px;gap:4px;}
.tlogo{display:flex;align-items:center;gap:9px;margin-right:24px;text-decoration:none;}
.tlogo-m{width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--teal) 0%,var(--sky) 100%);
  display:flex;align-items:center;justify-content:center;
  font-family:var(--ff-h);font-size:14px;font-weight:800;color:#000;
  box-shadow:0 4px 14px rgba(0,201,167,.35);}
.tlogo-t{font-family:var(--ff-h);font-size:17px;font-weight:700;color:var(--t1);}
.tlogo-v{font-family:var(--ff-m);font-size:9px;color:var(--t3);margin-left:2px;align-self:flex-end;margin-bottom:3px;}
.ntab{padding:5px 15px;border-radius:6px;border:none;background:none;
  font-family:var(--ff-b);font-size:13px;font-weight:500;color:var(--t2);
  cursor:pointer;transition:all .15s;white-space:nowrap;}
.ntab:hover{color:var(--t1);background:rgba(255,255,255,.04);}
.ntab.on{color:var(--teal);background:rgba(0,201,167,.1);}
.ntab.dr-tab{color:var(--violet);}
.ntab.dr-tab.on{color:var(--violet);background:rgba(167,139,250,.12);}
.nright{margin-left:auto;display:flex;align-items:center;gap:8px;}
.nbadge{font-family:var(--ff-m);font-size:9.5px;padding:3px 8px;
  border:1px solid rgba(0,201,167,.3);border-radius:100px;color:var(--teal);letter-spacing:.5px;}
.drbtn{padding:5px 13px;border-radius:6px;border:1px solid rgba(255,255,255,.1);
  background:none;color:var(--t2);font-size:12px;font-family:var(--ff-m);cursor:pointer;transition:all .15s;}
.drbtn:hover{border-color:var(--violet);color:var(--violet);}
.drbtn.on{background:rgba(167,139,250,.1);border-color:var(--violet);color:var(--violet);}
.dpulse{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--emerald);
  margin-right:5px;animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}

/* LAYOUT */
.wrap{margin-top:56px;}
.sec{display:none;animation:fadeUp .25s ease;}
.sec.on{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* CARDS */
.card{background:var(--c1);border:1px solid var(--bd);border-radius:var(--r);padding:20px;transition:border-color .2s;}
.card:hover{border-color:rgba(0,201,167,.12);}
.ch{font-family:var(--ff-m);font-size:9.5px;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--t3);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.ch::after{content:'';flex:1;height:1px;background:var(--bd);}

/* FORM */
.fg{margin-bottom:12px;}
.fl{display:block;font-size:11.5px;color:var(--t2);margin-bottom:5px;font-weight:500;}
.fi,.fsel{width:100%;padding:8px 11px;background:var(--c2);border:1px solid var(--bd);
  border-radius:6px;color:var(--t1);font-family:var(--ff-m);font-size:12.5px;outline:none;transition:all .15s;}
.fi:focus,.fsel:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(0,201,167,.07);}
.fi::placeholder{color:var(--t3);}
.fsel option{background:var(--c2);}
.fro{display:flex;gap:14px;margin-top:4px;}
.ro{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12.5px;font-family:var(--ff-m);color:var(--t2);}
.ro input{accent-color:var(--teal);}
.iu{position:relative;}
.iu .fi{padding-right:48px;}
.uu{position:absolute;right:9px;top:50%;transform:translateY(-50%);font-family:var(--ff-m);font-size:9.5px;color:var(--t3);pointer-events:none;}
.hint{font-size:11px;color:var(--t3);margin-top:3px;line-height:1.5;}
.section-divider{font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);padding:4px 0 10px;border-bottom:1px solid var(--bd);margin:14px 0 12px;}

/* GRID */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.g5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}

/* BUTTONS */
.brow{display:flex;gap:9px;flex-wrap:wrap;margin-top:16px;}
.btn{padding:9px 20px;border-radius:7px;font-size:13px;font-weight:600;
  font-family:var(--ff-b);cursor:pointer;border:none;transition:all .18s;
  display:inline-flex;align-items:center;gap:6px;}
.bt{background:var(--teal);color:#000;}
.bt:hover{background:var(--teal2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,201,167,.28);}
.bs{background:rgba(255,255,255,.05);color:var(--t1);border:1px solid var(--bd);}
.bs:hover{background:rgba(255,255,255,.08);}
.ba{background:rgba(244,63,94,.1);color:#fb7185;border:1px solid rgba(244,63,94,.2);}
.ba:hover{background:rgba(244,63,94,.18);}
.bv{background:rgba(167,139,250,.12);color:var(--violet);border:1px solid rgba(167,139,250,.25);}
.bv:hover{background:rgba(167,139,250,.2);}
.bg-a{background:var(--amber);color:#000;}
.bg-a:hover{background:#d97706;transform:translateY(-1px);}
.bg-s{background:var(--sky);color:#000;}
.bg-s:hover{background:#0ea5e9;transform:translateY(-1px);}

/* ALERTS */
.al{padding:11px 14px;border-radius:7px;font-size:12.5px;display:flex;align-items:flex-start;gap:9px;margin-bottom:9px;line-height:1.65;border-left:3px solid;}
.ag{background:rgba(0,201,167,.07);border-color:var(--teal);color:#6ee7d4;}
.ay{background:var(--ambl);border-color:var(--amber);color:#fcd34d;}
.ar{background:var(--rosel);border-color:var(--rose);color:#fda4af;}
.ai{background:rgba(56,189,248,.06);border-color:var(--sky);color:#7dd3fc;}
.av{background:var(--violetl);border-color:var(--violet);color:#c4b5fd;}
.ad{background:rgba(255,255,255,.03);border-color:var(--t3);color:var(--t2);}

/* RESULT */
.rp{display:none;margin-top:20px;}
.rp.on{display:block;animation:fadeUp .25s ease;}
.rmain{background:var(--c1);border:1px solid var(--bda);border-radius:var(--r);padding:22px 26px;margin-bottom:14px;
  background-image:linear-gradient(135deg,rgba(0,201,167,.04),transparent);}
.rbig{font-family:var(--ff-h);font-size:32px;font-weight:700;letter-spacing:-1px;margin:5px 0 3px;}
.rcells{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.rcell{background:var(--c2);border:1px solid var(--bd);border-radius:7px;padding:13px 16px;}
.rl{font-family:var(--ff-m);font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:5px;}
.rv{font-family:var(--ff-m);font-size:18px;font-weight:600;}
.rs{font-size:11px;color:var(--t2);margin-top:2px;}

/* TAGS */
.tag{display:inline-flex;align-items:center;gap:4px;padding:2px 9px;border-radius:100px;
  font-family:var(--ff-m);font-size:9.5px;font-weight:600;letter-spacing:.2px;}
.tt{background:var(--teall);color:var(--teal);border:1px solid rgba(0,201,167,.2);}
.ta{background:var(--ambl);color:var(--amber);border:1px solid rgba(245,158,11,.2);}
.tr{background:var(--rosel);color:#fb7185;border:1px solid rgba(244,63,94,.2);}
.tb{background:var(--skyl);color:var(--sky);border:1px solid rgba(56,189,248,.2);}
.tv{background:var(--violetl);color:var(--violet);border:1px solid rgba(167,139,250,.2);}

/* COLORS */
.ct{color:var(--teal)!important;}
.ca{color:var(--amber)!important;}
.cr{color:var(--rose)!important;}
.cb{color:var(--sky)!important;}
.cv{color:var(--violet)!important;}
.cs{color:var(--t2)!important;}

/* TABLE */
.dt{width:100%;border-collapse:collapse;font-size:12px;}
.dt th{background:var(--c2);padding:8px 12px;text-align:left;font-family:var(--ff-m);
  font-size:9px;letter-spacing:1.2px;text-transform:uppercase;color:var(--t3);border-bottom:1px solid var(--bd);}
.dt td{padding:8px 12px;border-bottom:1px solid var(--bd);color:var(--t2);vertical-align:middle;}
.dt tr:hover td{background:rgba(255,255,255,.012);}
.dt tr:last-child td{border-bottom:none;}

/* CALC TABS */
.ctabs{display:flex;gap:2px;background:var(--c2);padding:4px;border-radius:8px;margin-bottom:20px;flex-wrap:wrap;}
.ctab{flex:1;min-width:80px;padding:7px 10px;border-radius:5px;font-size:12px;font-weight:500;
  cursor:pointer;text-align:center;transition:all .15s;color:var(--t3);border:none;background:none;
  font-family:var(--ff-b);white-space:nowrap;}
.ctab.on{background:var(--c1);color:var(--t1);box-shadow:0 2px 8px rgba(0,0,0,.4);}
.cp{display:none;}
.cp.on{display:block;animation:fadeUp .2s ease;}

/* HOME */
.hero{padding:64px 48px 48px;max-width:1100px;margin:0 auto;}
.eyebrow{font-family:var(--ff-m);font-size:10px;letter-spacing:2.5px;color:var(--teal);text-transform:uppercase;margin-bottom:14px;}
.h1{font-family:var(--ff-h);font-size:48px;font-weight:800;letter-spacing:-2px;line-height:1.1;margin-bottom:16px;}
.h1 span{background:linear-gradient(90deg,var(--teal),var(--sky));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hsub{font-size:15px;color:var(--t2);max-width:500px;line-height:1.8;margin-bottom:28px;}
.hbtns{display:flex;gap:10px;flex-wrap:wrap;}
.stat-r{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;max-width:1100px;margin:0 auto;padding:0 48px 40px;}
.sc{background:var(--c1);border:1px solid var(--bd);border-radius:var(--r);padding:18px;}
.sv{font-family:var(--ff-h);font-size:22px;font-weight:700;color:var(--teal);}
.sl{font-size:10.5px;color:var(--t3);margin-top:3px;font-family:var(--ff-m);letter-spacing:.4px;}
.feat-g{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;max-width:1100px;margin:0 auto;padding:0 48px 40px;}
.fc{background:var(--c1);border:1px solid var(--bd);border-radius:var(--r);padding:20px;cursor:pointer;transition:all .22s;position:relative;overflow:hidden;}
.fc::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--teal),var(--sky));transform:scaleX(0);transform-origin:left;transition:.25s;}
.fc:hover::after{transform:scaleX(1);}
.fc:hover{border-color:rgba(0,201,167,.18);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.3);}
.fc-i{font-size:24px;margin-bottom:12px;}
.fc-t{font-family:var(--ff-h);font-size:14px;font-weight:700;margin-bottom:6px;}
.fc-d{font-size:12px;color:var(--t2);line-height:1.65;}
.fc-rf{display:inline-block;margin-top:9px;font-family:var(--ff-m);font-size:9px;padding:2px 7px;border:1px solid var(--bd);border-radius:4px;color:var(--t3);}

/* SECTION INNER */
.si{max-width:1100px;margin:0 auto;padding:32px 48px;}
.ph{margin-bottom:22px;border-bottom:1px solid var(--bd);padding-bottom:14px;}
.pt{font-family:var(--ff-h);font-size:26px;font-weight:700;letter-spacing:-.5px;margin-bottom:4px;}
.ps{font-size:13px;color:var(--t2);}
.ptags{display:flex;gap:7px;margin-top:9px;flex-wrap:wrap;}

/* DR SECTION BLOCKS */
.drblock{background:linear-gradient(135deg,rgba(0,201,167,.03),rgba(56,189,248,.02));
  border:1px solid rgba(0,201,167,.12);border-radius:var(--r);padding:16px;margin-bottom:14px;}
.drbt{font-family:var(--ff-h);font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:7px;color:var(--t1);}

/* QUALIFY */
.qbox{background:var(--c2);border:1px solid var(--bd);border-left-width:3px;border-radius:var(--r);padding:16px;margin-bottom:11px;transition:border-color .2s;}
.qhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.qtit{font-size:13.5px;font-weight:600;}
.qis{display:flex;flex-direction:column;gap:6px;}
.qi{display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--t2);line-height:1.5;}
.qdot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.qok{background:var(--teal);}
.qno{background:var(--t3);}
.qwarn{background:var(--amber);}
.qnote{margin-top:10px;font-size:11.5px;color:var(--t2);padding:9px 12px;background:rgba(255,255,255,.025);border-radius:6px;line-height:1.65;}

/* LOADER */
.loader{display:none;position:fixed;inset:0;background:rgba(6,8,16,.92);z-index:999;
  align-items:center;justify-content:center;flex-direction:column;gap:14px;backdrop-filter:blur(8px);}
.loader.on{display:flex;}
.spin{width:40px;height:40px;border:2px solid rgba(0,201,167,.15);border-top-color:var(--teal);border-radius:50%;animation:sp .65s linear infinite;}
@keyframes sp{to{transform:rotate(360deg)}}
.ltxt{font-family:var(--ff-m);font-size:11.5px;color:var(--t2);}

/* MODAL */
.mbg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:400;
  align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.mbg.on{display:flex;}
.mbox{background:var(--c1);border:1px solid var(--bda);border-radius:14px;padding:28px;width:420px;max-width:92vw;animation:fadeUp .2s ease;}
.mt{font-family:var(--ff-h);font-size:20px;font-weight:700;margin-bottom:5px;}
.ms{font-size:12.5px;color:var(--t2);margin-bottom:18px;}

/* DB CARDS */
.dbcard{background:var(--c1);border:1px solid var(--bd);border-radius:var(--r);padding:18px;cursor:pointer;transition:all .2s;margin-bottom:10px;}
.dbcard:hover{border-color:var(--bda);box-shadow:0 4px 20px rgba(0,0,0,.2);}
.dbcard-h{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;}
.dbcard-t{font-size:14px;font-weight:600;}
.dbcard-m{font-size:11.5px;color:var(--t2);line-height:1.6;}
.dbcard-url{font-family:var(--ff-m);font-size:10px;color:var(--teal);margin-top:6px;display:flex;align-items:center;gap:4px;}
.dbcard-url a{color:var(--teal);text-decoration:none;}
.dbcard-url a:hover{text-decoration:underline;}

/* SYM TAGS */
.sym-g{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;}
.stag{padding:6px 13px;background:var(--c2);border:1px solid var(--bd);border-radius:100px;
  font-size:12px;cursor:pointer;transition:all .15s;font-family:var(--ff-m);color:var(--t2);}
.stag:hover{border-color:rgba(0,201,167,.3);color:var(--teal);}
.stag.on{background:var(--teall);border-color:var(--teal);color:var(--teal);}
.stag.urgent{border-color:rgba(244,63,94,.25);color:#fda4af;}
.stag.urgent.on{background:var(--rosel);}

/* AI BLOCK */
.aiblock{background:var(--c2);border:1px solid var(--bda);border-radius:var(--r);padding:16px;margin-bottom:12px;}
.aih{font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--teal);margin-bottom:10px;}
.aipt{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--bd);font-size:12.5px;line-height:1.65;color:var(--t2);}
.aipt:last-child{border-bottom:none;}
.aidot{width:4px;height:4px;border-radius:50%;background:var(--teal);margin-top:7px;flex-shrink:0;}

/* DISCLAIMER */
.dis{margin-top:16px;padding:12px 14px;background:var(--c2);border:1px solid var(--bd);border-radius:var(--r);font-size:11px;color:var(--t3);line-height:1.7;}

/* AI LOCKED STATE */
.ai-locked{opacity:.4;pointer-events:none;user-select:none;filter:grayscale(0.5);transition:opacity .3s,filter .3s;}
.ai-unlocked{opacity:1;pointer-events:auto;filter:none;transition:opacity .3s,filter .3s;}
.lock-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 11px;border-radius:6px;font-family:var(--ff-m);font-size:9.5px;background:rgba(255,255,255,.04);border:1px solid var(--bd);color:var(--t3);margin-bottom:12px;}
.lock-badge.unlocked{background:rgba(0,201,167,.08);border-color:rgba(0,201,167,.25);color:var(--teal);}
.api-test-row{display:flex;gap:9px;align-items:center;flex-wrap:wrap;margin-top:6px;}
.test-status{font-family:var(--ff-m);font-size:11px;padding:5px 12px;border-radius:6px;display:none;}
.test-status.ok{display:inline-block;background:rgba(0,201,167,.1);color:var(--teal);border:1px solid rgba(0,201,167,.25);}
.test-status.fail{display:inline-block;background:rgba(244,63,94,.1);color:#fda4af;border:1px solid rgba(244,63,94,.2);}

/* SUPABASE GUIDE */
.sb-step{background:var(--c2);border:1px solid var(--bd);border-radius:var(--r);padding:16px;margin-bottom:12px;position:relative;transition:border-color .2s;}
.sb-step:hover{border-color:rgba(0,201,167,.15);}
.sb-step-num{position:absolute;top:-10px;left:16px;width:22px;height:22px;border-radius:50%;background:var(--teal);color:#000;font-family:var(--ff-m);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;}
.sb-step-t{font-family:var(--ff-h);font-size:13px;font-weight:700;margin-bottom:8px;padding-top:4px;}
.sb-step-d{font-size:12.5px;color:var(--t2);line-height:1.75;}
.sb-code{background:var(--c0);border:1px solid var(--bd);border-radius:6px;padding:12px;font-family:var(--ff-m);font-size:11px;color:#a5f3fc;margin:8px 0;overflow-x:auto;white-space:pre;line-height:1.65;}
.sb-copy-btn{font-family:var(--ff-m);font-size:10px;padding:3px 9px;background:rgba(255,255,255,.05);border:1px solid var(--bd);border-radius:4px;color:var(--t2);cursor:pointer;float:right;margin-top:-2px;}
.sb-copy-btn:hover{color:var(--teal);border-color:rgba(0,201,167,.3);}

/* REFS ENHANCEMENTS */
.ref-cat-filter{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;}
.ref-cat-btn{padding:4px 12px;border-radius:100px;font-size:11.5px;font-family:var(--ff-m);border:1px solid var(--bd);background:none;color:var(--t3);cursor:pointer;transition:all .15s;}
.ref-cat-btn.on,.ref-cat-btn:hover{background:rgba(0,201,167,.1);border-color:rgba(0,201,167,.3);color:var(--teal);}
.ref-search-bar{width:100%;padding:8px 12px;background:var(--c2);border:1px solid var(--bd);border-radius:7px;color:var(--t1);font-family:var(--ff-b);font-size:13px;outline:none;margin-bottom:12px;transition:border-color .15s;}
.ref-search-bar:focus{border-color:var(--teal);}
.ref-search-bar::placeholder{color:var(--t3);}

/* PROVIDER CARDS */
.provider-card{background:var(--c2);border:1px solid var(--bd);border-radius:var(--r);padding:14px 12px;
  cursor:pointer;text-align:center;transition:all .2s;position:relative;}
.provider-card:hover{border-color:rgba(0,201,167,.2);transform:translateY(-1px);}
.provider-card.active{border-color:var(--teal);background:rgba(0,201,167,.05);box-shadow:0 0 0 1px rgba(0,201,167,.15);}
.provider-card.active::after{content:'âœ“';position:absolute;top:6px;right:8px;font-family:var(--ff-m);font-size:10px;color:var(--teal);}
.pc-icon{font-size:22px;margin-bottom:6px;}
.pc-name{font-family:var(--ff-h);font-size:13px;font-weight:700;margin-bottom:2px;}
.pc-sub{font-size:10px;color:var(--t3);font-family:var(--ff-m);margin-bottom:4px;}
.pc-model{font-size:9.5px;color:var(--t2);font-family:var(--ff-m);padding:2px 6px;background:rgba(0,0,0,.3);border-radius:4px;display:inline-block;}

/* DEID TAGS */
.deid-block-tag{padding:5px 10px;background:rgba(244,63,94,.07);border:1px solid rgba(244,63,94,.15);
  border-radius:5px;font-size:11.5px;color:#fda4af;font-family:var(--ff-m);text-align:center;}

/* PROVIDER FIELDS */
.pf-section{animation:fadeUp .2s ease;}
.pf-label{font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--teal);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--bd);}

/* DEPLOY */
.deploy{background:linear-gradient(135deg,rgba(56,189,248,.05),rgba(0,201,167,.03));
  border:1px solid rgba(56,189,248,.15);border-radius:var(--r);padding:18px;margin-bottom:14px;}

/* TABS for DB */
.dbtabs{display:flex;gap:2px;background:var(--c2);padding:3px;border-radius:7px;margin-bottom:16px;}
.dbtab{flex:1;padding:7px;border-radius:5px;font-size:12px;cursor:pointer;text-align:center;
  transition:all .15s;color:var(--t3);border:none;background:none;font-family:var(--ff-b);}
.dbtab.on{background:var(--c1);color:var(--t1);box-shadow:0 2px 6px rgba(0,0,0,.4);}
.dbp{display:none;}
.dbp.on{display:block;animation:fadeUp .2s ease;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--c3);border-radius:4px;}

/* RESPONSIVE */
@media(max-width:960px){
  .hero,.si{padding:36px 20px;}
  .feat-g,.stat-r{grid-template-columns:1fr 1fr;padding:0 20px 32px;}
  .g2,.g3,.g4,.g5,.rcells{grid-template-columns:1fr 1fr;}
}
@media(max-width:640px){
  .feat-g,.stat-r{grid-template-columns:1fr;}
  .g2,.g3,.g4,.g5,.rcells{grid-template-columns:1fr;}
  .h1{font-size:30px;}
  .tnav .ntab:not(.on){display:none;}
}

</style>
</head>
<body>

<nav class="tnav">
  <a class="tlogo" href="#" onclick="showSec('home');return false;">
    <div class="tlogo-m">C+</div>
    <div class="tlogo-t">ClinCalc</div>
    <span class="tlogo-v">v6</span>
  </a>
  <button class="ntab on" onclick="showSec('home')">é¦–é </button>
  <button class="ntab" onclick="showSec('calc')">è¨ˆç®—å·¥å…·</button>
  <button class="ntab" onclick="showSec('ai')">AI æª¢æ¸¬</button>
  <button class="ntab dr-tab" onclick="goDr()">é†«å¸«å°ˆå€</button>
  <div class="nright">
    <span class="nbadge">ADA 2026</span>
    <span class="nbadge" style="border-color:rgba(56,189,248,.3);color:var(--sky);">KDIGO 2024</span>
    <button class="drbtn" id="drBtn" onclick="goDr()">ğŸ” é†«å¸«ç™»å…¥</button>
  </div>
</nav>
<div class="wrap">

<div class="sec on" id="s-home">
  <div class="hero">
    <div class="eyebrow">è‡¨åºŠæ±ºç­–è¼”åŠ©å¹³å° Â· å®Œå…¨å…è²» Â· ç„¡éœ€å®‰è£</div>
    <h1 class="h1">ç²¾æº–è¨ˆç®—<br><span>è‡¨åºŠæ±ºç­–</span></h1>
    <p class="hsub">æ•´åˆ ADA 2026ã€KDIGO 2024 æœ€æ–°æŒ‡å¼•ã€‚æ”¯æ´ Claude / GPT / Gemini / Supabase AI å››å¤§æä¾›å•†ï¼Œå»è­˜åˆ¥åŒ–è³‡æ–™å„²å­˜ï¼Œå®Œå…¨å…è²»ï¼Œè³‡æ–™ä¸é›¢é–‹æ‚¨çš„è£ç½®ã€‚</p>
    <div class="hbtns">
      <button class="btn bt" onclick="showSec('calc')" style="font-size:14px;padding:11px 26px;">ğŸ”¬ è¨ˆç®—å·¥å…·</button>
      <button class="btn bs" onclick="showSec('ai')" style="font-size:14px;padding:11px 26px;">ğŸ¤– AI æª¢æ¸¬</button>
      <button class="btn bv" onclick="goDr()" style="font-size:14px;padding:11px 26px;">ğŸ‘¨â€âš•ï¸ é†«å¸«å°ˆå€</button>
    </div>
  </div>
  <div class="stat-r">
    <div class="sc"><div class="sv">å…è²»</div><div class="sl">æ°¸ä¹…å…è²»</div></div>
    <div class="sc"><div class="sv">é›¢ç·š</div><div class="sl">è¨ˆç®—ä¸éœ€ç¶²è·¯</div></div>
    <div class="sc"><div class="sv">ADA 2026</div><div class="sl">æœ€æ–°é†«å­¸æŒ‡å¼•</div></div>
    <div class="sc"><div class="sv">0 ä¸Šå‚³</div><div class="sl">è³‡æ–™ä¸é›¢è£ç½®</div></div>
    <div class="sc"><div class="sv">PostgreSQL</div><div class="sl">é†«å¸«é›²ç«¯å„²å­˜</div></div>
  </div>
  <div class="feat-g">
    <div class="fc" onclick="showCalc('ckd')"><div class="fc-i">â—</div><div class="fc-t">æ…¢æ€§è…è‡Ÿç—… CKD</div><div class="fc-d">eGFR CKD-EPI 2021ã€åˆ†æœŸã€UACRçŸ©é™£ã€Early CKDæ”¶æ¡ˆ</div><span class="fc-rf">KDIGO 2024</span></div>
    <div class="fc" onclick="showCalc('dm')"><div class="fc-i">â—ˆ</div><div class="fc-t">ç³–å°¿ç—… / è¡€ç³–</div><div class="fc-d">HbA1cè¨ºæ–·ã€GMIä¼°ç®—ã€ä»£è¬ç—‡å€™ç¾¤ã€ADA 2026ç›®æ¨™</div><span class="fc-rf">ADA 2026</span></div>
    <div class="fc" onclick="showCalc('cv')"><div class="fc-i">â—‡</div><div class="fc-t">å¿ƒè¡€ç®¡ / è¡€è„‚</div><div class="fc-d">ASCVD 10å¹´é¢¨éšªã€LDLç›®æ¨™ã€å¥ä¿Statiné–‹ç«‹æ¢ä»¶</div><span class="fc-rf">ACC/AHA 2022</span></div>
    <div class="fc" onclick="showCalc('anemia')"><div class="fc-i">â—‰</div><div class="fc-t">è²§è¡€ / è¡€çƒ</div><div class="fc-d">MCVåˆ†é¡ã€Mentzer indexã€ç¼ºéµã€åœ°ä¸­æµ·å‹</div><span class="fc-rf">WHO</span></div>
    <div class="fc" onclick="showCalc('liver')"><div class="fc-i">â—</div><div class="fc-t">è‚åŠŸèƒ½</div><div class="fc-d">FIB-4ã€APRIã€Child-Pughã€B/Cè‚è¿½è¹¤</div><span class="fc-rf">EASL 2023</span></div>
    <div class="fc" onclick="showCalc('thyroid')"><div class="fc-i">â—‘</div><div class="fc-t">ç”²ç‹€è…ºåŠŸèƒ½</div><div class="fc-d">TSHåˆ†é¡ã€FT4ã€FT3ã€å¦Šå¨ æ¨™æº–ã€æ©‹æœ¬æ°</div><span class="fc-rf">ATA 2023</span></div>
    <div class="fc" onclick="showCalc('bone')"><div class="fc-i">â—«</div><div class="fc-t">éª¨è³ª / è…éª¨</div><div class="fc-d">Ca / P / PTH / Vit Dã€è…æ€§éª¨ç—…ã€CKD-MBD</div><span class="fc-rf">KDIGO 2017</span></div>
    <div class="fc" onclick="showCalc('sens')"><div class="fc-i">âŠ•</div><div class="fc-t">éˆæ•åº¦ / ç‰¹ç•°åº¦</div><div class="fc-d">Se/Sp/PPV/NPV/LR+/LRâˆ’/Youden Jã€è²æ°ä¿®æ­£</div><span class="fc-rf">çµ±è¨ˆåˆ†æ</span></div>
    <div class="fc" onclick="goDr()"><div class="fc-i">â—ˆ</div><div class="fc-t" style="color:var(--violet);">é†«å¸«å°ˆå€</div><div class="fc-d">å®Œæ•´å¥æª¢åˆ¤è®€ã€å¥ä¿æ”¶æ¡ˆè³‡æ ¼ã€è³‡æ–™åº«ã€AIé†«å¸«ç¸½è©•</div><span class="fc-rf" style="border-color:rgba(167,139,250,.2);color:var(--violet);">é†«å¸«å°ˆç”¨</span></div>
  </div>
  <div class="si" style="padding-top:0;">
    <div class="deploy">
      <div style="font-family:var(--ff-h);font-size:15px;font-weight:700;margin-bottom:10px;color:var(--sky);">ğŸŒ å…è²»éƒ¨ç½²æ•™å­¸ â€” è®“ä»»ä½•äººéƒ½èƒ½è¼¸å…¥ç¶²å€ä½¿ç”¨</div>
      <div style="font-size:12.5px;color:var(--t2);line-height:1.9;">
        â‘  <strong style="color:var(--t1);">GitHub Pages</strong>ï¼ˆæ¨è–¦ï¼‰ï¼šä¸Šå‚³è‡³ GitHub repo â†’ Settings â†’ Pages â†’ é¸æ“‡ main branch â†’ å„²å­˜ã€‚10åˆ†é˜ç²å¾—å…è²»ç¶²å€ <code style="font-family:var(--ff-m);font-size:11px;background:var(--c3);padding:2px 6px;border-radius:3px;">yourname.github.io/clincalc</code><br>
        â‘¡ <strong style="color:var(--t1);">Netlify</strong>ï¼šæ‹–æ›³ HTML è‡³ netlify.com/dropï¼Œ30ç§’å®Œæˆã€‚å…è²»æ–¹æ¡ˆè¶³å¤ <br>
        â‘¢ <strong style="color:var(--t1);">Vercel</strong>ï¼šæ”¯æ´éœæ…‹ HTMLï¼Œå…è²»æ–¹æ¡ˆæœˆæµé‡ 100GB<br>
        <div style="margin-top:8px;padding:8px;background:rgba(0,0,0,.2);border-radius:5px;font-family:var(--ff-m);font-size:10.5px;">
          ğŸ’¡ å¾Œç«¯ PostgreSQL / Supabaseï¼ˆé†«å¸«æ¨¡å¼ç”¨ï¼‰ï¼šå»ºç«‹ Supabase å°ˆæ¡ˆ â†’ è¤‡è£½ URL å’Œ anon key â†’ è²¼å…¥é†«å¸«è¨­å®š â†’ å•Ÿç”¨é›²ç«¯å„²å­˜
        </div>
      </div>
    </div>
  </div>
</div>

<div class="sec" id="s-calc">
<div class="si">
  <div class="ph">
    <div class="pt">è¨ˆç®—å·¥å…·</div>
    <div class="ps">å³æ™‚æ•¸å­¸é‹ç®— Â· é›¢ç·šå¯ç”¨ Â· ä¾æœ€æ–°é†«å­¸æŒ‡å¼•</div>
    <div class="ptags">
      <span class="tag tt">ADA 2026</span><span class="tag tb">KDIGO 2024</span><span class="tag ta">ACC/AHA 2022</span>
    </div>
  </div>
  <div class="ctabs">
    <button class="ctab on" onclick="showCalc('ckd')">â— CKD</button>
    <button class="ctab" onclick="showCalc('dm')">â—ˆ ç³–å°¿ç—…</button>
    <button class="ctab" onclick="showCalc('cv')">â—‡ å¿ƒè¡€ç®¡</button>
    <button class="ctab" onclick="showCalc('anemia')">â—‰ è²§è¡€</button>
    <button class="ctab" onclick="showCalc('liver')">â— è‚åŠŸèƒ½</button>
    <button class="ctab" onclick="showCalc('thyroid')">â—‘ ç”²ç‹€è…º</button>
    <button class="ctab" onclick="showCalc('bone')">â—« éª¨è³ª</button>
    <button class="ctab" onclick="showCalc('sens')">âŠ• éˆæ•åº¦</button>
  </div>

  <div class="cp on" id="cp-ckd">
    <div class="g2">
      <div class="card"><div class="ch">åŸºæœ¬è³‡æ–™</div>
        <div class="fg"><label class="fl">è¡€æ¸…è‚Œé…¸é… Creatinine *</label><div class="iu"><input type="number" step="0.01" class="fi" id="ckd_cr" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">å¹´é½¡ *</label><div class="iu"><input type="number" class="fi" id="ckd_age" placeholder="æ­²"><span class="uu">æ­²</span></div></div>
        <div class="fg"><label class="fl">æ€§åˆ¥</label><div class="fro"><label class="ro"><input type="radio" name="ckd_sex" value="female" checked> å¥³æ€§</label><label class="ro"><input type="radio" name="ckd_sex" value="male"> ç”·æ€§</label></div></div>
        <div class="fg"><label class="fl">Cystatin Cï¼ˆé¸å¡«ï¼‰</label><div class="iu"><input type="number" step="0.01" class="fi" id="ckd_cysc" placeholder="mg/Lï¼Œæé«˜ç²¾ç¢ºåº¦"><span class="uu">mg/L</span></div></div>
        <div class="fg"><label class="fl">UACR å°¿ç™½è›‹ç™½è‚Œé…¸é…æ¯”</label><div class="iu"><input type="number" class="fi" id="ckd_uacr" placeholder="mg/g"><span class="uu">mg/g</span></div></div>
        <div class="fg"><label class="fl">UPCR å°¿è›‹ç™½è‚Œé…¸é…æ¯”</label><div class="iu"><input type="number" class="fi" id="ckd_upcr" placeholder="mg/g"><span class="uu">mg/g</span></div></div>
      </div>
      <div class="card"><div class="ch">å…¶ä»–è…åŠŸèƒ½æŒ‡æ¨™</div>
        <div class="fg"><label class="fl">BUN å°¿ç´ æ°®</label><div class="iu"><input type="number" class="fi" id="ckd_bun" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">BUN/Cr æ¯”å€¼</label><input type="text" class="fi" id="ckd_buncr" readonly placeholder="è‡ªå‹•è¨ˆç®—" style="background:var(--c3);color:var(--sky);"></div>
        <div class="fg"><label class="fl">å°¿é…¸ Uric Acid</label><div class="iu"><input type="number" step="0.1" class="fi" id="ckd_ua" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">Potassium K+</label><div class="iu"><input type="number" step="0.1" class="fi" id="ckd_k" placeholder="mEq/L"><span class="uu">mEq/L</span></div></div>
        <div class="fg"><label class="fl">Sodium Na+</label><div class="iu"><input type="number" class="fi" id="ckd_na" placeholder="mEq/L"><span class="uu">mEq/L</span></div></div>
        <div class="fg"><label class="fl">å°¿è›‹ç™½è©¦ç´™</label><select class="fsel" id="ckd_dip"><option value="">æœªæª¢æ¸¬</option><option value="neg">é™°æ€§</option><option value="trace">å¾®é‡(Â±)</option><option value="1+">1+</option><option value="2+">2+</option><option value="3+">3+</option></select></div>
        <div class="fg"><label class="fl">ç³–å°¿ç—…</label><select class="fsel" id="ckd_dm"><option value="no">ç„¡</option><option value="yes">æœ‰</option></select></div>
        <div class="fg"><label class="fl">é«˜è¡€å£“</label><select class="fsel" id="ckd_htn"><option value="no">ç„¡</option><option value="yes">æœ‰</option></select></div>
      </div>
    </div>
    <div class="brow">
      <button class="btn bt" onclick="calcCKD()">â— è¨ˆç®— eGFR</button>
      <button class="btn bs" onclick="clr('ckd')">æ¸…é™¤</button>
    </div>
    <div class="rp" id="rp-ckd">
      <div class="rmain">
        <div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;color:var(--teal);text-transform:uppercase;">eGFR â€” CKD-EPI 2021 (race-free)</div>
        <div class="rbig" id="r-egfr">â€”</div>
        <div id="r-ckds" style="font-size:12px;color:var(--t2);"></div>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div class="ch">CKD åˆ†æœŸ</div>
        <div style="display:flex;gap:3px;">
          <div style="flex:1;height:9px;border-radius:3px;background:#16a34a;transition:.5s;" id="cs-g1"></div>
          <div style="flex:1;height:9px;border-radius:3px;background:#65a30d;opacity:.2;" id="cs-g2"></div>
          <div style="flex:1;height:9px;border-radius:3px;background:#ca8a04;opacity:.2;" id="cs-g3a"></div>
          <div style="flex:1;height:9px;border-radius:3px;background:#d97706;opacity:.2;" id="cs-g3b"></div>
          <div style="flex:1;height:9px;border-radius:3px;background:#ea580c;opacity:.2;" id="cs-g4"></div>
          <div style="flex:1;height:9px;border-radius:3px;background:#dc2626;opacity:.2;" id="cs-g5"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-family:var(--ff-m);font-size:8.5px;color:var(--t3);margin-top:4px;"><span>G1â‰¥90</span><span>G2 60</span><span>G3a 45</span><span>G3b 30</span><span>G4 15</span><span>G5</span></div>
      </div>
      <div class="rcells" id="ckd-cells"></div>
      <div id="ckd-alerts"></div>
      <div class="card" style="margin-bottom:12px;">
        <div class="ch">KDIGO é¢¨éšªçŸ©é™£</div>
        <table class="dt"><thead><tr><th>eGFRåˆ†æœŸ</th><th>A1 (&lt;30)</th><th>A2 (30-299)</th><th>A3 (â‰¥300)</th></tr></thead><tbody id="ckd-rmat"></tbody></table>
      </div>
      <div class="dis">CKD-EPI 2021 å·²ç§»é™¤ç¨®æ—ä¿‚æ•¸ã€‚CKD è¨ºæ–·éœ€æŒçºŒ â‰¥3 å€‹æœˆç•°å¸¸ã€‚AI å»ºè­°ç«‹å³å°±é†«ï¼šK+ &gt;6.0ã€eGFR å¿«é€Ÿä¸‹é™ &gt;5 mL/min/å¹´ã€UACR â‰¥300 åˆä½µç—‡ç‹€ã€‚</div>
    </div>
  </div>

  <div class="cp" id="cp-dm">
    <div class="g2">
      <div class="card"><div class="ch">è¡€ç³–æ•¸å€¼</div>
        <div class="fg"><label class="fl">ç©ºè…¹è¡€ç³– FPG</label><div class="iu"><input type="number" class="fi" id="dm_fpg" placeholder="æ­£å¸¸ &lt;100 mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">ç³–åŒ–è¡€è‰²ç´  HbA1c</label><div class="iu"><input type="number" step="0.1" class="fi" id="dm_hba1c" placeholder="æ­£å¸¸ &lt;5.7%"><span class="uu">%</span></div></div>
        <div class="fg"><label class="fl">é£¯å¾Œ2h OGTT</label><div class="iu"><input type="number" class="fi" id="dm_pp" placeholder="æ­£å¸¸ &lt;140"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">éš¨æ©Ÿè¡€ç³–</label><div class="iu"><input type="number" class="fi" id="dm_rg" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">CGM å¹³å‡è¡€ç³–ï¼ˆä¼°ç®—GMIï¼‰</label><div class="iu"><input type="number" class="fi" id="dm_cgm" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">èƒ°å³¶ç´  Insulinï¼ˆç©ºè…¹ï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="dm_ins" placeholder="Î¼IU/mL"><span class="uu">Î¼IU/mL</span></div></div>
        <div class="fg"><label class="fl">C-Peptideï¼ˆç©ºè…¹ï¼‰</label><div class="iu"><input type="number" step="0.01" class="fi" id="dm_cpep" placeholder="ng/mL"><span class="uu">ng/mL</span></div></div>
      </div>
      <div class="card"><div class="ch">è‡¨åºŠè³‡æ–™</div>
        <div class="fg"><label class="fl">å¹´é½¡</label><div class="iu"><input type="number" class="fi" id="dm_age" placeholder="æ­²"><span class="uu">æ­²</span></div></div>
        <div class="fg"><label class="fl">BMI</label><div class="iu"><input type="number" step="0.1" class="fi" id="dm_bmi" placeholder="kg/mÂ²"><span class="uu">kg/mÂ²</span></div></div>
        <div class="fg"><label class="fl">æœ‰ç—‡ç‹€ï¼ˆå¤šå–/å¤šå°¿/é«”é‡æ¸›è¼•ï¼‰</label><select class="fsel" id="dm_sx"><option value="no">ç„¡</option><option value="yes">æœ‰</option></select></div>
        <div class="fg"><label class="fl">å·²ç¢ºè¨ºé¡å‹</label><select class="fsel" id="dm_type"><option value="">æœªç¢ºè¨º</option><option value="type1">ç¬¬1å‹</option><option value="type2">ç¬¬2å‹</option><option value="gest">å¦Šå¨ ç³–å°¿ç—…</option></select></div>
        <div class="fg"><label class="fl">HbA1c æ²»ç™‚ç›®æ¨™</label><select class="fsel" id="dm_target"><option value="7">&lt;7%ï¼ˆä¸€èˆ¬ï¼‰</option><option value="6.5">&lt;6.5%ï¼ˆå¹´è¼•/ä½ä½è¡€ç³–é¢¨éšªï¼‰</option><option value="8">&lt;8%ï¼ˆè€å¹´/å¤šå…±ç—…ï¼‰</option></select></div>
        <div class="fg"><label class="fl">è…åŠŸèƒ½ï¼ˆeGFRï¼‰</label><div class="iu"><input type="number" class="fi" id="dm_egfr" placeholder="mL/minï¼ˆè—¥ç‰©èª¿æ•´ç”¨ï¼‰"><span class="uu">mL/min</span></div></div>
        <div class="fg"><label class="fl">HOMA-IR = FPGÃ—Insulin/405ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dm_homa" readonly placeholder="éœ€FPG+Insulin" style="background:var(--c3);color:var(--sky);"></div>
      </div>
    </div>
    <div class="brow">
      <button class="btn bt" onclick="calcDM()">â—ˆ è©•ä¼°ç³–å°¿ç—…ç‹€æ…‹</button>
      <button class="btn bs" onclick="clr('dm')">æ¸…é™¤</button>
    </div>
    <div class="rp" id="rp-dm">
      <div class="rmain" id="dm-main"></div>
      <div class="rcells" id="dm-cells"></div>
      <div id="dm-alerts"></div>
      <div class="card" style="margin-bottom:12px;">
        <div class="ch">ADA 2026 è¨ºæ–·æ¨™æº–</div>
        <table class="dt"><thead><tr><th>æŒ‡æ¨™</th><th>æ­£å¸¸</th><th>å‰æœŸç³–å°¿ç—…</th><th>ç³–å°¿ç—…è¨ºæ–·</th></tr></thead>
        <tbody>
          <tr><td>FPG</td><td class="ct">&lt;100</td><td class="ca">100â€“125</td><td class="cr">â‰¥126ï¼ˆéœ€è¤‡æŸ¥ï¼‰</td></tr>
          <tr><td>HbA1c</td><td class="ct">&lt;5.7%</td><td class="ca">5.7â€“6.4%</td><td class="cr">â‰¥6.5%</td></tr>
          <tr><td>2h OGTT</td><td class="ct">&lt;140</td><td class="ca">140â€“199</td><td class="cr">â‰¥200</td></tr>
          <tr><td>éš¨æ©Ÿ+ç—‡ç‹€</td><td>â€”</td><td>â€”</td><td class="cr">â‰¥200 mg/dL</td></tr>
        </tbody></table>
      </div>
      <div class="dis">ADA 2026ï¼šç„¡ç—‡ç‹€è€…éœ€å…©æ¬¡ç¨ç«‹ç•°å¸¸ç¢ºèªã€‚AI å»ºè­°ç«‹å³å°±é†«ï¼šFPG â‰¥200+ç—‡ç‹€ã€HbA1c â‰¥10%ã€é…®é…¸ä¸­æ¯’è·¡è±¡ã€‚</div>
    </div>
  </div>

  <div class="cp" id="cp-cv">
    <div class="g2">
      <div class="card"><div class="ch">åŸºæœ¬è³‡æ–™</div>
        <div class="fg"><label class="fl">å¹´é½¡ï¼ˆ40-79 æ­² PCE é©ç”¨ï¼‰</label><div class="iu"><input type="number" class="fi" id="cv_age" placeholder="æ­²"><span class="uu">æ­²</span></div></div>
        <div class="fg"><label class="fl">æ€§åˆ¥</label><div class="fro"><label class="ro"><input type="radio" name="cv_sex" value="male" checked> ç”·æ€§</label><label class="ro"><input type="radio" name="cv_sex" value="female"> å¥³æ€§</label></div></div>
        <div class="fg"><label class="fl">æ”¶ç¸®å£“ SBP</label><div class="iu"><input type="number" class="fi" id="cv_sbp" placeholder="mmHg"><span class="uu">mmHg</span></div></div>
        <div class="fg"><label class="fl">èˆ’å¼µå£“ DBP</label><div class="iu"><input type="number" class="fi" id="cv_dbp" placeholder="mmHg"><span class="uu">mmHg</span></div></div>
        <div class="fg"><label class="fl">Pulseå£“å·®</label><input type="text" class="fi" id="cv_pp" readonly placeholder="è‡ªå‹•" style="background:var(--c3);color:var(--sky);"></div>
        <div class="fg"><label class="fl">å¸è¸</label><select class="fsel" id="cv_smoke"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
        <div class="fg"><label class="fl">ç³–å°¿ç—…</label><select class="fsel" id="cv_dm"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
        <div class="fg"><label class="fl">é«˜è¡€å£“è—¥ç‰©</label><select class="fsel" id="cv_htntx"><option value="no">æœªæœç”¨</option><option value="yes">æœç”¨ä¸­</option></select></div>
      </div>
      <div class="card"><div class="ch">è¡€è„‚ &amp; èº«é«”æ¸¬é‡</div>
        <div class="fg"><label class="fl">ç¸½è†½å›ºé†‡ TC</label><div class="iu"><input type="number" class="fi" id="cv_tc" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">HDL</label><div class="iu"><input type="number" class="fi" id="cv_hdl" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">LDL</label><div class="iu"><input type="number" class="fi" id="cv_ldl" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">é HDL è†½å›ºé†‡ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="cv_nhdl" readonly placeholder="TC-HDL" style="background:var(--c3);color:var(--sky);"></div>
        <div class="fg"><label class="fl">TG ä¸‰é…¸ç”˜æ²¹é…¯</label><div class="iu"><input type="number" class="fi" id="cv_tg" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">è…°åœ</label><div class="iu"><input type="number" class="fi" id="cv_waist" placeholder="cm"><span class="uu">cm</span></div></div>
        <div class="fg"><label class="fl">hsCRPï¼ˆé¸å¡«ï¼‰</label><div class="iu"><input type="number" step="0.01" class="fi" id="cv_crp" placeholder="mg/L"><span class="uu">mg/L</span></div></div>
      </div>
    </div>
    <div class="brow">
      <button class="btn bt" onclick="calcCV()">â—‡ è¨ˆç®—å¿ƒè¡€ç®¡é¢¨éšª</button>
      <button class="btn bs" onclick="clr('cv')">æ¸…é™¤</button>
    </div>
    <div class="rp" id="rp-cv">
      <div class="rmain" id="cv-main"></div>
      <div class="rcells" id="cv-cells"></div>
      <div id="cv-ms"></div>
      <div id="cv-alerts"></div>
      <div class="dis">PCE é©ç”¨ 40-79 æ­²ç„¡å·²çŸ¥ ASCVD è€…ã€‚AI å»ºè­°ç«‹å³å°±é†«ï¼šLDL â‰¥190ï¼ˆè€ƒæ…®FHï¼‰ã€TG â‰¥500ï¼ˆèƒ°è‡Ÿç‚é¢¨éšªï¼‰ã€BP &gt;180/120ã€‚</div>
    </div>
  </div>

  <div class="cp" id="cp-anemia">
    <div class="g2">
      <div class="card"><div class="ch">è¡€æ¶²å¸¸è¦</div>
        <div class="fg"><label class="fl">è¡€è‰²ç´  Hemoglobin *</label><div class="iu"><input type="number" step="0.1" class="fi" id="an_hb" placeholder="g/dL"><span class="uu">g/dL</span></div></div>
        <div class="fg"><label class="fl">MCV</label><div class="iu"><input type="number" class="fi" id="an_mcv" placeholder="fL"><span class="uu">fL</span></div></div>
        <div class="fg"><label class="fl">MCH</label><div class="iu"><input type="number" step="0.1" class="fi" id="an_mch" placeholder="pg"><span class="uu">pg</span></div></div>
        <div class="fg"><label class="fl">MCHC</label><div class="iu"><input type="number" class="fi" id="an_mchc" placeholder="g/dL"><span class="uu">g/dL</span></div></div>
        <div class="fg"><label class="fl">RBC</label><div class="iu"><input type="number" step="0.01" class="fi" id="an_rbc" placeholder="Ã—10â¶/Î¼L"><span class="uu">M/Î¼L</span></div></div>
        <div class="fg"><label class="fl">RDW</label><div class="iu"><input type="number" step="0.1" class="fi" id="an_rdw" placeholder="%"><span class="uu">%</span></div></div>
        <div class="fg"><label class="fl">WBC</label><div class="iu"><input type="number" class="fi" id="an_wbc" placeholder="Ã—10Â³/Î¼L"><span class="uu">K/Î¼L</span></div></div>
        <div class="fg"><label class="fl">PLT</label><div class="iu"><input type="number" class="fi" id="an_plt" placeholder="Ã—10Â³/Î¼L"><span class="uu">K/Î¼L</span></div></div>
        <div class="fg"><label class="fl">Reticulocyte</label><div class="iu"><input type="number" step="0.01" class="fi" id="an_retic" placeholder="%"><span class="uu">%</span></div></div>
        <div class="fg"><label class="fl">æ€§åˆ¥</label><div class="fro"><label class="ro"><input type="radio" name="an_sex" value="male" checked> ç”·æ€§</label><label class="ro"><input type="radio" name="an_sex" value="female"> å¥³æ€§</label></div></div>
      </div>
      <div class="card"><div class="ch">éµä»£è¬ &amp; B12</div>
        <div class="fg"><label class="fl">è¡€æ¸…éµ Serum Iron</label><div class="iu"><input type="number" class="fi" id="an_si" placeholder="Î¼g/dL"><span class="uu">Î¼g/dL</span></div></div>
        <div class="fg"><label class="fl">TIBC</label><div class="iu"><input type="number" class="fi" id="an_tibc" placeholder="Î¼g/dL"><span class="uu">Î¼g/dL</span></div></div>
        <div class="fg"><label class="fl">Ferritin</label><div class="iu"><input type="number" class="fi" id="an_ferritin" placeholder="ng/mL"><span class="uu">ng/mL</span></div></div>
        <div class="fg"><label class="fl">Vitamin B12</label><div class="iu"><input type="number" class="fi" id="an_b12" placeholder="pg/mL"><span class="uu">pg/mL</span></div></div>
        <div class="fg"><label class="fl">è‘‰é…¸ Folate</label><div class="iu"><input type="number" step="0.1" class="fi" id="an_fol" placeholder="ng/mL"><span class="uu">ng/mL</span></div></div>
        <div class="fg"><label class="fl">LDH</label><div class="iu"><input type="number" class="fi" id="an_ldh" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
        <div class="fg"><label class="fl">Haptoglobin</label><div class="iu"><input type="number" class="fi" id="an_hap" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      </div>
    </div>
    <div class="brow"><button class="btn bt" onclick="calcAnemia()">â—‰ åˆ†æè²§è¡€</button><button class="btn bs" onclick="clr('anemia')">æ¸…é™¤</button></div>
    <div class="rp" id="rp-anemia">
      <div class="rmain" id="anemia-main"></div>
      <div class="rcells" id="anemia-cells"></div>
      <div id="anemia-alerts"></div>
      <div class="dis">AI å»ºè­°ç«‹å³å°±é†«ï¼šHb &lt;7ï¼ˆç—‡ç‹€æ€§é‡åº¦è²§è¡€ï¼‰ã€æ€¥æ€§æº¶è¡€ï¼ˆHaptoglobin æ¥µä½ã€LDH æ¥µé«˜ï¼‰ã€Ferritin &lt;10+ç—‡ç‹€ã€‚</div>
    </div>
  </div>

  <div class="cp" id="cp-liver">
    <div class="g2">
      <div class="card"><div class="ch">è‚é…µç´  &amp; åˆæˆ</div>
        <div class="fg"><label class="fl">AST (GOT)</label><div class="iu"><input type="number" class="fi" id="lv_ast" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
        <div class="fg"><label class="fl">ALT (GPT)</label><div class="iu"><input type="number" class="fi" id="lv_alt" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
        <div class="fg"><label class="fl">AST/ALT æ¯”ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="lv_ratio" readonly placeholder="è‡ªå‹•" style="background:var(--c3);color:var(--sky);"></div>
        <div class="fg"><label class="fl">GGT</label><div class="iu"><input type="number" class="fi" id="lv_ggt" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
        <div class="fg"><label class="fl">ALP</label><div class="iu"><input type="number" class="fi" id="lv_alp" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
        <div class="fg"><label class="fl">T-Bilirubin</label><div class="iu"><input type="number" step="0.01" class="fi" id="lv_bili" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">D-Bilirubinï¼ˆç›´æ¥ï¼‰</label><div class="iu"><input type="number" step="0.01" class="fi" id="lv_dbili" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">Albumin</label><div class="iu"><input type="number" step="0.1" class="fi" id="lv_alb" placeholder="g/dL"><span class="uu">g/dL</span></div></div>
        <div class="fg"><label class="fl">PT/INR</label><div class="iu"><input type="number" step="0.01" class="fi" id="lv_inr" placeholder="INR"><span class="uu">INR</span></div></div>
      </div>
      <div class="card"><div class="ch">å…¶ä»–æŒ‡æ¨™</div>
        <div class="fg"><label class="fl">è¡€å°æ¿ PLT</label><div class="iu"><input type="number" class="fi" id="lv_plt" placeholder="K/Î¼L"><span class="uu">K/Î¼L</span></div></div>
        <div class="fg"><label class="fl">å¹´é½¡</label><div class="iu"><input type="number" class="fi" id="lv_age" placeholder="æ­²"><span class="uu">æ­²</span></div></div>
        <div class="fg"><label class="fl">AFP</label><div class="iu"><input type="number" class="fi" id="lv_afp" placeholder="ng/mL"><span class="uu">ng/mL</span></div></div>
        <div class="fg"><label class="fl">TP ç¸½è›‹ç™½</label><div class="iu"><input type="number" step="0.1" class="fi" id="lv_tp" placeholder="g/dL"><span class="uu">g/dL</span></div></div>
        <div class="fg"><label class="fl">HBsAg</label><select class="fsel" id="lv_hbsag"><option value="neg">é™°æ€§</option><option value="pos">é™½æ€§</option></select></div>
        <div class="fg"><label class="fl">Anti-HCV</label><select class="fsel" id="lv_hcv"><option value="neg">é™°æ€§</option><option value="pos">é™½æ€§</option></select></div>
        <div class="fg"><label class="fl">è…¹æ°´</label><select class="fsel" id="lv_ascites"><option value="none">ç„¡</option><option value="mild">è¼•åº¦</option><option value="severe">é‡åº¦</option></select></div>
        <div class="fg"><label class="fl">è‚æ€§è…¦ç—…</label><select class="fsel" id="lv_he"><option value="none">ç„¡</option><option value="g12">Grade 1-2</option><option value="g34">Grade 3-4</option></select></div>
        <div class="fg"><label class="fl">BMI</label><div class="iu"><input type="number" step="0.1" class="fi" id="lv_bmi" placeholder="kg/mÂ²ï¼ˆMASLDç”¨ï¼‰"><span class="uu">kg/mÂ²</span></div></div>
      </div>
    </div>
    <div class="brow"><button class="btn bt" onclick="calcLiver()">â— è©•ä¼°è‚åŠŸèƒ½</button><button class="btn bs" onclick="clr('liver')">æ¸…é™¤</button></div>
    <div class="rp" id="rp-liver">
      <div class="rcells" id="liver-cells"></div>
      <div id="liver-alerts"></div>
      <div class="dis">AI å»ºè­°ç«‹å³å°±é†«ï¼šALT/AST &gt;400 æ€¥å‡ã€INR &gt;2.0+å‡ºè¡€ã€è‚æ€§è…¦ç—… G3-4ã€AFP &gt;200+HBsAg+ã€‚</div>
    </div>
  </div>

  <div class="cp" id="cp-thyroid">
    <div class="g2">
      <div class="card"><div class="ch">ç”²ç‹€è…ºåŠŸèƒ½</div>
        <div class="fg"><label class="fl">TSH *</label><div class="iu"><input type="number" step="0.01" class="fi" id="th_tsh" placeholder="æ­£å¸¸ 0.4-4.0 mIU/L"><span class="uu">mIU/L</span></div></div>
        <div class="fg"><label class="fl">Free T4</label><div class="iu"><input type="number" step="0.01" class="fi" id="th_ft4" placeholder="0.8-1.8 ng/dL"><span class="uu">ng/dL</span></div></div>
        <div class="fg"><label class="fl">Free T3</label><div class="iu"><input type="number" step="0.01" class="fi" id="th_ft3" placeholder="2.3-4.2 pg/mL"><span class="uu">pg/mL</span></div></div>
        <div class="fg"><label class="fl">Total T4</label><div class="iu"><input type="number" step="0.1" class="fi" id="th_t4" placeholder="5-12 Î¼g/dL"><span class="uu">Î¼g/dL</span></div></div>
        <div class="fg"><label class="fl">Anti-TPO</label><div class="iu"><input type="number" class="fi" id="th_tpo" placeholder="æ­£å¸¸ &lt;35 IU/mL"><span class="uu">IU/mL</span></div></div>
        <div class="fg"><label class="fl">Anti-Tg</label><div class="iu"><input type="number" class="fi" id="th_tg" placeholder="IU/mL"><span class="uu">IU/mL</span></div></div>
        <div class="fg"><label class="fl">TSH Receptor Abï¼ˆTRABï¼‰</label><div class="iu"><input type="number" step="0.01" class="fi" id="th_trab" placeholder="IU/L &lt;1.75"><span class="uu">IU/L</span></div></div>
        <div class="fg"><label class="fl">Calcitoninï¼ˆç”²ç‹€è…ºé«“æ¨£ç™Œï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="th_cal" placeholder="pg/mL"><span class="uu">pg/mL</span></div></div>
      </div>
      <div class="card"><div class="ch">è‡¨åºŠè³‡æ–™</div>
        <div class="fg"><label class="fl">å¹´é½¡</label><div class="iu"><input type="number" class="fi" id="th_age" placeholder="æ­²"><span class="uu">æ­²</span></div></div>
        <div class="fg"><label class="fl">å¦Šå¨ ç‹€æ…‹</label><select class="fsel" id="th_preg"><option value="no">éå¦Šå¨ </option><option value="t1">å¦Šå¨ åˆæœŸï¼ˆT1ï¼‰</option><option value="t2">å¦Šå¨ ä¸­æœŸï¼ˆT2ï¼‰</option><option value="t3">å¦Šå¨ æœ«æœŸï¼ˆT3ï¼‰</option></select></div>
        <div class="fg"><label class="fl">ç”²ç‹€è…ºè…«</label><select class="fsel" id="th_goiter"><option value="no">ç„¡</option><option value="diff">ç€°æ¼«æ€§</option><option value="nodule">çµç¯€æ€§</option></select></div>
        <div class="fg"><label class="fl">å¿ƒå¾‹ä¸æ•´</label><select class="fsel" id="th_afib"><option value="no">ç„¡</option><option value="yes">æœ‰</option></select></div>
        <div class="fg"><label class="fl">æ­£åœ¨æœç”¨ Levothyroxine</label><select class="fsel" id="th_levo"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
        <div class="fg"><label class="fl">Levothyroxine åŠ‘é‡</label><div class="iu"><input type="number" class="fi" id="th_dose" placeholder="Î¼g/å¤©"><span class="uu">Î¼g/d</span></div></div>
      </div>
    </div>
    <div class="brow"><button class="btn bt" onclick="calcThyroid()">â—‘ è©•ä¼°ç”²ç‹€è…º</button><button class="btn bs" onclick="clr('thyroid')">æ¸…é™¤</button></div>
    <div class="rp" id="rp-thyroid">
      <div class="rmain" id="thyroid-main"></div>
      <div class="rcells" id="thyroid-cells"></div>
      <div id="thyroid-alerts"></div>
      <div class="dis">AI å»ºè­°ç«‹å³å°±é†«ï¼šTSH &lt;0.01+FT4&gt;1.8ï¼ˆé¡¯æ€§ç”²äº¢ï¼‰ã€TSH &gt;10ï¼ˆç—‡ç‹€æ€§ç”²ä½ï¼‰ã€å¦Šå¨ ç”²ä½ï¼ˆå½±éŸ¿èƒå…’ç™¼è‚²ï¼‰ã€‚</div>
    </div>
  </div>

  <div class="cp" id="cp-bone">
    <div class="g2">
      <div class="card"><div class="ch">éª¨ç¤¦ç‰©è³ªä»£è¬</div>
        <div class="fg"><label class="fl">è¡€éˆ£ Calciumï¼ˆç¸½ï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="bn_ca" placeholder="8.5-10.5 mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">é›¢å­éˆ£ Ionized Caï¼ˆé¸å¡«ï¼‰</label><div class="iu"><input type="number" step="0.01" class="fi" id="bn_ica" placeholder="1.12-1.32 mmol/L"><span class="uu">mmol/L</span></div></div>
        <div class="fg"><label class="fl">ç™½è›‹ç™½æ ¡æ­£éˆ£ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="bn_cca" readonly placeholder="éœ€Ca+Albumin" style="background:var(--c3);color:var(--sky);"></div>
        <div class="fg"><label class="fl">ç£· Phosphorus</label><div class="iu"><input type="number" step="0.1" class="fi" id="bn_p" placeholder="2.5-4.5 mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">CaÃ—P ä¹˜ç©ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="bn_cap" readonly placeholder="éœ€Ca+P" style="background:var(--c3);color:var(--sky);"></div>
        <div class="fg"><label class="fl">PTH å‰¯ç”²ç‹€è…ºç´ </label><div class="iu"><input type="number" class="fi" id="bn_pth" placeholder="15-65 pg/mL"><span class="uu">pg/mL</span></div></div>
        <div class="fg"><label class="fl">Vitamin D (25-OH)</label><div class="iu"><input type="number" class="fi" id="bn_vitd" placeholder="ng/mL"><span class="uu">ng/mL</span></div></div>
        <div class="fg"><label class="fl">Magnesium Mg</label><div class="iu"><input type="number" step="0.1" class="fi" id="bn_mg" placeholder="1.7-2.2 mg/dL"><span class="uu">mg/dL</span></div></div>
        <div class="fg"><label class="fl">Alkaline Phosphatase ALP</label><div class="iu"><input type="number" class="fi" id="bn_alp" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
      </div>
      <div class="card"><div class="ch">è‡¨åºŠè³‡æ–™</div>
        <div class="fg"><label class="fl">eGFRï¼ˆè…åŠŸèƒ½ï¼‰</label><div class="iu"><input type="number" class="fi" id="bn_egfr" placeholder="mL/min"><span class="uu">mL/min</span></div></div>
        <div class="fg"><label class="fl">Albuminï¼ˆæ ¡æ­£éˆ£ç”¨ï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="bn_alb" placeholder="g/dL"><span class="uu">g/dL</span></div></div>
        <div class="fg"><label class="fl">è…è‡Ÿæ›¿ä»£ç™‚æ³•</label><select class="fsel" id="bn_rrt"><option value="no">å¦</option><option value="hd">è¡€æ¶²é€æ HD</option><option value="pd">è…¹è†œé€æ PD</option></select></div>
        <div class="fg"><label class="fl">éª¨å¯†åº¦ T-scoreï¼ˆDEXAï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="bn_tscore" placeholder="æ­£å¸¸ &gt;-1.0"><span class="uu">SD</span></div></div>
        <div class="fg"><label class="fl">éª¨æŠ˜ç—…å²</label><select class="fsel" id="bn_fx"><option value="no">ç„¡</option><option value="fragility">ä½è¡æ“Šéª¨æŠ˜</option><option value="hip">é«–éª¨éª¨æŠ˜</option></select></div>
      </div>
    </div>
    <div class="brow"><button class="btn bt" onclick="calcBone()">â—« è©•ä¼°éª¨ç¤¦ç‰©è³ª</button><button class="btn bs" onclick="clr('bone')">æ¸…é™¤</button></div>
    <div class="rp" id="rp-bone">
      <div class="rcells" id="bone-cells"></div>
      <div id="bone-alerts"></div>
      <div class="dis">KDIGO 2017ï¼šCKD G3b+ æ‚£è€…éœ€ç›£æ¸¬ Ca/P/PTH/Vit Dã€‚AI å»ºè­°ç«‹å³å°±é†«ï¼šæ ¡æ­£éˆ£ &gt;12 mg/dLï¼ˆé«˜éˆ£å±è±¡ï¼‰ã€æ ¡æ­£éˆ£ &lt;7ï¼ˆç—‡ç‹€æ€§ä½éˆ£ï¼‰ã€‚</div>
    </div>
  </div>

  <div class="cp" id="cp-sens">
    <div class="g2">
      <div class="card"><div class="ch">æ··æ·†çŸ©é™£è¼¸å…¥</div>
        <div class="al ai" style="margin-bottom:12px;">TPï¼çœŸé™½æ€§ Â· FPï¼å‡é™½æ€§ Â· FNï¼å‡é™°æ€§ Â· TNï¼çœŸé™°æ€§</div>
        <div class="g2">
          <div class="fg"><label class="fl" style="color:var(--teal);">TP çœŸé™½æ€§</label><input type="number" class="fi" id="s_tp" placeholder="0"></div>
          <div class="fg"><label class="fl" style="color:var(--amber);">FP å‡é™½æ€§</label><input type="number" class="fi" id="s_fp" placeholder="0"></div>
          <div class="fg"><label class="fl" style="color:var(--rose);">FN å‡é™°æ€§</label><input type="number" class="fi" id="s_fn" placeholder="0"></div>
          <div class="fg"><label class="fl" style="color:var(--sky);">TN çœŸé™°æ€§</label><input type="number" class="fi" id="s_tn" placeholder="0"></div>
        </div>
        <div class="fg"><label class="fl">ç››è¡Œç‡ï¼ˆè²æ°ä¿®æ­£ï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="s_prev" placeholder="%"><span class="uu">%</span></div></div>
      </div>
      <div class="card"><div class="ch">æˆ–ç›´æ¥è¼¸å…¥</div>
        <div class="fg"><label class="fl">éˆæ•åº¦ Se</label><div class="iu"><input type="number" step="0.1" class="fi" id="s_se" placeholder="%"><span class="uu">%</span></div></div>
        <div class="fg"><label class="fl">ç‰¹ç•°åº¦ Sp</label><div class="iu"><input type="number" step="0.1" class="fi" id="s_sp" placeholder="%"><span class="uu">%</span></div></div>
        <div class="hint">è¼¸å…¥TP/FP/FN/TN æˆ– Se/Spï¼Œæ“‡ä¸€ã€‚</div>
      </div>
    </div>
    <div class="brow"><button class="btn bt" onclick="calcSens()">âŠ• è¨ˆç®—è¨ºæ–·æ•ˆèƒ½</button><button class="btn bs" onclick="clr('sens')">æ¸…é™¤</button></div>
    <div class="rp" id="rp-sens">
      <div class="card" style="margin-bottom:12px;background:var(--c2);">
        <div class="ch">æ··æ·†çŸ©é™£</div>
        <div style="display:grid;grid-template-columns:auto 1fr 1fr;gap:2px;font-family:var(--ff-m);font-size:12px;">
          <div style="padding:9px;"></div>
          <div style="padding:9px;text-align:center;background:rgba(255,255,255,.04);border-radius:4px;font-size:9px;color:var(--t3);">é æ¸¬é™½æ€§</div>
          <div style="padding:9px;text-align:center;background:rgba(255,255,255,.04);border-radius:4px;font-size:9px;color:var(--t3);">é æ¸¬é™°æ€§</div>
          <div style="padding:9px;background:rgba(255,255,255,.04);border-radius:4px;font-size:9px;color:var(--t3);">å¯¦éš›é™½æ€§</div>
          <div style="padding:12px;text-align:center;background:rgba(0,201,167,.1);border-radius:4px;" id="cm-tp"><div style="font-size:20px;font-weight:700;color:var(--teal);">â€”</div><div style="font-size:8px;color:var(--t3);">TP</div></div>
          <div style="padding:12px;text-align:center;background:rgba(244,63,94,.08);border-radius:4px;" id="cm-fn"><div style="font-size:20px;font-weight:700;color:var(--rose);">â€”</div><div style="font-size:8px;color:var(--t3);">FN</div></div>
          <div style="padding:9px;background:rgba(255,255,255,.04);border-radius:4px;font-size:9px;color:var(--t3);">å¯¦éš›é™°æ€§</div>
          <div style="padding:12px;text-align:center;background:rgba(245,158,11,.08);border-radius:4px;" id="cm-fp"><div style="font-size:20px;font-weight:700;color:var(--amber);">â€”</div><div style="font-size:8px;color:var(--t3);">FP</div></div>
          <div style="padding:12px;text-align:center;background:rgba(56,189,248,.08);border-radius:4px;" id="cm-tn"><div style="font-size:20px;font-weight:700;color:var(--sky);">â€”</div><div style="font-size:8px;color:var(--t3);">TN</div></div>
        </div>
      </div>
      <div class="rcells" id="sens-cells" style="grid-template-columns:repeat(4,1fr);"></div>
    </div>
  </div>

</div></div><!-- /s-calc -->

<div class="sec" id="s-ai">
<div class="si">
  <div class="ph">
    <div class="pt">ğŸ¤– AI æª¢æ¸¬</div>
    <div class="ps">ç—‡ç‹€æ™ºèƒ½è©•ä¼° Â· Claude AI è¼”åŠ©åˆ†æ</div>
    <div class="ptags"><span class="tag tr">AI å»ºè­°åƒ…ä¾›åƒè€ƒ</span><span class="tag ta">éé†«ç™‚è¨ºæ–·</span></div>
  </div>

  <!-- DISCLAIMER -->
  <div style="background:rgba(244,63,94,.07);border:1px solid rgba(244,63,94,.2);border-radius:var(--r);padding:16px;margin-bottom:18px;">
    <div style="font-family:var(--ff-m);font-size:10px;letter-spacing:1.5px;color:var(--rose);text-transform:uppercase;margin-bottom:10px;">âš ï¸ å…è²¬è²æ˜ â€” è«‹è©³é–±å¾Œä½¿ç”¨</div>
    <div style="font-size:12.5px;color:var(--t2);line-height:1.85;">
      1. æœ¬å·¥å…·ç”±äººå·¥æ™ºèƒ½ï¼ˆClaude AIï¼‰æä¾›ç—‡ç‹€è©•ä¼°ï¼Œ<strong style="color:var(--t1);">æ‰€æœ‰çµæœå‡æ¨™ç¤ºã€ŒAI å»ºè­°ã€å­—æ¨£ï¼Œä¸æ§‹æˆæ­£å¼é†«ç™‚è¨ºæ–·</strong>ã€‚<br>
      2. AI è©•ä¼°çµæœ<strong style="color:var(--t1);">ä¸å¾—å–ä»£è‡¨åºŠé†«å¸«è¨ºæ–·</strong>ï¼Œäº¦ä¸å¾—ä½œç‚ºè™•æ–¹æˆ–æ²»ç™‚ä¾æ“šã€‚<br>
      3. è‹¥å‡ºç¾<strong style="color:#fda4af;">èƒ¸ç—›ã€å‘¼å¸å›°é›£ã€æ„è­˜æ”¹è®Šã€å¤§é‡å‡ºè¡€</strong>ç­‰ç·Šæ€¥ç—‡ç‹€ï¼Œè«‹<strong style="color:var(--rose);">ç«‹å³æ’¥æ‰“ 119 æˆ–å‰å¾€æ€¥è¨º</strong>ï¼Œå‹¿ä½¿ç”¨æœ¬å·¥å…·å»¶èª¤å°±é†«ã€‚<br>
      4. æœ¬å·¥å…·ä¸å„²å­˜ä»»ä½•å€‹äººå¥åº·è³‡è¨Šï¼Œæ‰€æœ‰å°è©±é€éæ‚¨çš„ API Key èˆ‡ Anthropic ä¼ºæœå™¨å‚³è¼¸ï¼Œè«‹å‹¿è¼¸å…¥å¯è­˜åˆ¥å€‹äººèº«ä»½çš„è³‡è¨Šã€‚<br>
      5. æœ¬å¹³å°ä¾å°ç£é†«ç™‚æ³•ç¬¬ 9 æ¢åŠå€‹äººè³‡æ–™ä¿è­·æ³•ï¼Œä¸æä¾›è¨ºç™‚è¡Œç‚ºï¼Œæœ¬ç¶²ç«™ä¸æ‰¿æ“”ä½¿ç”¨ AI å»ºè­°æ‰€ç”¢ç”Ÿä¹‹ä»»ä½•é†«ç™‚è²¬ä»»ã€‚
    </div>
    <div style="margin-top:12px;display:flex;align-items:center;gap:8px;">
      <input type="checkbox" id="dis_agree" style="accent-color:var(--teal);width:14px;height:14px;">
      <label for="dis_agree" style="font-size:12.5px;cursor:pointer;">æˆ‘å·²é–±è®€ä¸¦ç†è§£ä¸Šè¿°å…è²¬è²æ˜ï¼ŒåŒæ„ä½¿ç”¨ AI æª¢æ¸¬åŠŸèƒ½</label>
    </div>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div class="ch">API è¨­å®š Â· å¿…é ˆå®Œæˆæ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½</div>
    <div class="g2">
      <div class="fg">
        <label class="fl">Anthropic API Key</label>
        <input type="password" class="fi" id="ai_key" placeholder="sk-ant-..." oninput="onApiKeyChange()">
        <div class="hint">Key å„²å­˜æ–¼æœ¬æ©Ÿï¼Œä¸ä¸Šå‚³è‡³æœ¬å¹³å°ä¼ºæœå™¨ã€‚<a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--teal);margin-left:4px;">å–å¾— API Key â†’</a></div>
      </div>
      <div class="fg" style="align-self:end;">
        <div class="api-test-row">
          <button class="btn bs" onclick="saveKey()">ğŸ’¾ å„²å­˜ Key</button>
          <button class="btn bv" onclick="testAPIKey()">ğŸ”¬ æ¸¬è©¦é€£ç·š</button>
        </div>
        <div class="test-status" id="ai-test-status"></div>
        <div class="hint" style="margin-top:6px;">éœ€å…ˆã€Œæ¸¬è©¦æˆåŠŸã€æ‰æœƒè§£é–ä¸‹æ–¹å¡«å¯«æ¬„ä½ã€‚</div>
      </div>
    </div>
  </div>

  <!-- AI FIELDS LOCK CONTAINER -->
  <div id="ai-fields-container" class="ai-locked">
    <div class="lock-badge" id="ai-lock-badge">ğŸ”’ è«‹å…ˆè¨­å®šä¸¦æ¸¬è©¦ API Key æ‰èƒ½ä½¿ç”¨</div>

  <div class="card" style="margin-bottom:14px;">
    <div class="ch">åŸºæœ¬è³‡æ–™ï¼ˆé¸å¡«ï¼Œæå‡åˆ†æç²¾ç¢ºåº¦ï¼‰</div>
    <div class="g3">
      <div class="fg"><label class="fl">å¹´é½¡</label><div class="iu"><input type="number" class="fi" id="ai_age" placeholder="æ­²"><span class="uu">æ­²</span></div></div>
      <div class="fg"><label class="fl">æ€§åˆ¥</label><select class="fsel" id="ai_sex"><option value="">æœªå¡«</option><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></div>
      <div class="fg"><label class="fl">å·²çŸ¥ç–¾ç—…å²</label><input type="text" class="fi" id="ai_hx" placeholder="å¦‚ï¼šé«˜è¡€å£“ã€ç³–å°¿ç—…..."></div>
      <div class="fg"><label class="fl">ç›®å‰ç”¨è—¥</label><input type="text" class="fi" id="ai_med" placeholder="å¦‚ï¼šMetformin, Aspirin..."></div>
      <div class="fg"><label class="fl">éæ•å²</label><input type="text" class="fi" id="ai_allergy" placeholder="è—¥ç‰©/é£Ÿç‰©éæ•..."></div>
    </div>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div class="ch">ä¸»è¦ç—‡ç‹€ï¼ˆå¯è¤‡é¸ï¼‰</div>
    <div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1px;color:var(--rose);margin-bottom:8px;">âš ï¸ ç·Šæ€¥ç—‡ç‹€ï¼ˆç´…è‰²ï¼‰â€” å‡ºç¾æ™‚è«‹ç›´æ¥å°±é†«</div>
    <div class="sym-g" id="sym-tags"></div>
    <div class="fg" style="margin-top:12px;"><label class="fl">ç—‡ç‹€æŒçºŒæ™‚é–“</label><select class="fsel" id="ai_dur"><option value="">æœªå¡«</option><option value="æ•¸å°æ™‚">æ•¸å°æ™‚å…§</option><option value="1-3å¤©">1-3å¤©</option><option value="ç´„1é€±">ç´„1é€±</option><option value="2-4é€±">2-4é€±</option><option value="è¶…é1å€‹æœˆ">è¶…é1å€‹æœˆ</option><option value="è¶…é3å€‹æœˆ">è¶…é3å€‹æœˆ</option></select></div>
    <div class="fg"><label class="fl">åš´é‡ç¨‹åº¦ï¼ˆè‡ªè©• 1-10ï¼‰</label><input type="range" min="1" max="10" value="5" class="fi" id="ai_sev" style="padding:5px;accent-color:var(--teal);" oninput="document.getElementById('ai_sevv').textContent=this.value"> <span id="ai_sevv" style="font-family:var(--ff-m);color:var(--teal);">5</span></div>
    <div class="fg"><label class="fl">è£œå……èªªæ˜ï¼ˆç—‡ç‹€ç‰¹å¾µã€è§¸ç™¼å› ç´ ç­‰ï¼‰</label><textarea class="fi" id="ai_note" rows="3" placeholder="å¦‚ï¼šé£¯å¾ŒåŠ é‡ã€é‹å‹•æ™‚ç™¼ä½œã€ä¼´éš¨ç™¼ç‡’38.5Â°C..." style="font-family:var(--ff-b);font-size:13px;"></textarea></div>
    <div class="brow">
      <button class="btn bt" onclick="runAI()">ğŸ¤– AI è©•ä¼°ç—‡ç‹€</button>
      <button class="btn bs" onclick="clearAI()">æ¸…é™¤</button>
    </div>
  </div>

  </div><!-- /ai-fields-container -->

  <div class="rp" id="rp-ai">
    <div class="rmain" id="ai-main"></div>
    <div class="rcells" id="ai-cells"></div>
    <div id="ai-detail"></div>
    <div class="dis">âš ï¸ æ‰€æœ‰ AI è©•ä¼°çµæœæ¨™ç¤ºã€ŒAI å»ºè­°ã€å­—æ¨£ï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¸æ›¿ä»£é†«å¸«è¨ºæ–·ã€‚ç·Šæ€¥æƒ…æ³è«‹ç›´æ¥æ’¥æ‰“ 119ã€‚æœ¬æ¬¡è©•ä¼°å…§å®¹ä¸å„²å­˜æ–¼ä»»ä½•ä¼ºæœå™¨ã€‚</div>
  </div>
</div>
</div><!-- /s-ai -->

<div class="sec" id="s-dr">
<div class="si">
  <div class="ph" style="border-color:rgba(167,139,250,.2);">
    <div style="display:flex;align-items:center;gap:10px;">
      <span class="dpulse"></span>
      <div class="pt" style="color:var(--violet);">é†«å¸«å°ˆå€</div>
    </div>
    <div class="ps">ä¾›é†«ç™‚äººå“¡è¼¸å…¥å—æª¢è€…å¥åº·æª¢æŸ¥è³‡æ–™ Â· ä¸€éµåˆ¤è®€å¥ä¿æ”¶æ¡ˆè³‡æ ¼ Â· æ”¯æ´è³‡æ–™åº«å„²å­˜</div>
    <div class="ptags">
      <span class="tag tv">ä»£è¬ç—‡å€™ç¾¤é˜²æ²»</span>
      <span class="tag tb">Early CKD æ”¶æ¡ˆ</span>
      <span class="tag ta">é™è¡€è„‚å¥ä¿æ¢ä»¶</span>
      <span class="tag" style="background:rgba(167,139,250,.1);color:var(--violet);border:1px solid rgba(167,139,250,.2);">AI é†«å¸«ç¸½è©•</span>
    </div>
  </div>

  <!-- DB & API CONFIG -->
  <div class="card" style="margin-bottom:14px;border-color:rgba(167,139,250,.15);">
    <div class="ch" style="color:var(--violet);">âš™ï¸ ç³»çµ±è¨­å®š <span id="provider-badge-dr"></span></div>
    <div class="dbtabs">
      <button class="dbtab on" onclick="showDRTab('api')">ğŸ¤– AI æä¾›å•†</button>
      <button class="dbtab" onclick="showDRTab('supabase')">ğŸ—„ï¸ Supabase</button>
      <button class="dbtab" onclick="showDRTab('privacy')">ğŸ”’ éš±ç§è¨­å®š</button>
    </div>

    <!-- â”€â”€ AI Provider Tab â”€â”€ -->
    <div class="dbp on" id="drt-api">
      <!-- Provider Selector -->
      <div class="card" style="margin-bottom:14px;">
        <div class="ch">é¸æ“‡ AI æä¾›å•†</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;">
          <div class="provider-card" id="pc-claude" onclick="selectProvider('claude')">
            <div class="pc-icon">ğŸ¤–</div>
            <div class="pc-name">Claude</div>
            <div class="pc-sub">Anthropic</div>
            <div class="pc-model">Haiku / Sonnet</div>
          </div>
          <div class="provider-card" id="pc-openai" onclick="selectProvider('openai')">
            <div class="pc-icon">âš¡</div>
            <div class="pc-name">GPT</div>
            <div class="pc-sub">OpenAI</div>
            <div class="pc-model">4o-mini / 4o</div>
          </div>
          <div class="provider-card" id="pc-gemini" onclick="selectProvider('gemini')">
            <div class="pc-icon">âœ¨</div>
            <div class="pc-name">Gemini</div>
            <div class="pc-sub">Google AI Studio</div>
            <div class="pc-model">1.5 Flashï¼ˆå…è²»ï¼‰</div>
          </div>
          <div class="provider-card" id="pc-supabase" onclick="selectProvider('supabase')">
            <div class="pc-icon">ğŸ—„ï¸</div>
            <div class="pc-name">Supabase AI</div>
            <div class="pc-sub">å…è²» Edge Function</div>
            <div class="pc-model">Groq / llama3</div>
          </div>
        </div>

        <!-- Dynamic key fields per provider -->
        <div id="provider-fields"><!-- rendered by renderProviderFields() --></div>

        <div class="brow" style="margin-top:12px;">
          <button class="btn bt" onclick="testCurrentProvider()">ğŸ”¬ æ¸¬è©¦é€£ç·š</button>
          <button class="btn bs" onclick="saveAllProviderSettings()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
        </div>
        <div id="provider-test-status" style="margin-top:8px;"></div>
      </div>

      <!-- Legacy fields (keep for compatibility) -->
      <div class="fg" style="display:none;"><input type="password" id="dr_api" value=""></div>

      <div class="fg">
        <label class="fl">é†«å¸«è­˜åˆ¥ï¼ˆç”¨æ–¼è¨˜éŒ„ï¼Œä¸å°å¤–é¡¯ç¤ºï¼‰</label>
        <input type="text" class="fi" id="dr_docid" placeholder="å¦‚ï¼šDr-A01ï¼ˆå‹¿ä½¿ç”¨çœŸå¯¦å§“åï¼‰">
        <div class="hint">âš ï¸ ä¾å€‹è³‡æ³•ï¼šè«‹ä½¿ç”¨åŒ¿åä»£è™Ÿï¼Œä¸å»ºè­°å¡«å…¥çœŸå¯¦å§“åã€‚</div>
      </div>
    </div>
    <div class="dbp" id="drt-supabase">
      <div class="al ai" style="margin-bottom:16px;">ğŸ—„ï¸ Supabase ç‚ºå…è²»é–‹æºå¾Œç«¯æœå‹™ï¼ˆPostgreSQLï¼‰ã€‚é€£ç·šå¾Œï¼Œå—æª¢è€…è³‡æ–™ç›´æ¥å­˜æ–¼<strong>æ‚¨è‡ªå·±çš„è³‡æ–™åº«</strong>ï¼Œæœ¬å¹³å°å®Œå…¨ä¸å­˜å–ã€‚</div>

      <!-- STEP BY STEP GUIDE -->
      <div style="margin-bottom:20px;">
        <div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:14px;">ğŸ“– é€£ç·šæ•™å­¸ï¼ˆ5åˆ†é˜å®Œæˆï¼‰</div>

        <div class="sb-step">
          <div class="sb-step-num">1</div>
          <div class="sb-step-t">å»ºç«‹ Supabase å¸³è™Ÿèˆ‡å°ˆæ¡ˆ</div>
          <div class="sb-step-d">å‰å¾€ <a href="https://supabase.com" target="_blank" style="color:var(--teal);">supabase.com</a> å…è²»è¨»å†Šã€‚é»é¸ã€ŒNew projectã€ï¼Œå¡«å…¥å°ˆæ¡ˆåç¨±ï¼ˆå¦‚ clincalcï¼‰ã€è³‡æ–™åº«å¯†ç¢¼ï¼ˆè«‹å¦¥å–„ä¿å­˜ï¼‰ï¼Œé¸æ“‡äºå¤ªä¼ºæœå™¨ï¼ˆå¦‚ Singaporeï¼‰ã€‚ç­‰å¾…ç´„ 1-2 åˆ†é˜å»ºç«‹å®Œæˆã€‚</div>
        </div>

        <div class="sb-step">
          <div class="sb-step-num">2</div>
          <div class="sb-step-t">å»ºç«‹è³‡æ–™è¡¨ï¼ˆSQL Editorï¼‰</div>
          <div class="sb-step-d">åœ¨å·¦å´é¸å–®é»é¸ã€ŒSQL Editorã€â†’ã€ŒNew queryã€ï¼Œè²¼å…¥ä¸‹æ–¹ SQL ä¸¦åŸ·è¡Œï¼š</div>
          <button class="sb-copy-btn" onclick="copySql()">è¤‡è£½ SQL</button>
          <div class="sb-code" id="sql-block">-- å»ºç«‹å—æª¢è€…è³‡æ–™è¡¨
CREATE TABLE patients (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  doctor_id text NOT NULL,
  pid text NOT NULL,
  exam_date text,
  sex text,
  age integer,
  data jsonb,
  qualify_result jsonb,
  ai_summary jsonb,
  notes text
);

-- å»ºç«‹ç´¢å¼•åŠ é€ŸæŸ¥è©¢
CREATE INDEX ON patients (pid);
CREATE INDEX ON patients (doctor_id);
CREATE INDEX ON patients (exam_date);

-- å•Ÿç”¨ Row Level Security
ALTER TABLE patients ENABLE ROW LEVEL SECURITY;

-- å»ºç«‹å­˜å–æ”¿ç­–ï¼ˆanon key å¯è®€å¯«ï¼‰
CREATE POLICY "allow_all" ON patients FOR ALL USING (true);</div>
          <div class="sb-step-d" style="margin-top:8px;">é»é¸ã€ŒRunã€åŸ·è¡Œï¼Œå‡ºç¾ã€ŒSuccessã€å³å®Œæˆã€‚</div>
        </div>

        <div class="sb-step">
          <div class="sb-step-num">3</div>
          <div class="sb-step-t">å–å¾— API é€£ç·šè³‡è¨Š</div>
          <div class="sb-step-d">åœ¨ Supabase å´æ¬„é»é¸ã€ŒSettingsã€â†’ã€ŒAPIã€ï¼š
            <br>â€¢ <strong style="color:var(--t1);">Project URL</strong>ï¼šè¤‡è£½ã€ŒProject URLã€ï¼ˆæ ¼å¼ï¼šhttps://xxxxx.supabase.coï¼‰
            <br>â€¢ <strong style="color:var(--t1);">Anon Key</strong>ï¼šè¤‡è£½ã€ŒProject API keysã€â†’ã€Œanon publicã€
            <br>âš ï¸ è«‹å‹¿å°‡ service_role key è²¼å…¥ï¼ˆæœ‰å®Œå…¨ç®¡ç†æ¬Šé™ï¼Œè«‹å¦¥å–„ä¿ç®¡ï¼‰
          </div>
        </div>

        <div class="sb-step">
          <div class="sb-step-num">4</div>
          <div class="sb-step-t">å¡«å…¥é€£ç·šè³‡è¨Šä¸¦æ¸¬è©¦</div>
          <div class="sb-step-d">å°‡ URL å’Œ Key è²¼å…¥ä¸‹æ–¹æ¬„ä½ï¼Œé»é¸ã€Œå„²å­˜ã€å¾Œé»é¸ã€Œæ¸¬è©¦é€£ç·šã€ï¼Œå‡ºç¾ç¶ è‰²æˆåŠŸè¨Šæ¯å³å®Œæˆã€‚</div>
        </div>
      </div>

      <!-- CONNECTION FORM -->
      <div class="card" style="margin-bottom:12px;">
        <div class="ch">é€£ç·šè¨­å®š</div>
        <div class="g2">
          <div class="fg"><label class="fl">Supabase Project URL</label><input type="text" class="fi" id="sb_url" placeholder="https://xxxx.supabase.co"></div>
          <div class="fg"><label class="fl">Supabase Anon Keyï¼ˆanon publicï¼‰</label><input type="password" class="fi" id="sb_key" placeholder="eyJhbGciOiJIUzI1NiIs..."><div class="hint">anon key ç‚ºå‰ç«¯å®‰å…¨ keyï¼Œä¸å…·ç®¡ç†å“¡æ¬Šé™ã€‚</div></div>
        </div>
        <div class="brow">
          <button class="btn bs" onclick="saveSB()">ğŸ’¾ å„²å­˜è¨­å®š</button>
          <button class="btn bt" onclick="testSB()">ğŸ”Œ æ¸¬è©¦é€£ç·š</button>
        </div>
        <div id="sb-status" style="margin-top:10px;"></div>
      </div>

      <div class="al ad">
        <strong>å¸¸è¦‹å•é¡Œ</strong><br>
        â“ <em>ã€Œé€£ç·šå¤±æ•— 404ã€</em>ï¼šè³‡æ–™è¡¨å°šæœªå»ºç«‹ï¼Œè«‹å…ˆåŸ·è¡Œæ­¥é©Ÿ 2 çš„ SQLã€‚<br>
        â“ <em>ã€ŒCORS éŒ¯èª¤ã€</em>ï¼šè«‹ç¢ºèª Project URL æ ¼å¼æ­£ç¢ºï¼Œä¸å«å°¾å·´æ–œç·šã€‚<br>
        â“ <em>ã€Œ401 Unauthorizedã€</em>ï¼šè«‹ç¢ºèªè²¼å…¥çš„æ˜¯ anon keyï¼Œè€Œé service_role keyã€‚<br>
        â“ è³‡æ–™å®‰å…¨ï¼šSupabase æä¾› Row Level Securityï¼ˆRLSï¼‰ï¼Œå¯é€²ä¸€æ­¥è¨­å®šåªæœ‰ç‰¹å®šé†«å¸«èƒ½å­˜å–è‡ªå·±çš„è³‡æ–™ã€‚
      </div>
    </div>

    <!-- â”€â”€ Privacy / De-ID / Retention Tab â”€â”€ -->
    <div class="dbp" id="drt-privacy">
      <!-- De-identification Info -->
      <div class="al ag" style="margin-bottom:16px;">
        ğŸ”’ <strong>å»è­˜åˆ¥åŒ–æ¨¡å¼å·²å•Ÿç”¨</strong>ï¼šç³»çµ±è‡ªå‹•ç§»é™¤æ‰€æœ‰å¯è­˜åˆ¥å€‹äººèº«ä»½çš„æ¬„ä½ï¼ˆå§“åã€èº«åˆ†è­‰è™Ÿã€é›»è©±ã€åœ°å€ç­‰ï¼‰ï¼Œåƒ…ä¿ç•™å¿…è¦çš„æ•¸å€¼èˆ‡æª¢é©—çµæœã€‚
      </div>

      <div class="card" style="margin-bottom:14px;">
        <div class="ch">ğŸš« ç¦æ­¢å„²å­˜çš„æ¬„ä½</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;">
          <div class="deid-block-tag">å§“å / å…¨å</div>
          <div class="deid-block-tag">èº«åˆ†è­‰å­—è™Ÿ</div>
          <div class="deid-block-tag">æ‰‹æ©Ÿ / é›»è©±</div>
          <div class="deid-block-tag">å±…ä½åœ°å€</div>
          <div class="deid-block-tag">é›»å­ä¿¡ç®±</div>
          <div class="deid-block-tag">å®Œæ•´å‡ºç”Ÿæ—¥æœŸ</div>
          <div class="deid-block-tag">LINE ID / SNS</div>
          <div class="deid-block-tag">è­·ç…§è™Ÿç¢¼</div>
          <div class="deid-block-tag">å¥ä¿å¡è™Ÿ</div>
        </div>
        <div style="font-size:12px;color:var(--t2);">âœ… å…è¨±å„²å­˜ï¼šåŒ¿åç—…æ‚£ç·¨è™Ÿï¼ˆå‡ååŒ–ï¼‰ã€å¹´é½¡ï¼ˆå€é–“ï¼‰ã€æ•¸å€¼æª¢é©—çµæœã€æ—¥æœŸï¼ˆå¹´æœˆï¼‰ã€è¨ºæ–·ç¢¼ï¼ˆICD-10ï¼‰</div>
      </div>

      <div class="card" style="margin-bottom:14px;">
        <div class="ch">ğŸ—‘ï¸ è³‡æ–™ä¿ç•™æœŸé™è¨­å®š</div>
        <div class="g2" style="margin-bottom:12px;">
          <div class="fg">
            <label class="fl">è³‡æ–™ä¿ç•™å¤©æ•¸</label>
            <div class="iu">
              <input type="number" class="fi" id="retention_days" min="30" max="3650" placeholder="365"
                oninput="updateRetentionPreview()" style="padding-right:36px;">
              <span class="uu">å¤©</span>
            </div>
            <div class="hint">æœ€çŸ­ 30 å¤©ï¼Œæœ€é•· 10 å¹´ï¼ˆ3650 å¤©ï¼‰ã€‚ä¾å°ç£é†«ç™‚æ³•è¦ï¼Œç—…æ­·ä¿å­˜è‡³å°‘ 7 å¹´ã€‚</div>
          </div>
          <div class="fg">
            <label class="fl">åˆ°æœŸå¾Œå‹•ä½œ</label>
            <select class="fsel" id="retention_action" onchange="updateRetentionPreview()">
              <option value="auto_delete">è‡ªå‹•åˆªé™¤ï¼ˆæ¨è–¦ï¼‰</option>
              <option value="notify">åˆ°æœŸæé†’ï¼Œä¸è‡ªå‹•åˆªé™¤</option>
              <option value="archive">å°å­˜ï¼ˆæ¨™è¨˜ç‚ºéæœŸï¼Œä¸åˆªé™¤ï¼‰</option>
            </select>
            <div class="hint">è‡ªå‹•åˆªé™¤åƒ…å½±éŸ¿æœ¬æ©Ÿæš«å­˜ã€‚Supabase è³‡æ–™éœ€è¨­å®š pg_cron æˆ–æ‰‹å‹•åŸ·è¡Œ SQLã€‚</div>
          </div>
        </div>
        <div id="retention-preview" class="al ai" style="margin-bottom:12px;"></div>
        <div class="brow">
          <button class="btn bt" onclick="saveRetentionSettings()">ğŸ’¾ å„²å­˜ä¿ç•™è¨­å®š</button>
          <button class="btn bs" onclick="runLocalPurge()">ğŸ§¹ ç«‹å³æ¸…ç†éæœŸæœ¬æ©Ÿè¨˜éŒ„</button>
          <button class="btn bv" onclick="showRetentionSQL()">ğŸ“‹ Supabase æ¸…ç† SQL</button>
        </div>
        <div id="retention-purge-result" style="margin-top:8px;"></div>
      </div>

      <div class="card" style="margin-bottom:14px;">
        <div class="ch">ğŸ” è³‡æ–™ç¨½æ ¸å·¥å…·</div>
        <div style="font-size:12.5px;color:var(--t2);margin-bottom:12px;">
          åœ¨å„²å­˜å‰ï¼Œç³»çµ±æœƒè‡ªå‹•æƒæè³‡æ–™æ˜¯å¦åŒ…å«æ½›åœ¨çš„å€‹äººè­˜åˆ¥è³‡è¨Šï¼ˆPIIï¼‰ã€‚
          æ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•è²¼å…¥ JSON é€²è¡Œç¨½æ ¸ã€‚
        </div>
        <textarea class="fi" id="audit_input" rows="4" placeholder='è²¼å…¥å—æª¢è€…è³‡æ–™ JSON é€²è¡Œå»è­˜åˆ¥åŒ–ç¨½æ ¸...' style="font-family:var(--ff-m);font-size:11px;margin-bottom:8px;"></textarea>
        <div class="brow">
          <button class="btn bt" onclick="runDeIDPreview()">ğŸ” é è¦½å»è­˜åˆ¥åŒ–çµæœ</button>
          <button class="btn bs" onclick="document.getElementById('audit_input').value=JSON.stringify(getDRData(),null,2)">å¡«å…¥ç›®å‰å¥æª¢è³‡æ–™</button>
        </div>
        <div id="deid-preview-result" style="margin-top:12px;"></div>
      </div>

      <!-- Supabase AI (Free) Section -->
      <div class="card">
        <div class="ch">ğŸ—„ï¸ Supabase AI å…è²»åˆ†æï¼ˆEdge Function + Groqï¼‰</div>
        <div class="al ai" style="margin-bottom:12px;">
          Supabase Edge Function + Groq API å¯æä¾›<strong>å®Œå…¨å…è²»</strong>çš„ AI åˆ†æã€‚Groq å…è²»æ–¹æ¡ˆæ¯å¤© 14,400 æ¬¡è«‹æ±‚ï¼Œæ”¯æ´ Llama 3.1 8B æ¨¡å‹ã€‚
        </div>
        <div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:12px;">éƒ¨ç½²æ­¥é©Ÿ</div>

        <div class="sb-step">
          <div class="sb-step-num">1</div>
          <div class="sb-step-t">ç”³è«‹ Groq å…è²» API Key</div>
          <div class="sb-step-d">å‰å¾€ <a href="https://console.groq.com/keys" target="_blank" style="color:var(--teal);">console.groq.com/keys</a> å…è²»ç”³è«‹ï¼ˆä¸éœ€ä¿¡ç”¨å¡ï¼‰ã€‚Groq ä½¿ç”¨ç¡¬é«”åŠ é€Ÿï¼ŒLlama 3.1 é€Ÿåº¦æ¥µå¿«ã€‚</div>
        </div>

        <div class="sb-step">
          <div class="sb-step-num">2</div>
          <div class="sb-step-t">åœ¨ Supabase è¨­å®šå¯†é‘°</div>
          <div class="sb-step-d">Supabase å¾Œå° â†’ Settings â†’ Edge Functions â†’ æ–°å¢ Secretï¼šåç¨± <code style="font-family:var(--ff-m);font-size:10px;background:var(--c0);padding:2px 5px;border-radius:3px;">GROQ_API_KEY</code>ï¼Œå€¼ç‚ºæ‚¨çš„ Groq keyã€‚</div>
        </div>

        <div class="sb-step">
          <div class="sb-step-num">3</div>
          <div class="sb-step-t">éƒ¨ç½² Edge Functionï¼ˆè¤‡è£½ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼‰</div>
          <div class="sb-step-d">å®‰è£ Supabase CLIï¼š<code style="font-family:var(--ff-m);font-size:10px;background:var(--c0);padding:2px 5px;border-radius:3px;">npm install -g supabase</code>ï¼Œç„¶å¾ŒåŸ·è¡Œ <code style="font-family:var(--ff-m);font-size:10px;background:var(--c0);padding:2px 5px;border-radius:3px;">supabase functions deploy ai-analyze</code></div>
          <button class="sb-copy-btn" onclick="copyEdgeFunction()">è¤‡è£½ç¨‹å¼ç¢¼</button>
          <div id="edge-fn-code" style="font-family:var(--ff-m);font-size:10px;color:#a5f3fc;background:var(--c0);border:1px solid var(--bd);border-radius:6px;padding:12px;margin:8px 0;overflow-x:auto;white-space:pre;line-height:1.65;"></div>
        </div>

        <div class="sb-step">
          <div class="sb-step-num">4</div>
          <div class="sb-step-t">æ¸¬è©¦ Supabase AI é€£ç·š</div>
          <div class="sb-step-d">ç¢ºèª Supabase é€£ç·šå·²è¨­å®šå¾Œï¼Œé»é¸ä¸‹æ–¹æ¸¬è©¦æŒ‰éˆ•ã€‚</div>
        </div>

        <div class="brow" style="margin-top:12px;">
          <button class="btn bg-s" onclick="testSupabaseAI()">ğŸ”¬ æ¸¬è©¦ Supabase AI</button>
          <button class="btn bv" onclick="selectProvider('supabase')">âœ“ åˆ‡æ›åˆ° Supabase AI æ¨¡å¼</button>
        </div>
        <div id="supabase-ai-status" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- PATIENT INFO -->
  <div class="drblock">
    <div class="drbt">ğŸ“‹ å—æª¢è€…åŸºæœ¬è³‡æ–™</div>
    <!-- æ—¥æœŸè¼¸å…¥æ¨¡å¼åˆ‡æ› -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <span style="font-size:11.5px;color:var(--t2);font-weight:500;">å‡ºç”Ÿæ—¥æœŸè¼¸å…¥æ–¹å¼ï¼š</span>
      <label class="ro"><input type="radio" name="dob_mode" value="picker" checked onchange="toggleDobMode('picker')"> å¹´æœˆæ—¥é¸æ“‡</label>
      <label class="ro"><input type="radio" name="dob_mode" value="text" onchange="toggleDobMode('text')"> ç›´æ¥è¼¸å…¥è¥¿å…ƒå¹´</label>
    </div>
    <!-- æ¨¡å¼Aï¼šå¹´æœˆæ—¥é¸æ“‡å™¨ -->
    <div id="dob-picker-mode">
      <div class="g5" style="margin-bottom:10px;">
        <div class="fg"><label class="fl">å—æª¢è€…ç·¨è™Ÿ *</label><input type="text" class="fi" id="dr_pid" placeholder="å¦‚ï¼š20240001"></div>
        <div class="fg"><label class="fl">å‡ºç”Ÿå¹´ï¼ˆè¥¿å…ƒï¼‰</label>
          <select class="fsel" id="dob_y" onchange="calcAgeFromPicker()">
<option value="">å¹´</option>
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
            <option value="2012">2012</option>
            <option value="2011">2011</option>
            <option value="2010">2010</option>
            <option value="2009">2009</option>
            <option value="2008">2008</option>
            <option value="2007">2007</option>
            <option value="2006">2006</option>
            <option value="2005">2005</option>
            <option value="2004">2004</option>
            <option value="2003">2003</option>
            <option value="2002">2002</option>
            <option value="2001">2001</option>
            <option value="2000">2000</option>
            <option value="1999">1999</option>
            <option value="1998">1998</option>
            <option value="1997">1997</option>
            <option value="1996">1996</option>
            <option value="1995">1995</option>
            <option value="1994">1994</option>
            <option value="1993">1993</option>
            <option value="1992">1992</option>
            <option value="1991">1991</option>
            <option value="1990">1990</option>
            <option value="1989">1989</option>
            <option value="1988">1988</option>
            <option value="1987">1987</option>
            <option value="1986">1986</option>
            <option value="1985">1985</option>
            <option value="1984">1984</option>
            <option value="1983">1983</option>
            <option value="1982">1982</option>
            <option value="1981">1981</option>
            <option value="1980">1980</option>
            <option value="1979">1979</option>
            <option value="1978">1978</option>
            <option value="1977">1977</option>
            <option value="1976">1976</option>
            <option value="1975">1975</option>
            <option value="1974">1974</option>
            <option value="1973">1973</option>
            <option value="1972">1972</option>
            <option value="1971">1971</option>
            <option value="1970">1970</option>
            <option value="1969">1969</option>
            <option value="1968">1968</option>
            <option value="1967">1967</option>
            <option value="1966">1966</option>
            <option value="1965">1965</option>
            <option value="1964">1964</option>
            <option value="1963">1963</option>
            <option value="1962">1962</option>
            <option value="1961">1961</option>
            <option value="1960">1960</option>
            <option value="1959">1959</option>
            <option value="1958">1958</option>
            <option value="1957">1957</option>
            <option value="1956">1956</option>
            <option value="1955">1955</option>
            <option value="1954">1954</option>
            <option value="1953">1953</option>
            <option value="1952">1952</option>
            <option value="1951">1951</option>
            <option value="1950">1950</option>
            <option value="1949">1949</option>
            <option value="1948">1948</option>
            <option value="1947">1947</option>
            <option value="1946">1946</option>
            <option value="1945">1945</option>
            <option value="1944">1944</option>
            <option value="1943">1943</option>
            <option value="1942">1942</option>
            <option value="1941">1941</option>
            <option value="1940">1940</option>
            <option value="1939">1939</option>
            <option value="1938">1938</option>
            <option value="1937">1937</option>
            <option value="1936">1936</option>
            <option value="1935">1935</option>
            <option value="1934">1934</option>
            <option value="1933">1933</option>
            <option value="1932">1932</option>
            <option value="1931">1931</option>
            <option value="1930">1930</option>
            <option value="1929">1929</option>
            <option value="1928">1928</option>
            <option value="1927">1927</option>
            <option value="1926">1926</option>
            <option value="1925">1925</option>
            <option value="1924">1924</option>
          </select>
        </div>
        <div class="fg"><label class="fl">å‡ºç”Ÿæœˆ</label>
          <select class="fsel" id="dob_m" onchange="calcAgeFromPicker()">
<option value="">æœˆ</option>
            <option value="1">1æœˆ</option>
            <option value="2">2æœˆ</option>
            <option value="3">3æœˆ</option>
            <option value="4">4æœˆ</option>
            <option value="5">5æœˆ</option>
            <option value="6">6æœˆ</option>
            <option value="7">7æœˆ</option>
            <option value="8">8æœˆ</option>
            <option value="9">9æœˆ</option>
            <option value="10">10æœˆ</option>
            <option value="11">11æœˆ</option>
            <option value="12">12æœˆ</option>
          </select>
        </div>
        <div class="fg"><label class="fl">å‡ºç”Ÿæ—¥</label>
          <select class="fsel" id="dob_d" onchange="calcAgeFromPicker()">
<option value="">æ—¥</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
          </select>
        </div>
        <div class="fg"><label class="fl">è¨ˆç®—å¹´é½¡ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_age" readonly placeholder="è‡ªå‹•" style="background:var(--c3);color:var(--sky);"></div>
      </div>
      <div class="g5">
        <div class="fg"><label class="fl">æª¢æŸ¥æ—¥æœŸ</label><input type="date" class="fi" id="dr_exam_date" onchange="calcAgeFromPicker();syncExamDate()"></div>
        <div class="fg"><label class="fl">æ€§åˆ¥</label><select class="fsel" id="dr_sex"><option value="">è«‹é¸æ“‡</option><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></div>
        <div class="fg"><label class="fl">ç©ºè…¹æ™‚é–“</label>
          <select class="fsel" id="dr_fasting">
            <option value="">æœªå¡«</option><option value="4">â‰¥4å°æ™‚</option><option value="8">â‰¥8å°æ™‚ï¼ˆæ¨™æº–ï¼‰</option><option value="10">â‰¥10å°æ™‚</option><option value="12">â‰¥12å°æ™‚</option>
          </select>
        </div>
        <div class="fg" style="display:none;"><input type="hidden" id="dr_exam" value=""><input type="hidden" id="dr_dob" value=""></div>
      </div>
    </div>
    <!-- æ¨¡å¼Bï¼šç›´æ¥è¼¸å…¥ -->
    <div id="dob-text-mode" style="display:none;">
      <div class="g5">
        <div class="fg"><label class="fl">å—æª¢è€…ç·¨è™Ÿ *</label><input type="text" class="fi" id="dr_pid_b" placeholder="å¦‚ï¼š20240001"></div>
        <div class="fg"><label class="fl">å‡ºç”Ÿæ—¥æœŸï¼ˆè¥¿å…ƒ YYYYMMDDï¼‰</label><input type="text" class="fi" id="dr_dob_text" placeholder="19850315" maxlength="8" oninput="calcAgeFromText()"></div>
        <div class="fg"><label class="fl">æª¢æŸ¥æ—¥æœŸï¼ˆè¥¿å…ƒ YYYYMMDDï¼‰</label><input type="text" class="fi" id="dr_exam_text" placeholder="20241020" maxlength="8" oninput="calcAgeFromText()"></div>
        <div class="fg"><label class="fl">è¨ˆç®—å¹´é½¡ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_age_b" readonly placeholder="è‡ªå‹•" style="background:var(--c3);color:var(--sky);"></div>
        <div class="fg"><label class="fl">æ€§åˆ¥</label><select class="fsel" id="dr_sex_b"><option value="">è«‹é¸æ“‡</option><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></div>
      </div>
    </div>
    <div class="g5">
      <div class="fg"><label class="fl">æ•™è‚²ç¨‹åº¦</label><select class="fsel" id="dr_edu"><option value="">æœªå¡«</option><option value="åœ‹å°">åœ‹å°</option><option value="åœ‹ä¸­">åœ‹ä¸­</option><option value="é«˜ä¸­">é«˜ä¸­/è·</option><option value="å¤§å­¸">å¤§å­¸</option><option value="ç ”ç©¶æ‰€">ç ”ç©¶æ‰€ä»¥ä¸Š</option></select></div>
      <div class="fg"><label class="fl">è·æ¥­åˆ¥</label><select class="fsel" id="dr_job"><option value="">æœªå¡«</option><option value="è¾²æ¼">è¾²æ¼æ¥­</option><option value="å‹å·¥">å‹å·¥</option><option value="æœå‹™æ¥­">æœå‹™æ¥­</option><option value="å•†æ¥­">å•†æ¥­</option><option value="ç™½é ˜">è¡Œæ”¿/ç™½é ˜</option><option value="é†«ç™‚">é†«ç™‚äººå“¡</option><option value="é€€ä¼‘">é€€ä¼‘</option><option value="ç„¡æ¥­">ç„¡æ¥­/å®¶ç®¡</option></select></div>
      <div class="fg"><label class="fl">æ—ç¾¤</label><select class="fsel" id="dr_eth"><option value="">æœªå¡«</option><option value="æ¼¢æ—">æ¼¢æ—</option><option value="åŸä½æ°‘">åŸä½æ°‘</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
      <div class="fg"><label class="fl">å©šå§»ç‹€æ…‹</label><select class="fsel" id="dr_mar"><option value="">æœªå¡«</option><option value="æœªå©š">æœªå©š</option><option value="å·²å©š">å·²å©š</option><option value="é›¢å©š">é›¢å©š/åˆ†å±…</option><option value="å–ªå¶">å–ªå¶</option></select></div>
      <div class="fg"><label class="fl">å·¥ä½œæ—¥å¹³å‡ç¡çœ </label><div class="iu"><input type="number" step="0.5" min="0" max="24" class="fi" id="dr_sleep_work" placeholder="hr"><span class="uu">hr</span></div></div>
    </div>
    <div class="g5">
      <div class="fg"><label class="fl">è‡ªè¦ºç—‡ç‹€</label><textarea class="fi" id="dr_symptoms" rows="2" placeholder="å¦‚ï¼šé ­æšˆã€ç–²å€¦ã€å¤œå°¿â€¦ï¼ˆå¯é¸å¡«ï¼‰" style="font-family:var(--ff-b);font-size:12px;"></textarea></div>
      <div class="fg"><label class="fl">æ—¢å¾€ç—…å²</label><textarea class="fi" id="dr_pmh" rows="2" placeholder="å¦‚ï¼šç³–å°¿ç—…ã€é«˜è¡€å£“ã€å¿ƒè‡Ÿæ‰‹è¡“â€¦" style="font-family:var(--ff-b);font-size:12px;"></textarea></div>
      <div class="fg"><label class="fl">ç›®å‰ç”¨è—¥</label><textarea class="fi" id="dr_meds" rows="2" placeholder="å¦‚ï¼šMetforminã€Amlodipineâ€¦" style="font-family:var(--ff-b);font-size:12px;"></textarea></div>
      <div class="fg"><label class="fl">éæ•å²</label><input type="text" class="fi" id="dr_allergy" placeholder="å¦‚ï¼šPenicillinâ€¦"></div>
      <div class="fg"><label class="fl">é†«å¸«å‚™è¨»</label><input type="text" class="fi" id="dr_note" placeholder="è‡¨åºŠå‚™å¿˜..."></div>
    </div>
  </div>

  <!-- VITALS -->
  <div class="drblock">
    <div class="drbt">ğŸ“ èº«é«”æª¢æŸ¥</div>
    <div class="g5">
      <div class="fg"><label class="fl">èº«é«˜</label><div class="iu"><input type="number" class="fi" id="dr_ht" placeholder="cm" oninput="autoBMI()"><span class="uu">cm</span></div></div>
      <div class="fg"><label class="fl">é«”é‡</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_wt" placeholder="kg" oninput="autoBMI()"><span class="uu">kg</span></div></div>
      <div class="fg"><label class="fl">BMIï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_bmi" readonly style="background:var(--c3);color:var(--teal);"></div>
      <div class="fg"><label class="fl">æ”¶ç¸®å£“ SBP</label><div class="iu"><input type="number" class="fi" id="dr_sbp" placeholder="mmHg"><span class="uu">mmHg</span></div></div>
      <div class="fg"><label class="fl">èˆ’å¼µå£“ DBP</label><div class="iu"><input type="number" class="fi" id="dr_dbp" placeholder="mmHg"><span class="uu">mmHg</span></div></div>
      <div class="fg"><label class="fl">å¿ƒè·³ HR</label><div class="iu"><input type="number" class="fi" id="dr_hr" placeholder="bpm"><span class="uu">bpm</span></div></div>
      <div class="fg"><label class="fl">è…°åœ</label><div class="iu"><input type="number" class="fi" id="dr_waist" placeholder="cm"><span class="uu">cm</span></div></div>
      <div class="fg"><label class="fl">è‡€åœï¼ˆWHRç”¨ï¼‰</label><div class="iu"><input type="number" class="fi" id="dr_hip" placeholder="cm"><span class="uu">cm</span></div></div>
      <div class="fg"><label class="fl">WHRï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_whr" readonly style="background:var(--c3);color:var(--sky);"></div>
      <div class="fg"><label class="fl">é«”è„‚ç‡ï¼ˆè‹¥æœ‰ï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_bf" placeholder="%"><span class="uu">%</span></div></div>
    </div>
    <div class="g5">
      <div class="fg"><label class="fl">ç†æƒ³é«”é‡ï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_ibw" readonly style="background:var(--c3);color:var(--amber);" placeholder="è‡ªå‹•è¨ˆç®—"></div>
      <div class="fg"><label class="fl">é«”é‡å·®ï¼ˆç¾å€¼-ç†æƒ³ï¼‰</label><input type="text" class="fi" id="dr_wt_diff" readonly style="background:var(--c3);color:var(--sky);"></div>
      <div class="fg"><label class="fl">BMI åˆ†é¡</label><input type="text" class="fi" id="dr_bmi_cat" readonly style="background:var(--c3);color:var(--violet);"></div>
    </div>
  </div>

  <!-- PHYSICAL EXAM -->
  <div class="drblock">
    <div class="drbt">ğŸ©º ç†å­¸æª¢æŸ¥</div>
    <div class="g5">
      <div class="fg"><label class="fl">è¦–åŠ›ï¼ˆå³çœ¼ï¼‰</label><input type="text" class="fi" id="dr_va_r" placeholder="å¦‚ï¼š1.0 æˆ– 0.6/çŸ¯æ­£1.0"></div>
      <div class="fg"><label class="fl">è¦–åŠ›ï¼ˆå·¦çœ¼ï¼‰</label><input type="text" class="fi" id="dr_va_l" placeholder="å¦‚ï¼š0.8"></div>
      <div class="fg"><label class="fl">è½åŠ›ï¼ˆå³è€³ï¼‰</label>
        <select class="fsel" id="dr_hear_r">
          <option value="">æœªæª¢æ¸¬</option><option value="æ­£å¸¸">æ­£å¸¸</option><option value="è¼•åº¦ç•°å¸¸">è¼•åº¦ç•°å¸¸</option><option value="ä¸­åº¦ç•°å¸¸">ä¸­åº¦ç•°å¸¸</option><option value="é‡åº¦ç•°å¸¸">é‡åº¦ç•°å¸¸</option>
        </select>
      </div>
      <div class="fg"><label class="fl">è½åŠ›ï¼ˆå·¦è€³ï¼‰</label>
        <select class="fsel" id="dr_hear_l">
          <option value="">æœªæª¢æ¸¬</option><option value="æ­£å¸¸">æ­£å¸¸</option><option value="è¼•åº¦ç•°å¸¸">è¼•åº¦ç•°å¸¸</option><option value="ä¸­åº¦ç•°å¸¸">ä¸­åº¦ç•°å¸¸</option><option value="é‡åº¦ç•°å¸¸">é‡åº¦ç•°å¸¸</option>
        </select>
      </div>
      <div class="fg"><label class="fl">ç†å­¸æª¢æŸ¥ç•°å¸¸ç™¼ç¾</label><input type="text" class="fi" id="dr_pe_note" placeholder="å¦‚ï¼šé ¸éƒ¨æ·‹å·´çµè…«å¤§â€¦"></div>
    </div>
  </div>

  <!-- SPECIAL EXAMS -->
  <div class="drblock">
    <div class="drbt">ğŸ“¸ ç‰¹æ®Šæª¢æŸ¥</div>
    <div class="g5">
      <div class="fg"><label class="fl">å¿ƒé›»åœ–ï¼ˆECGï¼‰</label>
        <select class="fsel" id="dr_ecg">
          <option value="">æœªæª¢æ¸¬</option><option value="æ­£å¸¸">æ­£å¸¸ç«‡æ€§å¿ƒå¾‹</option><option value="ç«‡æ€§å¿ƒæéé€Ÿ">ç«‡æ€§å¿ƒæéé€Ÿ</option><option value="å¿ƒæˆ¿é¡«å‹•">å¿ƒæˆ¿é¡«å‹•</option><option value="STè®ŠåŒ–">STæ®µè®ŠåŒ–</option><option value="å·¦å¿ƒå®¤è‚¥å¤§">å·¦å¿ƒå®¤è‚¥å¤§</option><option value="å‚³å°ç•°å¸¸">å‚³å°ç•°å¸¸</option><option value="å…¶ä»–ç•°å¸¸">å…¶ä»–ç•°å¸¸</option>
        </select>
      </div>
      <div class="fg"><label class="fl">ECG è£œå……èªªæ˜</label><input type="text" class="fi" id="dr_ecg_note" placeholder="å¦‚ï¼šå®Œå…¨å³æŸæ”¯å‚³å°é˜»æ»¯â€¦"></div>
      <div class="fg"><label class="fl">èƒ¸éƒ¨ X å…‰</label>
        <select class="fsel" id="dr_xray">
          <option value="">æœªæª¢æ¸¬</option><option value="æ­£å¸¸">æ­£å¸¸</option><option value="å¿ƒè‡Ÿæ“´å¤§">å¿ƒè‡Ÿæ“´å¤§</option><option value="è‚ºæµ¸æ½¤">è‚ºæµ¸æ½¤/è‚ºç‚</option><option value="è‚ºçµç¯€">è‚ºçµç¯€</option><option value="è‚ºæ°£è…«">è‚ºæ°£è…«</option><option value="èƒ¸è…”ç©æ¶²">èƒ¸è…”ç©æ¶²</option><option value="å…¶ä»–ç•°å¸¸">å…¶ä»–ç•°å¸¸</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Xå…‰è£œå……èªªæ˜</label><input type="text" class="fi" id="dr_xray_note" placeholder="å¦‚ï¼šå³ä¸Šè‚º 0.8cm çµç¯€ï¼Œå»ºè­°CTè¿½è¹¤â€¦"></div>
      <div class="fg"><label class="fl">å£è…”æª¢æŸ¥</label>
        <select class="fsel" id="dr_oral">
          <option value="">æœªæª¢æ¸¬</option><option value="æ­£å¸¸">æ­£å¸¸</option><option value="é½²é½’">é½²é½’</option><option value="ç‰™å‘¨ç—…">ç‰™å‘¨ç—…</option><option value="å£è…”é»è†œç•°å¸¸">å£è…”é»è†œç•°å¸¸</option><option value="å…¶ä»–">å…¶ä»–ç•°å¸¸</option>
        </select>
      </div>
    </div>
  </div>

  <!-- BLOOD SUGAR -->
  <div class="drblock">
    <div class="drbt">ğŸ¬ è¡€ç³– &amp; ä»£è¬</div>
    <div class="g5">
      <div class="fg"><label class="fl">ç©ºè…¹è¡€ç³– FPG</label><div class="iu"><input type="number" class="fi" id="dr_fpg" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">é£¯å¾Œè¡€ç³–ï¼ˆ2hr PPGï¼‰</label><div class="iu"><input type="number" class="fi" id="dr_ppg" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">HbA1c</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_hba1c" placeholder="%"><span class="uu">%</span></div></div>
      <div class="fg"><label class="fl">èƒ°å³¶ç´ ï¼ˆç©ºè…¹ï¼‰</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_ins" placeholder="Î¼IU/mL"><span class="uu">Î¼IU/mL</span></div></div>
      <div class="fg"><label class="fl">C-Peptide</label><div class="iu"><input type="number" step="0.01" class="fi" id="dr_cpep" placeholder="ng/mL"><span class="uu">ng/mL</span></div></div>
      <div class="fg"><label class="fl">HOMA-IRï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_homa" readonly style="background:var(--c3);color:var(--sky);"></div>
    </div>
  </div>

  <!-- LIPIDS -->
  <div class="drblock">
    <div class="drbt">ğŸ©¸ è¡€è„‚</div>
    <div class="g5">
      <div class="fg"><label class="fl">ç¸½è†½å›ºé†‡ TC</label><div class="iu"><input type="number" class="fi" id="dr_tc" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">TG ä¸‰é…¸ç”˜æ²¹é…¯</label><div class="iu"><input type="number" class="fi" id="dr_tg" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">LDL</label><div class="iu"><input type="number" class="fi" id="dr_ldl" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">HDL</label><div class="iu"><input type="number" class="fi" id="dr_hdl" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">éHDLï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_nhdl" readonly style="background:var(--c3);color:var(--sky);"></div>
    </div>
  </div>

  <!-- LIVER / KIDNEY -->
  <div class="drblock">
    <div class="drbt">ğŸ«€ è‚è…åŠŸèƒ½</div>
    <div class="g5">
      <div class="fg"><label class="fl">AST (GOT)</label><div class="iu"><input type="number" class="fi" id="dr_ast" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
      <div class="fg"><label class="fl">ALT (GPT)</label><div class="iu"><input type="number" class="fi" id="dr_alt" placeholder="IU/L"><span class="uu">IU/L</span></div></div>
      <div class="fg"><label class="fl">è‚Œé…¸é… Cr</label><div class="iu"><input type="number" step="0.01" class="fi" id="dr_cr" placeholder="mg/dL" oninput="autoEGFR()"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">eGFRï¼ˆè‡ªå‹•ï¼‰</label><input type="text" class="fi" id="dr_egfr" readonly style="background:var(--c3);color:var(--teal);"></div>
      <div class="fg"><label class="fl">å°¿é…¸ Uric Acid</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_ua" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">BUN</label><div class="iu"><input type="number" class="fi" id="dr_bun" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">UACR</label><div class="iu"><input type="number" class="fi" id="dr_uacr" placeholder="mg/g"><span class="uu">mg/g</span></div></div>
      <div class="fg"><label class="fl">UPCR</label><div class="iu"><input type="number" class="fi" id="dr_upcr" placeholder="mg/g"><span class="uu">mg/g</span></div></div>
      <div class="fg"><label class="fl">å°¿è›‹ç™½è©¦ç´™</label><select class="fsel" id="dr_dip"><option value="">æœªæª¢æ¸¬</option><option value="neg">é™°æ€§</option><option value="trace">å¾®é‡</option><option value="1+">1+</option><option value="2+">2+</option><option value="3+">3+</option></select></div>
      <div class="fg"><label class="fl">K+</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_k" placeholder="mEq/L"><span class="uu">mEq/L</span></div></div>
    </div>
  </div>

  <!-- CBC -->
  <div class="drblock">
    <div class="drbt">ğŸ”¬ è¡€æ¶²å¸¸è¦ï¼ˆCBCï¼‰</div>
    <div class="g5">
      <div class="fg"><label class="fl">Hb è¡€è‰²ç´ </label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_hb" placeholder="g/dL"><span class="uu">g/dL</span></div></div>
      <div class="fg"><label class="fl">WBC ç™½è¡€çƒ</label><div class="iu"><input type="number" class="fi" id="dr_wbc" placeholder="K/Î¼L"><span class="uu">K/Î¼L</span></div></div>
      <div class="fg"><label class="fl">PLT è¡€å°æ¿</label><div class="iu"><input type="number" class="fi" id="dr_plt" placeholder="K/Î¼L"><span class="uu">K/Î¼L</span></div></div>
      <div class="fg"><label class="fl">MCV</label><div class="iu"><input type="number" class="fi" id="dr_mcv" placeholder="fL"><span class="uu">fL</span></div></div>
      <div class="fg"><label class="fl">Hematocrit Hct</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_hct" placeholder="%"><span class="uu">%</span></div></div>
    </div>
  </div>

  <!-- HEPATITIS + THYROID -->
  <div class="drblock">
    <div class="drbt">ğŸ¦  è‚ç‚æ¨™è¨˜ &amp; ç”²ç‹€è…º</div>
    <div class="g5">
      <div class="fg"><label class="fl">HBsAg</label><select class="fsel" id="dr_hbsag"><option value="">æœªæª¢æ¸¬</option><option value="neg">é™°æ€§</option><option value="pos">é™½æ€§</option></select></div>
      <div class="fg"><label class="fl">Anti-HCV</label><select class="fsel" id="dr_hcv"><option value="">æœªæª¢æ¸¬</option><option value="neg">é™°æ€§</option><option value="pos">é™½æ€§</option></select></div>
      <div class="fg"><label class="fl">HBsAbï¼ˆæŠ—é«”ï¼‰</label><select class="fsel" id="dr_hbsab"><option value="">æœªæª¢æ¸¬</option><option value="neg">é™°æ€§</option><option value="pos">é™½æ€§</option></select></div>
      <div class="fg"><label class="fl">TSH</label><div class="iu"><input type="number" step="0.01" class="fi" id="dr_tsh" placeholder="mIU/L"><span class="uu">mIU/L</span></div></div>
      <div class="fg"><label class="fl">Free T4</label><div class="iu"><input type="number" step="0.01" class="fi" id="dr_ft4" placeholder="ng/dL"><span class="uu">ng/dL</span></div></div>
    </div>
  </div>

  <!-- BONE -->
  <div class="drblock">
    <div class="drbt">ğŸ¦´ éª¨ç¤¦ç‰©è³ª</div>
    <div class="g5">
      <div class="fg"><label class="fl">Calcium è¡€éˆ£</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_ca" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">Phosphorus ç£·</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_p" placeholder="mg/dL"><span class="uu">mg/dL</span></div></div>
      <div class="fg"><label class="fl">PTH</label><div class="iu"><input type="number" class="fi" id="dr_pth" placeholder="pg/mL"><span class="uu">pg/mL</span></div></div>
      <div class="fg"><label class="fl">Vitamin D (25-OH)</label><div class="iu"><input type="number" class="fi" id="dr_vitd" placeholder="ng/mL"><span class="uu">ng/mL</span></div></div>
    </div>
  </div>

  <!-- URINALYSIS -->
  <div class="drblock">
    <div class="drbt">ğŸ§ª å°¿æ¶²å¸¸è¦æª¢æŸ¥</div>
    <div class="g5">
      <div class="fg"><label class="fl">å°¿æ¶²å¤–è§€</label>
        <select class="fsel" id="dr_urine_color">
          <option value="">æœªå¡«</option><option value="æ·¡é»ƒæ¸…æ¾ˆ">æ·¡é»ƒæ¸…æ¾ˆï¼ˆæ­£å¸¸ï¼‰</option><option value="æ·±é»ƒ">æ·±é»ƒ</option><option value="è¡€å°¿">è¡€å°¿/æ£•è‰²</option><option value="æ··æ¿">æ··æ¿</option>
        </select>
      </div>
      <div class="fg"><label class="fl">å°¿pH</label><div class="iu"><input type="number" step="0.5" min="4" max="9" class="fi" id="dr_urine_ph" placeholder="4.5-8.5"><span class="uu"></span></div></div>
      <div class="fg"><label class="fl">å°¿æ¯”é‡</label><div class="iu"><input type="number" step="0.001" min="1.001" max="1.035" class="fi" id="dr_urine_sg" placeholder="1.010"><span class="uu"></span></div></div>
      <div class="fg"><label class="fl">å°¿ç³–</label>
        <select class="fsel" id="dr_urine_glu">
          <option value="">æœªå¡«</option><option value="neg">é™°æ€§</option><option value="1+">1+</option><option value="2+">2+</option><option value="3+">3+</option>
        </select>
      </div>
      <div class="fg"><label class="fl">å°¿é…®é«”</label>
        <select class="fsel" id="dr_urine_ket">
          <option value="">æœªå¡«</option><option value="neg">é™°æ€§</option><option value="trace">å¾®é‡</option><option value="pos">é™½æ€§</option>
        </select>
      </div>
      <div class="fg"><label class="fl">ç™½è¡€çƒé…¯é…¶</label>
        <select class="fsel" id="dr_urine_le">
          <option value="">æœªå¡«</option><option value="neg">é™°æ€§</option><option value="pos">é™½æ€§</option>
        </select>
      </div>
      <div class="fg"><label class="fl">äºç¡é…¸é¹½</label>
        <select class="fsel" id="dr_urine_nit">
          <option value="">æœªå¡«</option><option value="neg">é™°æ€§</option><option value="pos">é™½æ€§</option>
        </select>
      </div>
      <div class="fg"><label class="fl">RBCï¼ˆé¡æª¢ï¼‰</label><input type="text" class="fi" id="dr_urine_rbc" placeholder="å¦‚ï¼š0-2/HPF"></div>
      <div class="fg"><label class="fl">WBCï¼ˆé¡æª¢ï¼‰</label><input type="text" class="fi" id="dr_urine_wbc_m" placeholder="å¦‚ï¼š0-5/HPF"></div>
      <div class="fg"><label class="fl">å…¶ä»–å°¿æ¶²ç•°å¸¸</label><input type="text" class="fi" id="dr_urine_note" placeholder="å¦‚ï¼šåœ“æŸ±é«”ã€çµæ™¶â€¦"></div>
    </div>
  </div>

  <!-- TUMOR MARKERS -->
  <div class="drblock">
    <div class="drbt">ğŸ”¬ è…«ç˜¤æ¨™è¨˜ï¼ˆé¸å¡«ï¼‰</div>
    <div class="g5">
      <div class="fg"><label class="fl">CEA</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_cea" placeholder="ng/mLï¼ˆæ­£å¸¸&lt;5ï¼‰"><span class="uu">ng/mL</span></div></div>
      <div class="fg"><label class="fl">AFP</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_afp" placeholder="ng/mLï¼ˆæ­£å¸¸&lt;20ï¼‰"><span class="uu">ng/mL</span></div></div>
      <div class="fg"><label class="fl">CA-125</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_ca125" placeholder="U/mLï¼ˆæ­£å¸¸&lt;35ï¼‰"><span class="uu">U/mL</span></div></div>
      <div class="fg"><label class="fl">CA 19-9</label><div class="iu"><input type="number" step="0.1" class="fi" id="dr_ca199" placeholder="U/mLï¼ˆæ­£å¸¸&lt;37ï¼‰"><span class="uu">U/mL</span></div></div>
      <div class="fg"><label class="fl">PSAï¼ˆç”·æ€§ï¼‰</label><div class="iu"><input type="number" step="0.01" class="fi" id="dr_psa" placeholder="ng/mLï¼ˆæ­£å¸¸&lt;4ï¼‰"><span class="uu">ng/mL</span></div></div>
    </div>
    <div class="hint" style="margin-top:4px;">âš ï¸ è…«ç˜¤æ¨™è¨˜éœ€çµåˆè‡¨åºŠç—‡ç‹€èˆ‡å½±åƒåˆ¤è®€ï¼Œå–®ä¸€æ•¸å€¼å‡é«˜ä¸ä»£è¡¨ç½¹ç™Œï¼Œéœ€ç”±é†«å¸«æ•´åˆè©•ä¼°ã€‚</div>
  </div>

  <!-- STATIN ELIGIBILITY HISTORY -->
  <div class="drblock">
    <div class="drbt">ğŸ’Š å¥ä¿é™è¡€è„‚ç›¸é—œç—…å²</div>
    <div class="g5">
      <div class="fg"><label class="fl">æ€¥æ€§å† ç‹€å‹•è„ˆç—‡å€™ç¾¤ ACS</label><select class="fsel" id="dr_acs"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">å† ç‹€å‹•è„ˆç¹é“/å¿ƒå°ç®¡ä»‹å…¥</label><select class="fsel" id="dr_cabg"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">å¿ƒè¡€ç®¡ç–¾ç—…ï¼ˆå¿ƒçµç—›/ç¼ºè¡€å‹è…¦è¡€ç®¡ï¼‰</label><select class="fsel" id="dr_cvd"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">ç³–å°¿ç—…</label><select class="fsel" id="dr_dm"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">å·²ç¢ºè¨ºé«˜è¡€è„‚ç—‡</label><select class="fsel" id="dr_hl"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">é«˜è¡€å£“</label><select class="fsel" id="dr_htn"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">ç”·â‰¥45/å¥³â‰¥55æˆ–åœç¶“</label><select class="fsel" id="dr_agerf"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">æ—©ç™¼æ€§å† å¿ƒç—…å®¶æ—å²</label><select class="fsel" id="dr_fh"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">å¸è¸</label><select class="fsel" id="dr_smoke"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
      <div class="fg"><label class="fl">CKD æ…¢æ€§è…è‡Ÿç—…</label><select class="fsel" id="dr_ckd"><option value="no">å¦</option><option value="yes">æ˜¯</option></select></div>
    </div>
  </div>

  <!-- LIFESTYLE -->
  <div class="drblock">
    <div class="drbt">ğŸƒ ç”Ÿæ´»ç¿’æ…£</div>
    <div class="g5">
      <div class="fg"><label class="fl">æŠ½è¸ç‹€æ³</label>
        <select class="fsel" id="dr_smoke_detail">
          <option value="">æœªå¡«</option><option value="never">å¾æœªæŠ½è¸</option><option value="ex">å·²æˆ’è¸</option><option value="light">è¼•åº¦ï¼ˆ&lt;10æ”¯/å¤©ï¼‰</option><option value="moderate">ä¸­åº¦ï¼ˆ10-20æ”¯/å¤©ï¼‰</option><option value="heavy">é‡åº¦ï¼ˆ&gt;20æ”¯/å¤©ï¼‰</option>
        </select>
      </div>
      <div class="fg"><label class="fl">è¸é½¡ï¼ˆå¹´ï¼‰</label><div class="iu"><input type="number" class="fi" id="dr_smoke_yrs" placeholder="å¹´ï¼ˆå·²æˆ’è€…å¡«ç¸½è¸é½¡ï¼‰"><span class="uu">å¹´</span></div></div>
      <div class="fg"><label class="fl">é£²é…’ç‹€æ³</label>
        <select class="fsel" id="dr_etoh">
          <option value="">æœªå¡«</option><option value="no">ä¸å–</option><option value="social">å¶çˆ¾ç¤¾äº¤æ€§</option><option value="mild">è¼•åº¦ï¼ˆ&lt;14æ¨™æº–æ¯/é€±ï¼‰</option><option value="heavy">é‡åº¦ï¼ˆâ‰¥14æ¨™æº–æ¯/é€±ï¼‰</option>
        </select>
      </div>
      <div class="fg"><label class="fl">åš¼æª³æ¦”</label>
        <select class="fsel" id="dr_betel">
          <option value="">æœªå¡«</option><option value="never">å¾æœª</option><option value="ex">å·²æˆ’</option><option value="occasional">å¶çˆ¾</option><option value="daily">æ¯æ—¥</option><option value="heavy">æ¯æ—¥å¤šé‡</option>
        </select>
      </div>
      <div class="fg"><label class="fl">é‹å‹•é »ç‡</label>
        <select class="fsel" id="dr_ex">
          <option value="">æœªå¡«</option><option value="none">å¹¾ä¹ä¸é‹å‹•</option><option value="light">&lt;150åˆ†/é€±</option><option value="moderate">150-300åˆ†/é€±</option><option value="vigorous">&gt;300åˆ†/é€±</option>
        </select>
      </div>
    </div>
    <div class="g5">
      <div class="fg"><label class="fl">é£²é£Ÿç¿’æ…£</label><select class="fsel" id="dr_diet"><option value="">æœªå¡«</option><option value="western">è¥¿å¼/é«˜æ²¹é«˜é¹½</option><option value="traditional">å‚³çµ±å°å¼</option><option value="vegetarian">ç´ é£Ÿ</option><option value="healthy">åœ°ä¸­æµ·/DASHå¼</option></select></div>
      <div class="fg"><label class="fl">å¹³å‡ç¡çœ æ™‚æ•¸/å¤©</label><div class="iu"><input type="number" step="0.5" class="fi" id="dr_sleep" placeholder="hr/å¤©"><span class="uu">hr</span></div></div>
      <div class="fg"><label class="fl">å£“åŠ›ç¨‹åº¦ï¼ˆè‡ªè©•1-5ï¼‰</label><select class="fsel" id="dr_stress"><option value="">æœªå¡«</option><option value="1">1ï¼ˆä½ï¼‰</option><option value="2">2</option><option value="3">3ï¼ˆä¸­ï¼‰</option><option value="4">4</option><option value="5">5ï¼ˆé«˜ï¼‰</option></select></div>
    </div>
  </div>

  <div class="brow" style="position:sticky;bottom:20px;background:rgba(6,8,16,.9);backdrop-filter:blur(12px);padding:14px;border-radius:var(--r);border:1px solid var(--bd);z-index:50;">
    <button class="btn bt" style="font-size:14px;padding:11px 24px;" onclick="runDR(false)">ğŸ“‹ ç”¢ç”Ÿå ±å‘Š</button>
    <button class="btn bg-a" style="font-size:14px;padding:11px 24px;" onclick="runDR(true)">ğŸ¤– AI é†«å¸« + å®Œæ•´å ±å‘Š</button>
    <button class="btn bs" onclick="saveDraft()">ğŸ’¾ æš«å­˜</button>
    <button class="btn bg-s" onclick="saveToSB()">â˜ï¸ å„²å­˜è³‡æ–™åº«</button>
    <button class="btn ba" onclick="clearDR()">æ¸…é™¤</button>
    <button class="btn bs" onclick="exportDR()">ğŸ“¤ åŒ¯å‡º</button>
  </div>

  <div class="rp" id="rp-dr" style="margin-top:20px;">
    <div id="dr-qualify"></div>
    <div id="dr-ai" style="margin-top:14px;"></div>
    <div class="dis">âš ï¸ åˆ¤è®€çµæœä¾æ“šå…¬é–‹å¥ä¿è¦ç¯„èˆ‡é†«å­¸æŒ‡å¼•ï¼Œåƒ…ä¾›é†«ç™‚äººå“¡åƒè€ƒï¼Œå¯¦éš›æ”¶æ¡ˆè«‹ä¾æœ€æ–°å¥ä¿å…¬å‘Šç‚ºæº–ã€‚AI é†«å¸«åŠŸèƒ½æ¨™ç¤ºã€ŒAI å»ºè­°ã€å­—æ¨£ï¼Œä¸å–ä»£è‡¨åºŠåˆ¤æ–·ã€‚</div>
  </div>

  <!-- DB SECTION -->
  <div style="margin-top:32px;border-top:1px solid var(--bd);padding-top:24px;">
    <div style="font-family:var(--ff-h);font-size:18px;font-weight:700;margin-bottom:4px;">ğŸ—„ï¸ è³‡æ–™åº«ç®¡ç†</div>
    <div style="font-size:12.5px;color:var(--t2);margin-bottom:16px;">é†«å¸«å¯æŸ¥çœ‹æ­·å²å—æª¢è€…è³‡æ–™ã€é†«å­¸æŒ‡å¼•è³‡æ–™åº«ã€è‡ªè¨‚è³‡æ–™ä¾†æº</div>
    <div class="dbtabs">
      <button class="dbtab on" onclick="showDBTab('records')">ğŸ“ å—æª¢è€…è¨˜éŒ„</button>
      <button class="dbtab" onclick="showDBTab('refs')">ğŸ“š é†«å­¸æŒ‡å¼•è³‡æ–™åº«</button>
      <button class="dbtab" onclick="showDBTab('custom')">âœï¸ è‡ªè¨‚ä¾†æº</button>
    </div>

    <!-- Records -->
    <div class="dbp on" id="dbt-records">
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input type="text" class="fi" id="search_pid" placeholder="æœå°‹å—æª¢è€…ç·¨è™Ÿ..." style="flex:1;max-width:260px;">
        <button class="btn bt" style="padding:7px 16px;font-size:12px;" onclick="searchRecords()">æœå°‹</button>
        <button class="btn bs" style="padding:7px 16px;font-size:12px;" onclick="loadRecords()">é‡æ–°è¼‰å…¥</button>
      </div>
      <div id="records-list"><div class="al ad">å°šæœªé€£æ¥ Supabase æˆ–ç„¡æ­·å²è¨˜éŒ„ã€‚æœ¬æ©Ÿæš«å­˜è¨˜éŒ„é¡¯ç¤ºæ–¼ä¸‹æ–¹ã€‚</div></div>
      <div id="local-records" style="margin-top:12px;"></div>
    </div>

    <!-- References DB -->
    <div class="dbp" id="dbt-refs">
      <input type="text" class="ref-search-bar" id="ref-search" placeholder="ğŸ” æœå°‹æŒ‡å¼•åç¨±ã€é—œéµå­—..." oninput="filterRefs()">
      <div class="ref-cat-filter" id="ref-cat-filter">
        <button class="ref-cat-btn on" onclick="setCatFilter('all',this)">å…¨éƒ¨</button>
        <button class="ref-cat-btn" onclick="setCatFilter('é†«ç™‚æŒ‡å¼•',this)">é†«ç™‚æŒ‡å¼•</button>
        <button class="ref-cat-btn" onclick="setCatFilter('æ”¿åºœæ©Ÿé—œ',this)">æ”¿åºœæ©Ÿé—œ</button>
        <button class="ref-cat-btn" onclick="setCatFilter('å¥ä¿è¦ç¯„',this)">å¥ä¿è¦ç¯„</button>
        <button class="ref-cat-btn" onclick="setCatFilter('åœ‹éš›æ©Ÿæ§‹',this)">åœ‹éš›æ©Ÿæ§‹</button>
        <button class="ref-cat-btn" onclick="setCatFilter('å°ç£å­¸æœƒ',this)">å°ç£å­¸æœƒ</button>
        <button class="ref-cat-btn" onclick="setCatFilter('å·¥å…·è³‡æº',this)">å·¥å…·è³‡æº</button>
      </div>
      <div id="refs-list"></div>
    </div>

    <!-- Custom source -->
    <div class="dbp" id="dbt-custom">
      <div class="card" style="margin-bottom:14px;">
        <div class="ch">æ–°å¢è‡ªè¨‚è³‡æ–™ä¾†æº</div>
        <div class="g2">
          <div class="fg"><label class="fl">æ¨™é¡Œ</label><input type="text" class="fi" id="cs_title" placeholder="å¦‚ï¼šKDIGO 2024 CKD æŒ‡å¼•"></div>
          <div class="fg"><label class="fl">ä¾†æºç¶²å€ *</label><input type="text" class="fi" id="cs_url" placeholder="https://...ï¼ˆè«‹å¡«å…¥å®˜æ–¹å…¬é–‹é é¢ï¼‰"></div>
          <div class="fg"><label class="fl">é¡åˆ¥</label><select class="fsel" id="cs_cat"><option value="guideline">é†«ç™‚æŒ‡å¼•</option><option value="society">å­¸æœƒè²æ˜</option><option value="gov">æ”¿åºœæ©Ÿé—œ</option><option value="research">ç ”ç©¶æ–‡ç»</option><option value="formulary">å¥ä¿è—¥å…¸</option></select></div>
          <div class="fg"><label class="fl">æ›´æ–°æ—¥æœŸ</label><input type="text" class="fi" id="cs_date" placeholder="å¦‚ï¼š2024-01"></div>
        </div>
        <div class="fg"><label class="fl">å…¬é–‹æ‘˜è¦ï¼ˆè«‹å‹¿è¤‡è£½å—ç‰ˆæ¬Šä¿è­·çš„å…¨æ–‡ï¼‰</label><textarea class="fi" id="cs_summary" rows="4" placeholder="åœ¨æ­¤è²¼ä¸Šæˆ–å¡«å¯«å…¬é–‹æ‘˜è¦é‡é»..." style="font-family:var(--ff-b);font-size:12.5px;"></textarea></div>
        <div class="al ay" style="margin-bottom:12px;">âš ï¸ è‘—ä½œæ¬Šè²æ˜ï¼šè«‹ç¢ºèªä¾†æºç‚ºå…¬é–‹å¯å¼•ç”¨ä¹‹å®˜æ–¹é é¢ï¼Œåƒ…æ‘˜å–å…¬é–‹æ‘˜è¦ï¼Œå‹¿è¤‡è£½å—ç‰ˆæ¬Šä¿è­·çš„å®Œæ•´åŸæ–‡ã€‚</div>
        <button class="btn bt" onclick="addCustomSource()">â• æ–°å¢ä¾†æº</button>
      </div>
      <div id="custom-list"></div>
    </div>
  </div>
</div>
</div><!-- /s-dr -->

<!-- LOADER -->
<div class="loader" id="loader">
  <div class="spin"></div>
  <div class="ltxt" id="loader-txt">è™•ç†ä¸­...</div>
</div>

<!-- LOGIN MODAL -->
<div class="mbg" id="modal-login">
  <div class="mbox">
    <div class="mt">ğŸ‘¨â€âš•ï¸ é†«å¸«ç™»å…¥</div>
    <div class="ms">è¼¸å…¥é†«å¸«å¯†ç¢¼ä»¥ä½¿ç”¨é†«å¸«å°ˆå€åŠŸèƒ½</div>
    <div class="fg"><label class="fl">å¯†ç¢¼</label><input type="password" class="fi" id="dr_pwd" placeholder="é†«å¸«å¯†ç¢¼" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <div class="al ar" id="login-err" style="display:none;margin-bottom:8px;">âŒ å¯†ç¢¼éŒ¯èª¤</div>
    <div class="brow">
      <button class="btn bt" onclick="doLogin()" style="flex:1;">ç™»å…¥</button>
      <button class="btn bs" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
    <div style="text-align:center;font-family:var(--ff-m);font-size:10px;color:var(--t3);margin-top:12px;">ç¤ºç¯„å¯†ç¢¼ï¼šdoctor2024</div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="mbg" id="modal-detail">
  <div class="mbox" style="width:600px;max-height:80vh;overflow-y:auto;">
    <div id="detail-content"></div>
    <div class="brow" style="margin-top:16px;"><button class="btn bs" onclick="document.getElementById('modal-detail').classList.remove('on')">é—œé–‰</button></div>
  </div>
</div>

<script>
'use strict';
const DR_PWD='doctor2024';
let isDoctor=false,selSym=[],sbUrl='',sbKey='',drDocId='';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ClinCalc v6 â€” Component Architecture
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ClinCalc = {};

// â”€â”€â”€ MODULE: Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ClinCalc.Config = {
  version: '7.0.0',
  // AI provider settings
  ai: {
    provider: localStorage.getItem('cc_ai_provider') || 'claude', // claude|openai|gemini
    claudeKey: localStorage.getItem('cc_key') || '',
    openaiKey: localStorage.getItem('cc_openai_key') || '',
    geminiKey: localStorage.getItem('cc_gemini_key') || '',
    claudeModel: 'claude-haiku-4-5-20251001',
    openaiModel: localStorage.getItem('cc_openai_model') || 'gpt-4o-mini',
    geminiModel: 'gemini-1.5-flash',
  },
  // Data retention settings
  retention: {
    days: parseInt(localStorage.getItem('cc_retention_days') || '365'),
    autoDelete: localStorage.getItem('cc_auto_delete') !== 'false',
    lastCleanup: localStorage.getItem('cc_last_cleanup') || null,
  },
  // De-identification rules
  deid: {
    blockedFields: ['name','fullname','id_card','phone','address','email','birth_exact'],
    hashSalt: localStorage.getItem('cc_hash_salt') || (() => {
      const s = Math.random().toString(36).slice(2);
      localStorage.setItem('cc_hash_salt', s);
      return s;
    })(),
  },
  save() {
    localStorage.setItem('cc_ai_provider', this.ai.provider);
    localStorage.setItem('cc_openai_model', this.ai.openaiModel);
    localStorage.setItem('cc_retention_days', this.retention.days);
    localStorage.setItem('cc_auto_delete', this.retention.autoDelete);
  }
};

// â”€â”€â”€ MODULE: AIProvider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ClinCalc.AI = {
  // Unified AI call â€” dispatches to correct provider
  async call(prompt, maxTokens = 1000, opts = {}) {
    const cfg = ClinCalc.Config.ai;
    const provider = opts.provider || cfg.provider;
    switch(provider) {
      case 'openai':  return await this._callOpenAI(prompt, maxTokens, opts);
      case 'gemini':  return await this._callGemini(prompt, maxTokens, opts);
      case 'supabase': return await this._callSupabaseAI(prompt, maxTokens, opts);
      default:        return await this._callClaude(prompt, maxTokens, opts);
    }
  },

  // â”€â”€ Claude (Anthropic) â”€â”€
  async _callClaude(prompt, maxTokens, opts) {
    const key = opts.key || ClinCalc.Config.ai.claudeKey;
    if (!key) throw new Error('æœªè¨­å®š Anthropic API Key');
    const model = opts.model || ClinCalc.Config.ai.claudeModel;
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01' },
      body: JSON.stringify({ model, max_tokens: maxTokens, messages:[{role:'user',content:prompt}] })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || `Anthropic ${res.status}`); }
    return (await res.json()).content?.[0]?.text || '';
  },

  // â”€â”€ OpenAI (GPT) â”€â”€
  async _callOpenAI(prompt, maxTokens, opts) {
    const key = opts.key || ClinCalc.Config.ai.openaiKey;
    if (!key) throw new Error('æœªè¨­å®š OpenAI API Key');
    const model = opts.model || ClinCalc.Config.ai.openaiModel;
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type':'application/json','Authorization':`Bearer ${key}` },
      body: JSON.stringify({ model, max_tokens: maxTokens, messages:[{role:'user',content:prompt}] })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || `OpenAI ${res.status}`); }
    return (await res.json()).choices?.[0]?.message?.content || '';
  },

  // â”€â”€ Google Gemini â”€â”€
  async _callGemini(prompt, maxTokens, opts) {
    const key = opts.key || ClinCalc.Config.ai.geminiKey;
    if (!key) throw new Error('æœªè¨­å®š Google AI Studio API Key');
    const model = opts.model || ClinCalc.Config.ai.geminiModel;
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:maxTokens} })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || `Gemini ${res.status}`); }
    return (await res.json()).candidates?.[0]?.content?.parts?.[0]?.text || '';
  },

  // â”€â”€ Supabase AI (pgvector + pg_cron + edge functions â€” FREE) â”€â”€
  async _callSupabaseAI(prompt, maxTokens, opts) {
    if (!sbUrl || !sbKey) throw new Error('è«‹å…ˆè¨­å®š Supabase é€£ç·š');
    // Call Supabase Edge Function named "ai-analyze"
    const res = await fetch(`${sbUrl}/functions/v1/ai-analyze`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json','Authorization':`Bearer ${sbKey}` },
      body: JSON.stringify({ prompt, max_tokens: maxTokens })
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Supabase AI: ${res.status} â€” ${txt.slice(0,200)}`);
    }
    const data = await res.json();
    return data.result || data.text || data.content || JSON.stringify(data);
  },

  // â”€â”€ Test connection for any provider â”€â”€
  async test(provider, key) {
    const testPrompt = 'è«‹å›è¦†æ•¸å­—1ï¼Œä¸è¦å…¶ä»–å…§å®¹ã€‚';
    try {
      const result = await this.call(testPrompt, 20, { provider, key });
      return { ok: true, result };
    } catch(e) {
      return { ok: false, error: e.message };
    }
  },

  // â”€â”€ Get provider display info â”€â”€
  getProviderInfo(p) {
    const map = {
      claude:   { name:'Claude (Anthropic)', icon:'ğŸ¤–', color:'var(--teal)',    model:'Haiku 4.5 / Sonnet 4' },
      openai:   { name:'GPT (OpenAI)',       icon:'âš¡', color:'var(--emerald)', model:'GPT-4o-mini / GPT-4o' },
      gemini:   { name:'Gemini (Google)',    icon:'âœ¨', color:'var(--amber)',   model:'Gemini 1.5 Flash (å…è²»)' },
      supabase: { name:'Supabase AI',        icon:'ğŸ—„ï¸', color:'var(--sky)',     model:'å…è²» Edge Function + llama/mistral' },
    };
    return map[p] || map.claude;
  }
};

// â”€â”€â”€ MODULE: DeID (å»è­˜åˆ¥åŒ–å¼•æ“) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ClinCalc.DeID = {
  // Fields that must NEVER be stored
  BLOCKED: ['pid_name','full_name','id_number','phone','mobile','address','email',
            'line_id','birth_full','passport','insurance_id'],

  // Simple pseudonymization hash (not cryptographic, just obfuscation)
  pseudonymize(value) {
    if (!value) return null;
    const str = String(value) + ClinCalc.Config.deid.hashSalt;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return 'P' + Math.abs(hash).toString(36).toUpperCase().slice(0, 8);
  },

  // Sanitize a data object â€” removes blocked fields, pseudonymizes PID
  sanitize(rawData) {
    const safe = {};
    const blocked = this.BLOCKED;

    for (const [k, v] of Object.entries(rawData)) {
      // Skip completely blocked fields
      if (blocked.includes(k)) {
        console.warn(`[DeID] å·²ç§»é™¤æ¬„ä½: ${k}`);
        continue;
      }
      // Pseudonymize patient ID (keep for record matching but not re-identifiable)
      if (k === 'pid') {
        safe['pid_hash'] = this.pseudonymize(v);
        safe['pid_display'] = v ? v.slice(0,2) + '***' : null; // e.g. "20***"
        continue;
      }
      // Keep only numeric/enum/date values (not free-text that might contain PII)
      if (k === 'note' || k === 'doctor') {
        safe[k] = v ? '[å·²éæ¿¾è‡ªç”±æ–‡å­—]' : null;
        continue;
      }
      safe[k] = v;
    }
    safe['_deid_version'] = '1.0';
    safe['_sanitized_at'] = new Date().toISOString();
    return safe;
  },

  // Check if data object contains potential PII
  audit(dataObj) {
    const warnings = [];
    const piiPatterns = [
      { key: 'pid', pattern: /[^\d]/, msg: 'ç—…æ‚£IDå«éæ•¸å­—å­—å…ƒï¼ˆå¯èƒ½å«å§“åï¼‰' },
      { key: 'note', pattern: /.{1}/, msg: 'å‚™è¨»æ¬„ä½å«è‡ªç”±æ–‡å­—ï¼ˆå¯èƒ½å«PIIï¼‰' },
    ];
    for (const { key, pattern, msg } of piiPatterns) {
      if (dataObj[key] && pattern.test(String(dataObj[key]))) {
        warnings.push(msg);
      }
    }
    return warnings;
  },

  // Return a summary of what was removed
  diff(original, sanitized) {
    const removed = Object.keys(original).filter(k => !(k in sanitized) && !['pid'].includes(k));
    const modified = Object.keys(sanitized).filter(k => sanitized[k] !== original[k] && k in original);
    return { removed, modified };
  }
};

// â”€â”€â”€ MODULE: DataRetention â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ClinCalc.Retention = {
  get days() { return ClinCalc.Config.retention.days; },

  // Get expiry date for a record
  getExpiry(createdAt) {
    const d = new Date(createdAt || Date.now());
    d.setDate(d.getDate() + this.days);
    return d;
  },

  // Check if record is expired
  isExpired(createdAt) {
    return new Date() > this.getExpiry(createdAt);
  },

  // Purge expired localStorage drafts
  purgeLocalDrafts() {
    const drafts = JSON.parse(localStorage.getItem('cc_drafts') || '[]');
    const before = drafts.length;
    const alive = drafts.filter(d => !this.isExpired(d.saved_at));
    localStorage.setItem('cc_drafts', JSON.stringify(alive));
    return { before, after: alive.length, deleted: before - alive.length };
  },

  // Get records expiring soon (within 7 days)
  getExpiringSoon() {
    const drafts = JSON.parse(localStorage.getItem('cc_drafts') || '[]');
    const soon = new Date(Date.now() + 7 * 864e5);
    return drafts.filter(d => {
      const exp = this.getExpiry(d.saved_at);
      return exp > new Date() && exp < soon;
    });
  },

  // Build DELETE SQL for Supabase (to be run manually or via pg_cron)
  buildSupabaseCleanupSQL(tableName = 'patients') {
    return `-- è³‡æ–™ä¿ç•™æ”¿ç­–ï¼šåˆªé™¤è¶…é ${this.days} å¤©çš„è¨˜éŒ„
DELETE FROM ${tableName}
WHERE created_at < NOW() - INTERVAL '${this.days} days';

-- ï¼ˆé¸ç”¨ï¼‰è¨­å®š pg_cron æ¯æ—¥è‡ªå‹•æ¸…ç†
-- SELECT cron.schedule('cleanup-old-records', '0 2 * * *',
--   $$ DELETE FROM ${tableName} WHERE created_at < NOW() - INTERVAL '${this.days} days' $$);`;
  },

  // Format retention info for display
  formatStatus() {
    const exp = this.getExpiringSoon();
    return {
      days: this.days,
      autoDelete: ClinCalc.Config.retention.autoDelete,
      expiringSoon: exp.length,
      expiryDate: this.getExpiry(new Date()).toLocaleDateString('zh-TW'),
    };
  }
};

// â”€â”€â”€ MODULE: SupabaseAI (å…è²» AI â€” Edge Functions) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ClinCalc.SupabaseAI = {
  // Edge Function code to deploy (shown in tutorial)
  getEdgeFunctionCode() {
    return `// supabase/functions/ai-analyze/index.ts
// Deploy with: supabase functions deploy ai-analyze
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const ALLOWED_ORIGINS = ["*"]; // æ­£å¼ç’°å¢ƒè«‹é™åˆ¶ä¾†æº

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, {
      headers: { "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Headers": "authorization, content-type" }
    });
  }
  
  const { prompt, max_tokens = 500 } = await req.json();
  
  // ä½¿ç”¨ Supabase å…§å»ºçš„ AI (pg_embedding / Ollama)
  // æˆ–å‘¼å« Groq APIï¼ˆå…è²»æ–¹æ¡ˆï¼‰
  const GROQ_KEY = Deno.env.get("GROQ_API_KEY"); // è¨­å®šåœ¨ Supabase secrets
  
  if (GROQ_KEY) {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": \`Bearer \${GROQ_KEY}\`,
                 "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama-3.1-8b-instant", // å…è²»å¿«é€Ÿæ¨¡å‹
        messages: [{ role: "user", content: prompt }],
        max_tokens
      })
    });
    const data = await res.json();
    return new Response(
      JSON.stringify({ result: data.choices?.[0]?.message?.content }),
      { headers: { "Content-Type": "application/json",
                   "Access-Control-Allow-Origin": "*" } }
    );
  }
  
  return new Response(
    JSON.stringify({ error: "è«‹è¨­å®š GROQ_API_KEY ç’°å¢ƒè®Šæ•¸" }),
    { status: 500, headers: { "Content-Type": "application/json",
                               "Access-Control-Allow-Origin": "*" } }
  );
});`;
  },

  async test() {
    if (!sbUrl || !sbKey) return { ok: false, error: 'æœªè¨­å®š Supabase é€£ç·š' };
    try {
      const r = await fetch(`${sbUrl}/functions/v1/ai-analyze`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json','Authorization':`Bearer ${sbKey}` },
        body: JSON.stringify({ prompt: 'å›è¦†ï¼šOK', max_tokens: 10 })
      });
      if (r.ok) { return { ok: true }; }
      return { ok: false, error: `${r.status} â€” è«‹å…ˆéƒ¨ç½² Edge Function` };
    } catch(e) {
      return { ok: false, error: e.message };
    }
  }
};

// â”€â”€â”€ MODULE: ComponentRegistry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ClinCalc.Components = {
  // Registry of all components and their initialization functions
  _registry: {},
  register(name, initFn) { this._registry[name] = initFn; },
  init(name) {
    if (this._registry[name]) this._registry[name]();
    else console.warn(`Component "${name}" not registered`);
  },
  initAll() {
    Object.entries(this._registry).forEach(([name, fn]) => {
      try { fn(); } catch(e) { console.warn(`Component ${name} init failed:`, e); }
    });
  }
};

// â”€â”€â”€ MODULE: UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ClinCalc.UI = {
  // Render AI provider selector badge
  renderProviderBadge(containerId) {
    const el = document.getElementById(containerId);
    if (!el) return;
    const p = ClinCalc.Config.ai.provider;
    const info = ClinCalc.AI.getProviderInfo(p);
    el.innerHTML = `<div style="display:inline-flex;align-items:center;gap:6px;padding:4px 12px;
      border-radius:100px;font-family:var(--ff-m);font-size:10px;
      background:rgba(0,0,0,.3);border:1px solid;border-color:${info.color}33;color:${info.color};">
      ${info.icon} ${info.name} Â· ${info.model}
    </div>`;
  },

  // Render retention status pill
  renderRetentionPill(containerId) {
    const el = document.getElementById(containerId);
    if (!el) return;
    const s = ClinCalc.Retention.formatStatus();
    el.innerHTML = `<span style="font-family:var(--ff-m);font-size:10px;color:var(--amber);">
      ğŸ—‘ï¸ è³‡æ–™ä¿ç•™ï¼š${s.days}å¤© Â· è‡ªå‹•åˆªé™¤ï¼š${s.autoDelete?'âœ“':'âœ—'}
      ${s.expiringSoon > 0 ? `Â· âš ï¸ ${s.expiringSoon}ç­†å³å°‡éæœŸ` : ''}
    </span>`;
  }
};

// â”€â”€â”€ Initialize App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.CC = ClinCalc; // shorthand


// â”€â”€â”€ NAV â”€â”€â”€
function showSec(id){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(t=>t.classList.remove('on'));
  const s=document.getElementById('s-'+id);if(s){s.classList.add('on');window.scrollTo(0,0);}
  document.querySelectorAll('.ntab').forEach(t=>{if((t.getAttribute('onclick')||'').includes("'"+id+"'"))t.classList.add('on');});
}
function goDr(){if(!isDoctor){document.getElementById('modal-login').classList.add('on');setTimeout(()=>document.getElementById('dr_pwd').focus(),80);}else{showSec('dr');}}
function showCalc(id){
  showSec('calc');
  document.querySelectorAll('.cp').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.ctab').forEach(t=>t.classList.remove('on'));
  const p=document.getElementById('cp-'+id);if(p)p.classList.add('on');
  document.querySelectorAll('.ctab').forEach(t=>{if((t.getAttribute('onclick')||'').includes("'"+id+"'"))t.classList.add('on');});
}
function showDRTab(id){
  const tabOrder=['api','supabase','privacy'];
  document.querySelectorAll('#s-dr .dbtab').forEach((t,i)=>{t.classList.toggle('on',tabOrder[i]===id);});
  document.querySelectorAll('#s-dr .dbp:not([id^="dbt"])').forEach(p=>p.classList.remove('on'));
  const p=document.getElementById('drt-'+id);if(p){p.classList.add('on');}
  if(id==='api') setTimeout(renderProviderUI, 50);
  if(id==='privacy') setTimeout(initPrivacyTab, 50);
}

// â”€â”€â”€ PROVIDER UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectProvider(prov){
  ClinCalc.Config.ai.provider = prov;
  renderProviderUI();
  ClinCalc.UI.renderProviderBadge('provider-badge-dr');
}

function renderProviderUI(){
  const p = ClinCalc.Config.ai.provider;
  ['claude','openai','gemini','supabase'].forEach(id=>{
    const el = document.getElementById('pc-'+id);
    if(el) el.classList.toggle('active', id===p);
  });
  const fieldsDiv = document.getElementById('provider-fields');
  if(!fieldsDiv) return;
  const info = ClinCalc.AI.getProviderInfo(p);
  const templates = {
    claude: `<div class="pf-section"><div class="pf-label">Anthropic Claude è¨­å®š</div>
      <div class="g2">
        <div class="fg"><label class="fl">API Key</label>
          <input type="password" class="fi" id="key_claude" placeholder="sk-ant-..." value="${ClinCalc.Config.ai.claudeKey}">
          <div class="hint">å–å¾—ï¼š<a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--teal);">console.anthropic.com</a>ï½œå…è²» 5$/æœˆé¡åº¦</div></div>
        <div class="fg"><label class="fl">æ¨¡å‹</label>
          <select class="fsel" id="model_claude">
            <option value="claude-haiku-4-5-20251001" ${ClinCalc.Config.ai.claudeModel==='claude-haiku-4-5-20251001'?'selected':''}>Claude Haiku 4.5ï¼ˆé€Ÿåº¦å¿«ã€è²»ç”¨ä½ï¼‰</option>
            <option value="claude-sonnet-4-20250514" ${ClinCalc.Config.ai.claudeModel==='claude-sonnet-4-20250514'?'selected':''}>Claude Sonnet 4ï¼ˆæ™ºèƒ½å¼·ï¼‰</option>
          </select></div>
      </div></div>`,
    openai: `<div class="pf-section"><div class="pf-label">OpenAI GPT è¨­å®š</div>
      <div class="g2">
        <div class="fg"><label class="fl">API Key</label>
          <input type="password" class="fi" id="key_openai" placeholder="sk-..." value="${ClinCalc.Config.ai.openaiKey}">
          <div class="hint">å–å¾—ï¼š<a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--teal);">platform.openai.com</a>ï½œéœ€ç¶å®šä¿¡ç”¨å¡</div></div>
        <div class="fg"><label class="fl">æ¨¡å‹</label>
          <select class="fsel" id="model_openai">
            <option value="gpt-4o-mini" ${ClinCalc.Config.ai.openaiModel==='gpt-4o-mini'?'selected':''}>GPT-4o-miniï¼ˆè²»ç”¨ä½ã€é€Ÿåº¦å¿«ï¼‰</option>
            <option value="gpt-4o" ${ClinCalc.Config.ai.openaiModel==='gpt-4o'?'selected':''}>GPT-4oï¼ˆæœ€é«˜æ™ºèƒ½ï¼‰</option>
            <option value="gpt-3.5-turbo" ${ClinCalc.Config.ai.openaiModel==='gpt-3.5-turbo'?'selected':''}>GPT-3.5 Turboï¼ˆæœ€ä¾¿å®œï¼‰</option>
          </select></div>
      </div></div>`,
    gemini: `<div class="pf-section"><div class="pf-label">Google Gemini è¨­å®šï¼ˆAI Studioï¼‰</div>
      <div class="g2">
        <div class="fg"><label class="fl">API Key</label>
          <input type="password" class="fi" id="key_gemini" placeholder="AIza..." value="${ClinCalc.Config.ai.geminiKey}">
          <div class="hint">å–å¾—ï¼š<a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--teal);">aistudio.google.com</a>ï½œå…è²» 60 req/min</div></div>
        <div class="fg"><label class="fl">æ¨¡å‹</label>
          <select class="fsel" id="model_gemini">
            <option value="gemini-1.5-flash">Gemini 1.5 Flashï¼ˆå…è²»ã€é€Ÿåº¦å¿«ï¼‰</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Proï¼ˆæ›´å¼·ï¼Œæœ‰ç”¨é‡é™åˆ¶ï¼‰</option>
            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Expï¼ˆæœ€æ–°å¯¦é©—ç‰ˆï¼‰</option>
          </select></div>
      </div>
      <div class="al ag" style="margin-top:8px;">âœ… Gemini 1.5 Flash å®Œå…¨å…è²»ï¼šæ¯åˆ†é˜ 15 æ¬¡ã€æ¯æ—¥ 1,500 æ¬¡ã€‚</div></div>`,
    supabase: `<div class="pf-section"><div class="pf-label">Supabase AIï¼ˆå…è²» Edge Function + Groq Llamaï¼‰</div>
      <div class="al ai" style="margin-bottom:10px;">âš™ï¸ éœ€å…ˆå®Œæˆã€Œéš±ç§è¨­å®šã€é ç±¤ä¸­çš„ Edge Function éƒ¨ç½²ï¼Œä¸¦åœ¨ Supabase Secrets è¨­å®š GROQ_API_KEYã€‚</div>
      <div class="al ag">âœ… å®Œå…¨å…è²»ï¼šGroq å…è²»æ–¹æ¡ˆ / Llama 3.1 8Bã€‚è³‡æ–™ä¸é›¢é–‹æ‚¨çš„ Supabase ç’°å¢ƒã€‚</div></div>`,
  };
  fieldsDiv.innerHTML = templates[p] || templates.claude;
}

function saveAllProviderSettings(){
  const p = ClinCalc.Config.ai.provider;
  const claudeKeyEl = document.getElementById('key_claude');
  const openaiKeyEl = document.getElementById('key_openai');
  const geminiKeyEl = document.getElementById('key_gemini');
  if(claudeKeyEl?.value){ClinCalc.Config.ai.claudeKey=claudeKeyEl.value;localStorage.setItem('cc_key',claudeKeyEl.value);document.getElementById('dr_api').value=claudeKeyEl.value;const ak=document.getElementById('ai_key');if(ak)ak.value=claudeKeyEl.value;}
  if(openaiKeyEl?.value){ClinCalc.Config.ai.openaiKey=openaiKeyEl.value;localStorage.setItem('cc_openai_key',openaiKeyEl.value);}
  if(geminiKeyEl?.value){ClinCalc.Config.ai.geminiKey=geminiKeyEl.value;localStorage.setItem('cc_gemini_key',geminiKeyEl.value);}
  const modelEl=document.getElementById('model_'+p);
  if(modelEl){if(p==='claude')ClinCalc.Config.ai.claudeModel=modelEl.value;if(p==='openai')ClinCalc.Config.ai.openaiModel=modelEl.value;}
  ClinCalc.Config.save();
  ClinCalc.UI.renderProviderBadge('provider-badge-dr');
  alert('âœ“ AI è¨­å®šå·²å„²å­˜');
}

async function testCurrentProvider(){
  const p=ClinCalc.Config.ai.provider;
  const statusEl=document.getElementById('provider-test-status');
  statusEl.innerHTML=`<div class="al ai">â³ æ¸¬è©¦ ${ClinCalc.AI.getProviderInfo(p).name}...</div>`;
  const keyEl=document.getElementById('key_'+p);
  const key=keyEl?keyEl.value:ClinCalc.Config.ai[p+'Key']||'';
  const result=await ClinCalc.AI.test(p,key);
  if(result.ok){
    statusEl.innerHTML=`<div class="al ag">âœ… ${ClinCalc.AI.getProviderInfo(p).name} é€£ç·šæˆåŠŸï¼AI åŠŸèƒ½å·²å¯ç”¨ã€‚</div>`;
    if(p==='claude')setAILocked(false);
  }else{statusEl.innerHTML=`<div class="al ar">âŒ ${result.error}</div>`;}
}

// â”€â”€â”€ PRIVACY TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initPrivacyTab(){
  const daysEl=document.getElementById('retention_days');
  if(daysEl)daysEl.value=ClinCalc.Config.retention.days;
  const actionEl=document.getElementById('retention_action');
  if(actionEl)actionEl.value=ClinCalc.Config.retention.autoDelete?'auto_delete':'notify';
  const codeEl=document.getElementById('edge-fn-code');
  if(codeEl)codeEl.textContent=ClinCalc.SupabaseAI.getEdgeFunctionCode();
  updateRetentionPreview();
}

function updateRetentionPreview(){
  const days=parseInt(document.getElementById('retention_days')?.value||365);
  const action=document.getElementById('retention_action')?.value||'auto_delete';
  const expiry=new Date();expiry.setDate(expiry.getDate()+days);
  const el=document.getElementById('retention-preview');
  if(el)el.innerHTML=`â„¹ï¸ ä»Šæ—¥èµ·æ–°å¢çš„è¨˜éŒ„å°‡æ–¼ <strong>${expiry.toLocaleDateString('zh-TW')}</strong>ï¼ˆ${days}å¤©å¾Œï¼‰${action==='auto_delete'?'è‡ªå‹•åˆªé™¤':action==='notify'?'ç™¼å‡ºåˆ°æœŸæé†’':'å°å­˜'}ã€‚`;
}

function saveRetentionSettings(){
  const days=parseInt(document.getElementById('retention_days')?.value||365);
  const action=document.getElementById('retention_action')?.value||'auto_delete';
  if(days<30||days>3650){alert('ä¿ç•™å¤©æ•¸éœ€åœ¨ 30-3650 å¤©ä¹‹é–“');return;}
  ClinCalc.Config.retention.days=days;
  ClinCalc.Config.retention.autoDelete=action==='auto_delete';
  ClinCalc.Config.save();
  alert(`âœ“ å·²è¨­å®šï¼šè³‡æ–™ä¿ç•™ ${days} å¤©`);
}

function runLocalPurge(){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤æœ¬æ©Ÿæ‰€æœ‰éæœŸè¨˜éŒ„ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸã€‚'))return;
  const result=ClinCalc.Retention.purgeLocalDrafts();
  const el=document.getElementById('retention-purge-result');
  if(el)el.innerHTML=`<div class="al ag">ğŸ§¹ æ¸…ç†å®Œæˆï¼šåˆªé™¤ ${result.deleted} ç­†ï¼Œå‰©é¤˜ ${result.after} ç­†æœ‰æ•ˆè¨˜éŒ„ã€‚</div>`;
}

function showRetentionSQL(){
  const sql=ClinCalc.Retention.buildSupabaseCleanupSQL();
  document.getElementById('detail-content').innerHTML=`<div style="font-family:var(--ff-h);font-size:18px;font-weight:700;margin-bottom:12px;">Supabase è³‡æ–™ä¿ç•™æ¸…ç† SQL</div>
    <div class="al ay" style="margin-bottom:12px;">âš ï¸ è«‹åœ¨ Supabase SQL Editor åŸ·è¡Œï¼Œæˆ–è¨­å®š pg_cron å®šæ™‚è‡ªå‹•åŸ·è¡Œã€‚</div>
    <pre style="font-family:var(--ff-m);font-size:11px;color:#a5f3fc;background:var(--c0);padding:14px;border-radius:8px;overflow:auto;line-height:1.65;">${sql}</pre>
    <button class="btn bs" style="margin-top:12px;" onclick="navigator.clipboard.writeText(decodeURIComponent('${encodeURIComponent(sql)}')).then(()=>alert('âœ“ å·²è¤‡è£½'))">è¤‡è£½ SQL</button>`;
  document.getElementById('modal-detail').classList.add('on');
}

function runDeIDPreview(){
  const input=document.getElementById('audit_input')?.value;
  if(!input){alert('è«‹å…ˆå¡«å…¥è³‡æ–™');return;}
  let data;try{data=JSON.parse(input);}catch(e){alert('JSON æ ¼å¼éŒ¯èª¤ï¼š'+e.message);return;}
  const sanitized=ClinCalc.DeID.sanitize(data);
  const diff=ClinCalc.DeID.diff(data,sanitized);
  const warnings=ClinCalc.DeID.audit(data);
  const el=document.getElementById('deid-preview-result');
  el.innerHTML=`<div class="al ag" style="margin-bottom:8px;">âœ… å»è­˜åˆ¥åŒ–å®Œæˆ Â· ç§»é™¤ ${diff.removed.length} å€‹æ¬„ä½ Â· ä¿®æ”¹ ${diff.modified.length} å€‹æ¬„ä½</div>
    ${diff.removed.length?`<div class="al ar" style="margin-bottom:8px;">ğŸš« å·²ç§»é™¤ï¼š${diff.removed.join(', ')}</div>`:''}
    ${diff.modified.length?`<div class="al ay" style="margin-bottom:8px;">âš ï¸ å·²å‡ååŒ–ï¼š${diff.modified.join(', ')}</div>`:''}
    ${warnings.length?`<div class="al ay" style="margin-bottom:8px;">âš ï¸ æ½›åœ¨ PIIï¼š${warnings.join(' | ')}</div>`:''}
    <details style="margin-top:8px;"><summary style="font-family:var(--ff-m);font-size:11px;color:var(--teal);cursor:pointer;">æŸ¥çœ‹å»è­˜åˆ¥åŒ–å¾Œè³‡æ–™</summary>
    <pre style="font-family:var(--ff-m);font-size:10px;color:var(--t2);background:var(--c2);padding:12px;border-radius:6px;overflow:auto;max-height:300px;margin-top:8px;">${JSON.stringify(sanitized,null,2)}</pre></details>`;
}

async function testSupabaseAI(){
  const statusEl=document.getElementById('supabase-ai-status');
  statusEl.innerHTML='<div class="al ai">â³ æ¸¬è©¦ Supabase AI...</div>';
  const result=await ClinCalc.SupabaseAI.test();
  statusEl.innerHTML=result.ok?'<div class="al ag">âœ… Supabase AI Edge Function é€£ç·šæˆåŠŸï¼å¯åˆ‡æ›ä½¿ç”¨å…è²» AI åˆ†æã€‚</div>':`<div class="al ar">âŒ ${result.error}</div>`;
}

function copyEdgeFunction(){
  const code=ClinCalc.SupabaseAI.getEdgeFunctionCode();
  navigator.clipboard.writeText(code).then(()=>alert('âœ“ Edge Function ç¨‹å¼ç¢¼å·²è¤‡è£½'));
}
function showDBTab(id){
  document.querySelectorAll('#dbt-records,#dbt-refs,#dbt-custom').forEach(p=>p.classList.remove('on'));
  const p=document.getElementById('dbt-'+id);if(p)p.classList.add('on');
  if(id==='refs')renderRefs();
  if(id==='records')loadRecords();
  if(id==='custom')renderCustom();
  // fix tabs
  document.querySelectorAll('[onclick*="showDBTab"]').forEach(t=>t.classList.toggle('on',(t.getAttribute('onclick')||'').includes("'"+id+"'")));
}

// â”€â”€â”€ MODAL â”€â”€â”€
function closeModal(){document.getElementById('modal-login').classList.remove('on');document.getElementById('dr_pwd').value='';document.getElementById('login-err').style.display='none';}
function doLogin(){
  if(document.getElementById('dr_pwd').value===DR_PWD){
    isDoctor=true;closeModal();
    document.getElementById('drBtn').innerHTML='<span class="dpulse"></span>é†«å¸«æ¨¡å¼';
    document.getElementById('drBtn').classList.add('on');
    showSec('dr');
    loadStoredSB();
  }else{document.getElementById('login-err').style.display='flex';}
}

// â”€â”€â”€ LOADER â”€â”€â”€
function showLoad(t){document.getElementById('loader-txt').textContent=t||'è¨ˆç®—ä¸­...';document.getElementById('loader').classList.add('on');}
function hideLoad(){document.getElementById('loader').classList.remove('on');}

// â”€â”€â”€ HELPERS â”€â”€â”€
function v(id){const e=document.getElementById(id);return e?parseFloat(e.value)||0:0;}
function sv(id){const e=document.getElementById(id);return e?e.value:'';}
function rv(n){const e=document.querySelector(`input[name="${n}"]:checked`);return e?e.value:'';}
function fmt(n,d=1){return isNaN(n)||n===null?'â€”':Number(n).toFixed(d);}
function pct(n){return isNaN(n)||n===null?'â€”':(n*100).toFixed(1)+'%';}
function cell(l,val,cls='',sub=''){return`<div class="rcell"><div class="rl">${l}</div><div class="rv ${cls}">${val}</div>${sub?`<div class="rs">${sub}</div>`:''}</div>`;}
function al(t,txt){return`<div class="al ${t}">${txt}</div>`;}
function clr(id){
  document.querySelectorAll(`#cp-${id} .fi`).forEach(e=>e.value='');
  document.querySelectorAll(`#cp-${id} .fsel`).forEach(e=>e.selectedIndex=0);
  const rp=document.getElementById(`rp-${id}`);if(rp)rp.classList.remove('on');
}

// â”€â”€â”€ eGFR â”€â”€â”€
function calcEGFR(cr,age,sex){
  if(!cr||!age)return null;
  if(sex==='female'){const k=0.7,a=-0.241;return 142*Math.pow(Math.min(cr/k,1),a)*Math.pow(Math.max(cr/k,1),-1.200)*Math.pow(0.9938,age)*1.012;}
  const k=0.9,a=-0.302;return 142*Math.pow(Math.min(cr/k,1),a)*Math.pow(Math.max(cr/k,1),-1.200)*Math.pow(0.9938,age);
}
function getStage(e){
  if(e>=90)return{s:'G1ï¼ˆæ­£å¸¸æˆ–é«˜ï¼‰',k:'g1',c:'ct'};
  if(e>=60)return{s:'G2ï¼ˆè¼•åº¦ä¸‹é™ï¼‰',k:'g2',c:'ct'};
  if(e>=45)return{s:'G3aï¼ˆè¼•ä¸­åº¦ï¼‰',k:'g3a',c:'ca'};
  if(e>=30)return{s:'G3bï¼ˆä¸­é‡åº¦ï¼‰',k:'g3b',c:'ca'};
  if(e>=15)return{s:'G4ï¼ˆé‡åº¦ï¼‰',k:'g4',c:'cr'};
  return{s:'G5ï¼ˆè…è¡°ç«­ï¼‰',k:'g5',c:'cr'};
}
function getAStage(u){
  if(!u)return{s:'æœªæä¾›',c:''};
  if(u>=300)return{s:'A3ï¼ˆåš´é‡ï¼‰',c:'cr'};
  if(u>=30)return{s:'A2ï¼ˆä¸­åº¦ï¼‰',c:'ca'};
  return{s:'A1ï¼ˆæ­£å¸¸ï¼‰',c:'ct'};
}

// â”€â”€â”€ CKD CALC â”€â”€â”€
function calcCKD(){
  const cr=v('ckd_cr'),age=v('ckd_age'),sex=rv('ckd_sex')||'female';
  if(!cr||!age){alert('è«‹è¼¸å…¥ Creatinine å’Œå¹´é½¡');return;}
  const egfr=calcEGFR(cr,age,sex);
  const {s:stage,k:sk,c:sc}=getStage(egfr);
  const uacr=v('ckd_uacr'),{s:aStage,c:ac}=getAStage(uacr);
  const k_=v('ckd_k'),na=v('ckd_na'),bun=v('ckd_bun'),ua=v('ckd_ua');
  const buncr=cr>0&&bun>0?bun/cr:null;
  document.getElementById('ckd_buncr').value=buncr?fmt(buncr,1):'';
  document.getElementById('r-egfr').innerHTML=`${fmt(egfr)} <span style="font-size:14px;opacity:.4;">mL/min/1.73mÂ²</span>`;
  document.getElementById('r-ckds').textContent=stage;
  ['g1','g2','g3a','g3b','g4','g5'].forEach(s=>{const el=document.getElementById('cs-'+s);if(el)el.style.opacity=s===sk?'1':'0.15';});
  let c=cell('eGFR',`${fmt(egfr,1)}`,sc,stage);
  c+=cell('UACR',uacr>0?`${uacr} mg/g`:'æœªæä¾›',ac,aStage);
  if(bun>0)c+=cell('BUN',`${bun} mg/dL`,bun>30?'ca':'ct',bun>30?'åé«˜':'');
  if(ua>0)c+=cell('å°¿é…¸',`${ua} mg/dL`,ua>7?'ca':'ct');
  if(k_>0)c+=cell('K+',`${k_} mEq/L`,k_>5.5?'cr':k_<3.5?'ca':'ct',k_>5.5?'âš ï¸é«˜è¡€é‰€':k_<3.5?'ä½è¡€é‰€':'');
  if(na>0)c+=cell('Na+',`${na} mEq/L`,na<135?'ca':na>145?'ca':'ct');
  if(buncr)c+=cell('BUN/Cr',fmt(buncr,1),buncr>20?'ca':'ct',buncr>20?'è…å‰æ€§ï¼Ÿ':'');
  document.getElementById('ckd-cells').innerHTML=c;
  let a='';
  if(egfr<15)a+=al('ar','âš ï¸ eGFR <15 (G5) â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œè©•ä¼°è…è‡Ÿæ›¿ä»£ç™‚æ³•');
  else if(egfr<30)a+=al('ar','âš ï¸ eGFR 15-29 (G4) â€” AI å»ºè­°å°±é†«ï¼Œè…è‡Ÿç§‘è½‰è¨º');
  else if(egfr<45)a+=al('ay','eGFR 30-44 (G3b) â€” å»ºè­°è…è‡Ÿç§‘è¿½è¹¤ï¼Œ3-6æœˆç›£æ¸¬');
  else a+=al('ag','âœ“ eGFR æ­£å¸¸æˆ–è¼•åº¦ç•°å¸¸ï¼Œå®šæœŸè¿½è¹¤');
  if(uacr>=300)a+=al('ar',`âš ï¸ UACR ${uacr} (A3) â€” AI å»ºè­°å°±é†«ï¼Œåš´é‡è›‹ç™½å°¿`);
  else if(uacr>=30)a+=al('ay',`UACR ${uacr} (A2) â€” è©•ä¼° ACEi/ARB`);
  if(k_>5.5)a+=al('ar',`âš ï¸ K+ ${k_} â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œé«˜è¡€é‰€`);
  document.getElementById('ckd-alerts').innerHTML=a;
  const riskMap={G1:['ä½','ä¸­','é«˜'],G2:['ä½','ä¸­','é«˜'],G3a:['ä¸­','é«˜','æ¥µé«˜'],G3b:['é«˜','æ¥µé«˜','æ¥µé«˜'],G4:['æ¥µé«˜','æ¥µé«˜','æ¥µé«˜'],G5:['æ¥µé«˜','æ¥µé«˜','æ¥µé«˜']};
  const rkc={'ä½':'ct','ä¸­':'ca','é«˜':'cr','æ¥µé«˜':'cr'};
  const gk=sk==='g1'?'G1':sk==='g2'?'G2':sk==='g3a'?'G3a':sk==='g3b'?'G3b':sk==='g4'?'G4':'G5';
  document.getElementById('ckd-rmat').innerHTML=Object.entries(riskMap).map(([g,r])=>`<tr style="${g===gk?'background:rgba(0,201,167,.05);':''}"><td>${g}</td>${r.map(x=>`<td class="${rkc[x]}">${x}</td>`).join('')}</tr>`).join('');
  document.getElementById('rp-ckd').classList.add('on');
  document.getElementById('rp-ckd').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ DM â”€â”€â”€
function calcDM(){
  const fpg=v('dm_fpg'),hba1c=v('dm_hba1c'),pp=v('dm_pp'),rg=v('dm_rg'),cgm=v('dm_cgm');
  const ins=v('dm_ins'),bmi=v('dm_bmi'),egfr_dm=v('dm_egfr');
  const hasSx=sv('dm_sx')==='yes',target=sv('dm_target');
  const homa=fpg>0&&ins>0?fpg*ins/405:null;
  if(homa)document.getElementById('dm_homa').value=fmt(homa,2);
  const gmi=cgm>0?3.31+0.02392*cgm:null;
  const dm_f=fpg>=126,dm_h=hba1c>=6.5,dm_p=pp>=200,dm_r=rg>=200&&hasSx;
  const pre_f=fpg>=100&&fpg<126,pre_h=hba1c>=5.7&&hba1c<6.5,pre_p=pp>=140&&pp<200;
  const dmc=[dm_f,dm_h,dm_p,dm_r].filter(Boolean).length,prc=[pre_f,pre_h,pre_p].filter(Boolean).length;
  let diag='è³‡æ–™ä¸è¶³',dc='cs',dsc='';
  if(dmc>=1){diag=dmc>=2||dm_r?'ç¬¦åˆç³–å°¿ç—…è¨ºæ–·':'å¯èƒ½ç³–å°¿ç—…ï¼ˆå»ºè­°è¤‡æŸ¥ï¼‰';dc='cr';dsc='ADA 2026ï¼šç„¡ç—‡ç‹€è€…éœ€å…©æ¬¡ç¨ç«‹ç•°å¸¸ç¢ºèª';}
  else if(prc>=1){diag='å‰æœŸç³–å°¿ç—…';dc='ca';dsc='å»ºè­°ç”Ÿæ´»å‹æ…‹ä»‹å…¥ï¼Œæ¯å¹´è¿½è¹¤';}
  else if(fpg>0||hba1c>0){diag='è¡€ç³–æ­£å¸¸ç¯„åœ';dc='ct';}
  document.getElementById('dm-main').innerHTML=`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;color:var(--teal);text-transform:uppercase;">ç³–å°¿ç—…è©•ä¼° Â· ADA 2026</div><div class="rbig ${dc}">${diag}</div><div style="font-size:12px;color:var(--t2);margin-top:4px;">${dsc}</div>`;
  let c='';
  if(fpg>0)c+=cell('FPG',`${fpg}`,dm_f?'cr':pre_f?'ca':'ct',dm_f?'ç³–å°¿ç—…':pre_f?'å‰æœŸ':'æ­£å¸¸');
  if(hba1c>0)c+=cell('HbA1c',`${hba1c}%`,dm_h?'cr':pre_h?'ca':'ct',dm_h?'ç³–å°¿ç—…':pre_h?'å‰æœŸ':'æ­£å¸¸');
  if(gmi)c+=cell('GMIä¼°ç®—',`${fmt(gmi,1)}%`,gmi>=6.5?'cr':'ct',`CGMå‡å€¼${cgm}mg/dL`);
  if(homa)c+=cell('HOMA-IR',fmt(homa,2),homa>2.5?'ca':'ct',homa>2.5?'èƒ°å³¶ç´ é˜»æŠ—â†‘':'');
  if(target&&hba1c>0){const gap=hba1c-parseFloat(target);c+=cell('HbA1cç›®æ¨™å·®',gap>0?`+${fmt(gap,1)}%`:gap<-1?`${fmt(gap,1)}%`:'é”æ¨™',gap>0.5?'ca':'ct');}
  if(bmi>0)c+=cell('BMI',`${bmi}`,bmi>=27.5?'ca':'ct',bmi>=27.5?'ADA:è€ƒæ…®GLP-1':'');
  if(egfr_dm>0)c+=cell('eGFR',`${egfr_dm}`,egfr_dm<60?'cr':'ct',egfr_dm<45?'Metforminæ…ç”¨':egfr_dm<60?'é™åŠ‘é‡è©•ä¼°':'');
  document.getElementById('dm-cells').innerHTML=c;
  let a='';
  if(hba1c>=10)a+=al('ar','âš ï¸ HbA1c â‰¥10% â€” AI å»ºè­°å°±é†«ï¼Œè¡€ç³–æ§åˆ¶æ¥µå·®');
  if(fpg>=200)a+=al('ar','âš ï¸ FPG â‰¥200 â€” AI å»ºè­°å°±é†«è©•ä¼°');
  if(dm_h||dm_f){if(bmi>=27.5)a+=al('ai','ğŸ“‹ ADA 2026ï¼šBMI â‰¥27.5 å¯å„ªå…ˆè€ƒæ…® GLP-1 RAï¼ˆå¦‚ Semaglutideï¼‰');a+=al('ai','ğŸ“‹ ADA 2026ï¼šè¨ºæ–·æ™‚å³è€ƒæ…® CGM ä½¿ç”¨ï¼Œè©•ä¼° SGLT2iï¼ˆCKDä¿è­·ï¼‰');}
  if(prc>=1)a+=al('ay','ğŸ’¡ å‰æœŸï¼šç”Ÿæ´»ä»‹å…¥å¯é™ä½ 50-60% é€²å±•ã€‚å»ºè­°é«”é‡æ¸› â‰¥7%ã€æ¯é€± â‰¥150 åˆ†é˜ä¸­å¼·åº¦é‹å‹•');
  if(homa>2.5)a+=al('ay','âš ï¸ HOMA-IR åé«˜ï¼Œèƒ°å³¶ç´ é˜»æŠ—ï¼Œå»ºè­°æ¸›é‡èˆ‡è©•ä¼° Metformin');
  document.getElementById('dm-alerts').innerHTML=a;
  document.getElementById('rp-dm').classList.add('on');
  document.getElementById('rp-dm').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ CV â”€â”€â”€
function calcCV(){
  const age=v('cv_age'),sex=rv('cv_sex')||'male';
  const tc=v('cv_tc'),hdl=v('cv_hdl'),ldl=v('cv_ldl'),tg=v('cv_tg');
  const sbp=v('cv_sbp'),dbp=v('cv_dbp'),waist=v('cv_waist'),crp=v('cv_crp');
  const smoke=sv('cv_smoke')==='yes',dm=sv('cv_dm')==='yes',htntx=sv('cv_htntx')==='yes';
  // auto pp and nhdl
  if(sbp&&dbp)document.getElementById('cv_pp').value=sbp-dbp;
  if(tc&&hdl)document.getElementById('cv_nhdl').value=tc-hdl;
  let ascvd=null;
  if(age>=40&&age<=79&&tc>0&&hdl>0&&sbp>0){
    const la=Math.log(age),lt=Math.log(tc),lh=Math.log(hdl),ls=Math.log(sbp);
    let sum,base;
    if(sex==='male'){sum=12.344*la+11.853*lt-2.664*la*lt-7.990*lh+1.769*la*lh+1.797*ls+(htntx?1.764:0)+(smoke?7.837:0)-1.795*la*(smoke?1:0)+(dm?0.658:0)-61.18;base=0.9144;}
    else{sum=-29.799*la+4.884*la*la+13.540*lt-3.114*la*lt-13.578*lh+3.149*la*lh+2.019*ls+(htntx?1.957:0)+(smoke?7.574:0)-1.665*la*(smoke?1:0)+(dm?0.661:0)+29.799;base=0.9665;}
    ascvd=Math.max(0,Math.min(100,(1-Math.pow(base,Math.exp(sum)))*100));
  }
  const ms_w=waist>0&&(sex==='male'?waist>=90:waist>=80);
  const ms_t=tg>=150,ms_h=hdl>0&&(sex==='male'?hdl<40:hdl<50),ms_b=sbp>=130||dbp>=85,ms_d=dm;
  const msc=[ms_w,ms_t,ms_h,ms_b,ms_d].filter(Boolean).length;
  let bpc='',bpcc='ct';
  if(sbp>180||dbp>120){bpc='é«˜è¡€å£“å±è±¡';bpcc='cr';}
  else if(sbp>=140||dbp>=90){bpc='é«˜è¡€å£“äºŒæœŸ';bpcc='cr';}
  else if(sbp>=130){bpc='é«˜è¡€å£“ä¸€æœŸ';bpcc='ca';}
  else if(sbp>=120){bpc='è¡€å£“åé«˜';bpcc='ca';}
  else if(sbp>0){bpc='æ­£å¸¸';bpcc='ct';}
  const riskLvl=ascvd===null?'':ascvd>=20?'æ¥µé«˜å±':ascvd>=7.5?'é«˜å±':ascvd>=5?'ä¸­å±':'ä½å±';
  document.getElementById('cv-main').innerHTML=`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;color:var(--teal);text-transform:uppercase;">ASCVD 10å¹´é¢¨éšª (PCE)</div><div class="rbig ${ascvd===null?'cs':ascvd>=7.5?'cr':'ct'}">${ascvd!==null?fmt(ascvd,1)+'%':'è³‡æ–™ä¸è¶³ï¼ˆéœ€TC/HDL/SBPï¼Œå¹´é½¡40-79ï¼‰'}</div><div style="font-size:12px;color:var(--t2);margin-top:4px;">${riskLvl}</div>`;
  let c='';
  if(ascvd!==null)c+=cell('ASCVD',`${fmt(ascvd,1)}%`,ascvd>=7.5?'cr':'ct',riskLvl);
  if(sbp>0)c+=cell('è¡€å£“',`${sbp}/${dbp}`,bpcc,bpc);
  if(ldl>0)c+=cell('LDL',`${ldl} mg/dL`,ldl>=190?'cr':ldl>=130?'ca':'ct',ldl>=190?'è€ƒæ…®FH':'');
  if(tg>0)c+=cell('TG',`${tg} mg/dL`,tg>=500?'cr':tg>=200?'ca':'ct',tg>=500?'âš ï¸èƒ°ç‚é¢¨éšª':'');
  if(hdl>0)c+=cell('HDL',`${hdl} mg/dL`,(sex==='male'?hdl<40:hdl<50)?'ca':'ct');
  c+=cell('ä»£è¬ç—‡å€™ç¾¤',`${msc}/5`,msc>=3?'cr':'ct',msc>=3?'ç¬¦åˆï¼ˆå°ç£æ¨™æº–ï¼‰':'æœªé”æ¨™æº–');
  if(crp>0)c+=cell('hsCRP',`${crp} mg/L`,crp>=2?'ca':'ct',crp>=2?'ä¸­è‡³é«˜ç‚ç—‡':'ä½ç‚ç—‡');
  document.getElementById('cv-cells').innerHTML=c;
  if(msc>0){const its=[ms_w&&`è…°åœ${waist}`,ms_t&&`TG${tg}`,ms_h&&`HDL${hdl}`,ms_b&&`BP${sbp}/${dbp}`,ms_d&&'ç³–å°¿ç—…'].filter(Boolean);document.getElementById('cv-ms').innerHTML=al(msc>=3?'ar':'ay',`${msc>=3?'âš ï¸ä»£è¬ç—‡å€™ç¾¤ï¼š':'éƒ¨åˆ†ä»£è¬ç•°å¸¸ï¼š'}${its.join('Â·')}`);}
  else document.getElementById('cv-ms').innerHTML='';
  let a='';
  if(sbp>180)a+=al('ar',`âš ï¸ BP ${sbp}/${dbp} â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œé«˜è¡€å£“å±è±¡`);
  if(ldl>=190)a+=al('ay','âš ï¸ LDL â‰¥190 â€” è€ƒæ…®å®¶æ—æ€§é«˜è†½å›ºé†‡è¡€ç—‡ï¼ŒAI å»ºè­°å°±é†«');
  if(tg>=500)a+=al('ar',`âš ï¸ TG â‰¥500 â€” AI å»ºè­°å°±é†«ï¼Œæ€¥æ€§èƒ°è‡Ÿç‚é¢¨éšª`);
  if(ascvd>=7.5)a+=al('ai','ğŸ“‹ ACC/AHAï¼š10å¹´é¢¨éšª â‰¥7.5%ï¼Œå»ºè­°é«˜å¼·åº¦ Statinï¼ˆRosuvastatin 20-40mgï¼‰');
  if(crp>=2&&ascvd!==null&&ascvd<7.5)a+=al('ai','ğŸ“‹ hsCRP â‰¥2mg/Lï¼šè€ƒæ…® Reynolds Risk Score é‡æ–°è©•ä¼°');
  document.getElementById('cv-alerts').innerHTML=a;
  document.getElementById('rp-cv').classList.add('on');
  document.getElementById('rp-cv').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ ANEMIA â”€â”€â”€
function calcAnemia(){
  const hb=v('an_hb'),mcv=v('an_mcv'),mchc=v('an_mchc'),rbc=v('an_rbc'),rdw=v('an_rdw');
  const si=v('an_si'),tibc=v('an_tibc'),ferritin=v('an_ferritin'),retic=v('an_retic');
  const b12=v('an_b12'),fol=v('an_fol'),ldh=v('an_ldh'),hap=v('an_hap'),wbc=v('an_wbc'),plt=v('an_plt');
  const sex=rv('an_sex')||'male';
  if(!hb){alert('è«‹è¼¸å…¥ Hb');return;}
  const cut=sex==='male'?13.5:12.0;
  let sev='ç„¡è²§è¡€',sc='ct';
  if(hb<cut){if(hb>=10){sev='è¼•åº¦è²§è¡€';sc='ca';}else if(hb>=8){sev='ä¸­åº¦è²§è¡€';sc='ca';}else{sev='é‡åº¦è²§è¡€';sc='cr';}}
  let type='',tc2='cs';
  if(mcv>0){if(mcv<80){type='å°çƒæ€§';tc2='cr';}else if(mcv<=100){type='æ­£çƒæ€§';tc2='ca';}else{type='å¤§çƒæ€§';tc2='cb';}}
  const mentzer=mcv>0&&rbc>0?mcv/rbc:null;
  const tsat=si>0&&tibc>0?si/tibc*100:null;
  let cause='';
  if(mcv<80){if(ferritin>0&&ferritin<(sex==='male'?30:13))cause='IDAå¯èƒ½';else if(mentzer!==null&&mentzer<13)cause='åœ°ä¸­æµ·å‹è²§è¡€å¯èƒ½';}
  else if(mcv>100){if(b12>0&&b12<200)cause='B12ç¼ºä¹';else if(fol>0&&fol<3)cause='è‘‰é…¸ç¼ºä¹';else cause='B12/è‘‰é…¸ç¼ºä¹/è‚ç—…/è—¥ç‰©';}
  else if(mcv>0){if(retic>2.5)cause='æº¶è¡€/å¤±è¡€ï¼ˆReticâ†‘ï¼‰';else cause='è…å› æ€§/æ…¢æ€§ç—…/æ—©æœŸç¼ºéµ';}
  const hemolysis=ldh>0&&ldh>600&&hap>0&&hap<25;
  document.getElementById('anemia-main').innerHTML=`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;color:var(--teal);text-transform:uppercase;">è²§è¡€åˆ†æ</div><div class="rbig ${sc}">Hb ${hb} g/dL</div><div style="font-size:12px;color:var(--t2);margin-top:4px;">${sev}${type?` Â· ${type}è²§è¡€`:''}${cause?` Â· ${cause}`:''}</div>`;
  let c=cell('Hb',`${hb} g/dL`,sc,sev);
  if(mcv>0)c+=cell('MCV',`${mcv} fL`,tc2,type);
  if(mentzer!==null)c+=cell('Mentzer',fmt(mentzer,2),mentzer<13?'ca':'ct',mentzer<13?'åœ°ä¸­æµ·å‹':'IDA');
  if(tsat!==null)c+=cell('Transferrin Sat',pct(tsat/100),tsat<16?'cr':'ct',tsat<16?'ç¼ºéµ':'');
  if(ferritin>0)c+=cell('Ferritin',`${ferritin} ng/mL`,ferritin<15?'cr':ferritin>200?'ca':'ct',ferritin<15?'ç¼ºéµ':ferritin>200?'ï¼ˆå¯èƒ½æ…¢æ€§ç—…ï¼‰':'');
  if(rdw>0)c+=cell('RDW',`${rdw}%`,rdw>14.5?'ca':'ct',rdw>14.5?'æ··åˆå‹ï¼Ÿ':'');
  if(b12>0)c+=cell('B12',`${b12} pg/mL`,b12<200?'cr':b12<300?'ca':'ct',b12<200?'ç¼ºä¹':'');
  if(fol>0)c+=cell('è‘‰é…¸',`${fol} ng/mL`,fol<3?'cr':'ct',fol<3?'ç¼ºä¹':'');
  if(hemolysis)c+=cell('æº¶è¡€æŒ‡æ¨™','â†‘ æº¶è¡€å¯èƒ½','cr','LDHâ†‘+Haptoâ†“');
  document.getElementById('anemia-cells').innerHTML=c;
  let a='';
  if(hb<7)a+=al('ar',`âš ï¸ Hb ${hb} â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œé‡åº¦è²§è¡€`);
  else if(hb<8)a+=al('ay',`âš ï¸ Hb ${hb} â€” AI å»ºè­°å°±é†«è©•ä¼°`);
  if(mentzer!==null&&mentzer<13)a+=al('ay','âš ï¸ Mentzer <13 â€” åœ°ä¸­æµ·å‹è²§è¡€å¯èƒ½ï¼Œå»ºè­° Hb é›»æ³³ç¢ºèª');
  if(hemolysis)a+=al('ar','âš ï¸ æº¶è¡€æŒ‡æ¨™ç•°å¸¸ï¼ˆLDHâ†‘ã€Haptoglobinâ†“ï¼‰â€” AI å»ºè­°å°±é†«ï¼Œè©•ä¼°æº¶è¡€åŸå› ');
  if(b12>0&&b12<200)a+=al('ai','B12 ç¼ºä¹ï¼šè©•ä¼°é£²é£Ÿã€æƒ¡æ€§è²§è¡€ï¼ˆAnti-IF Abï¼‰ã€Metformin ç›¸é—œ');
  document.getElementById('anemia-alerts').innerHTML=a;
  document.getElementById('rp-anemia').classList.add('on');
  document.getElementById('rp-anemia').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ LIVER â”€â”€â”€
function calcLiver(){
  const ast=v('lv_ast'),alt=v('lv_alt'),ggt=v('lv_ggt'),alp=v('lv_alp'),bili=v('lv_bili'),dbili=v('lv_dbili');
  const alb=v('lv_alb'),inr=v('lv_inr'),plt=v('lv_plt'),age=v('lv_age'),afp=v('lv_afp'),bmi=v('lv_bmi'),tp=v('lv_tp');
  const hbsag=sv('lv_hbsag'),hcv=sv('lv_hcv'),ascites=sv('lv_ascites'),he=sv('lv_he');
  const ratio=ast>0&&alt>0?ast/alt:null;
  if(ratio)document.getElementById('lv_ratio').value=fmt(ratio,2);
  let fib4=null,apri=null,cp=0;
  if(ast>0&&alt>0&&plt>0&&age>0)fib4=(age*ast)/(plt*Math.sqrt(alt));
  if(ast>0&&plt>0)apri=(ast/40)/(plt/100);
  if(bili>0||alb>0||inr>0){
    cp+=(bili<2?1:bili<=3?2:3);
    if(alb>0)cp+=(alb>3.5?1:alb>=2.8?2:3);
    if(inr>0)cp+=(inr<1.7?1:inr<=2.2?2:3);
    cp+=(ascites==='none'?1:ascites==='mild'?2:3);
    cp+=(he==='none'?1:he==='g12'?2:3);
  }
  const masld=bmi>=25&&(alt>40||ast>40)&&hbsag==='neg'&&hcv==='neg';
  let c='';
  if(ast>0)c+=cell('AST',`${ast} IU/L`,ast>400?'cr':ast>80?'ca':ast>40?'ca':'ct',ast>40?'åé«˜':'');
  if(alt>0)c+=cell('ALT',`${alt} IU/L`,alt>400?'cr':alt>80?'ca':alt>40?'ca':'ct',alt>40?'åé«˜':'');
  if(ratio)c+=cell('AST/ALT',fmt(ratio,2),ratio>2?'ca':'ct',ratio>2?'é…’ç²¾æ€§/è‚ç¡¬åŒ–ï¼Ÿ':'');
  if(fib4!==null)c+=cell('FIB-4',fmt(fib4,2),fib4>=3.25?'cr':fib4>=1.30?'ca':'ct',fib4>=3.25?'é«˜çº–ç¶­åŒ–':fib4>=1.30?'ä¸ç¢ºå®š':'ä½é¢¨éšª');
  if(apri!==null)c+=cell('APRI',fmt(apri,2),apri>=2?'cr':apri>=1?'ca':'ct',apri>=2?'é¡¯è‘—çº–ç¶­åŒ–':'');
  if(cp>0)c+=cell('Child-Pugh',`${cp}åˆ† ${cp<=6?'A':cp<=9?'B':'C'}`,cp>=10?'cr':cp>=7?'ca':'ct');
  if(bili>0)c+=cell('T-Bili',`${bili} mg/dL`,bili>3?'cr':bili>1.2?'ca':'ct');
  if(alb>0)c+=cell('Albumin',`${alb} g/dL`,alb<3.5?'ca':'ct',alb<3.5?'è‚åˆæˆâ†“':'');
  if(inr>0)c+=cell('INR',fmt(inr,2),inr>1.5?'cr':inr>1.2?'ca':'ct',inr>1.5?'å‡è¡€â†“':'');
  if(afp>0)c+=cell('AFP',`${afp}`,afp>20?'cr':afp>7?'ca':'ct',afp>20&&hbsag==='pos'?'âš ï¸HCCé¢¨éšª':'');
  if(masld)c+=cell('MASLD','é¢¨éšªå‡é«˜','ca','BMIâ‰¥25+è‚é…µç´ â†‘+ç„¡B/Cè‚');
  document.getElementById('liver-cells').innerHTML=c;
  let a='';
  if(alt>400||ast>400)a+=al('ar','âš ï¸ è‚é…µç´ æ€¥å‡ â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œæ€¥æ€§è‚ç‚/è—¥ç‰©æ€§æå‚·');
  if(inr>2.0)a+=al('ar',`âš ï¸ INR ${inr} â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œåš´é‡å‡è¡€éšœç¤™`);
  if(afp>200&&hbsag==='pos')a+=al('ar',`âš ï¸ AFP ${afp}+HBsAg+ â€” HCC é¢¨éšªï¼ŒAI å»ºè­°å°±é†«`);
  if(fib4!==null&&fib4>=3.25)a+=al('ay',`âš ï¸ FIB-4 ${fmt(fib4,2)} â€” é«˜çº–ç¶­åŒ–ï¼Œå»ºè­°èƒƒé¡/è‚è‡Ÿè¶…éŸ³æ³¢`);
  if(hbsag==='pos')a+=al('ai','ğŸ“‹ HBsAg+ï¼šå®šæœŸHBV DNAã€è…¹éƒ¨è¶…éŸ³æ³¢ã€‚è©•ä¼°æŠ—ç—…æ¯’æ²»ç™‚ï¼ˆå°ç£å¥ä¿çµ¦ä»˜ï¼‰');
  if(hcv==='pos')a+=al('ai','ğŸ“‹ Anti-HCV+ï¼šç¢ºèªHCV RNAï¼ŒDAAç™‚ç¨‹ï¼ˆå°ç£å¥ä¿12é€±ç™‚ç¨‹ï¼‰');
  if(masld)a+=al('ay','MASLDï¼ˆä»£è¬ç›¸é—œè„‚è‚ªè‚ï¼‰ï¼šç”Ÿæ´»å‹æ…‹ä»‹å…¥ã€æ§åˆ¶é«”é‡ï¼ŒFIB-4è©•ä¼°çº–ç¶­åŒ–ç¨‹åº¦');
  document.getElementById('liver-alerts').innerHTML=a;
  document.getElementById('rp-liver').classList.add('on');
  document.getElementById('rp-liver').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ THYROID â”€â”€â”€
function calcThyroid(){
  const tsh=v('th_tsh'),ft4=v('th_ft4'),ft3=v('th_ft3'),t4=v('th_t4'),tpo=v('th_tpo');
  const trab=v('th_trab'),cal_=v('th_cal'),dose=v('th_dose');
  const preg=sv('th_preg'),goiter=sv('th_goiter'),afib=sv('th_afib'),levo=sv('th_levo');
  if(!tsh){alert('è«‹è¼¸å…¥ TSH');return;}
  // Adjust TSH reference for pregnancy
  const tshRef=preg==='t1'?2.5:preg?3.0:4.0;
  const tshLow=preg?0.1:0.4;
  let diag='',dc='ct',dsub='';
  if(tsh<0.01){if(ft4>1.8||ft3>4.2){diag='é¡¯æ€§ç”²äº¢ï¼ˆç”²ç‹€è…ºæ©Ÿèƒ½äº¢é€²ï¼‰';dc='cr';dsub='TSHæ¥µä½+FT4/FT3å‡é«˜';}else{diag='äºè‡¨åºŠç”²äº¢';dc='ca';dsub='TSHä½ï¼ŒFT4/FT3æ­£å¸¸';}}
  else if(tsh<tshLow){diag='TSHåä½';dc='ca';dsub=preg?'å¦Šå¨ ï¼šéœ€å¯†åˆ‡è¿½è¹¤':'è¼•åº¦ç•°å¸¸ï¼Œå®šæœŸè¤‡æŸ¥';}
  else if(tsh>10){diag='é¡¯æ€§ç”²ä½ï¼ˆç”²ç‹€è…ºæ©Ÿèƒ½ä½ä¸‹ï¼‰';dc='cr';dsub='éœ€ Levothyroxine æ²»ç™‚';}
  else if(tsh>tshRef){diag=preg?'å¦Šå¨ ç”²ä½ï¼ˆéœ€ç©æ¥µæ²»ç™‚ï¼‰':'äºè‡¨åºŠç”²ä½';dc=preg?'cr':'ca';dsub=preg?'å½±éŸ¿èƒå…’ç¥ç¶“ç™¼è‚²':'TSHå‡é«˜ï¼ŒFT4æ­£å¸¸';}
  else{diag='ç”²ç‹€è…ºåŠŸèƒ½æ­£å¸¸';dc='ct';dsub=`TSH ${tsh} åœ¨æ­£å¸¸ç¯„åœ`;}
  // Graves suggestion
  if(tsh<0.1&&trab>1.75)dsub+=' Â· TRAbé™½æ€§ï¼ˆGravesç—…å¯èƒ½ï¼‰';
  document.getElementById('thyroid-main').innerHTML=`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;color:var(--teal);text-transform:uppercase;">ç”²ç‹€è…ºè©•ä¼° Â· ATA 2023</div><div class="rbig ${dc}">TSH ${tsh} mIU/L</div><div style="font-size:12px;color:var(--t2);margin-top:4px;">${diag} â€” ${dsub}</div>`;
  let c=cell('TSH',`${tsh} mIU/L`,dc,diag);
  if(ft4>0)c+=cell('Free T4',`${ft4} ng/dL`,ft4>1.8?'cr':ft4<0.8?'ca':'ct',ft4>1.8?'åé«˜':ft4<0.8?'åä½':'');
  if(ft3>0)c+=cell('Free T3',`${ft3} pg/mL`,ft3>4.2?'cr':ft3<2.3?'ca':'ct');
  if(tpo>0)c+=cell('Anti-TPO',`${tpo} IU/mL`,tpo>35?'ca':'ct',tpo>35?'æ©‹æœ¬æ°å¯èƒ½':'');
  if(trab>0)c+=cell('TRAb',`${trab} IU/L`,trab>1.75?'cr':'ct',trab>1.75?'Graveså¯èƒ½':'');
  if(dose>0&&levo==='yes'){const target=preg?'0.4-2.5':'0.5-4.0';c+=cell('LevoåŠ‘é‡',`${dose} Î¼g/d`,'cb',`TSHç›®æ¨™ ${target}`);}
  if(cal_>0)c+=cell('Calcitonin',`${cal_} pg/mL`,cal_>10?'cr':'ct',cal_>10?'âš ï¸ç”²ç‹€è…ºé«“æ¨£ç™Œï¼Ÿ':'');
  document.getElementById('thyroid-cells').innerHTML=c;
  let a='';
  if(tsh<0.01&&ft4>1.8)a+=al('ar','âš ï¸ é¡¯æ€§ç”²äº¢ â€” AI å»ºè­°å°±é†«ï¼Œè©•ä¼° MMI/PTU æˆ– I131');
  if(tsh>10)a+=al('ar','âš ï¸ é¡¯æ€§ç”²ä½ â€” AI å»ºè­°å°±é†«ï¼Œéœ€ Levothyroxine');
  if(preg&&tsh>2.5)a+=al('ar','âš ï¸ å¦Šå¨ ç”²ä½ â€” AI å»ºè­°ç«‹å³å°±é†«ï¼ŒLevothyroxine åŠ‘é‡èª¿æ•´');
  if(tpo>35)a+=al('ay','æ©‹æœ¬æ°ç”²ç‹€è…ºç‚ï¼šæ¯6-12æœˆè¿½è¹¤ TSHã€‚é€²å±•ç‚ºç”²ä½æ™‚éœ€æ²»ç™‚');
  if(trab>1.75)a+=al('ai','TRAb é™½æ€§ï¼šGraves ç—…è¨ºæ–·æ”¯æŒï¼Œè©•ä¼°æŠ—ç”²ç‹€è…ºè—¥ç‰©æ²»ç™‚');
  if(afib==='yes'&&tsh<0.4)a+=al('ay','âš ï¸ TSH åä½ + å¿ƒå¾‹ä¸æ•´ï¼šéœ€æ’é™¤ç”²äº¢å¼•ç™¼æˆ¿é¡«');
  document.getElementById('thyroid-alerts').innerHTML=a;
  document.getElementById('rp-thyroid').classList.add('on');
  document.getElementById('rp-thyroid').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ BONE â”€â”€â”€
function calcBone(){
  const ca=v('bn_ca'),p=v('bn_p'),pth=v('bn_pth'),vitd=v('bn_vitd'),alb=v('bn_alb'),mg=v('bn_mg'),alp=v('bn_alp');
  const egfr=v('bn_egfr'),tscore=v('bn_tscore'),rrt=sv('bn_rrt');
  const cca=ca>0&&alb>0?ca+0.8*(4-alb):null;
  if(cca)document.getElementById('bn_cca').value=fmt(cca,2);
  const cap=ca>0&&p>0?ca*p:null;
  if(cap)document.getElementById('bn_cap').value=fmt(cap,1);
  let c='';
  if(cca!==null)c+=cell('æ ¡æ­£éˆ£',`${fmt(cca,2)} mg/dL`,cca>12?'cr':cca>10.5?'ca':cca<7?'cr':cca<8.5?'ca':'ct',cca>12?'é«˜éˆ£å±è±¡':cca<7?'ä½éˆ£å±è±¡':cca<8.5?'ä½éˆ£':'æ­£å¸¸');
  else if(ca>0)c+=cell('è¡€éˆ£',`${ca} mg/dL`,ca>10.5?'ca':ca<8.5?'ca':'ct');
  if(p>0)c+=cell('ç£·',`${p} mg/dL`,p>4.5?'ca':p<2.5?'ca':'ct',p>4.5?'é«˜ç£·':p<2.5?'ä½ç£·':'æ­£å¸¸');
  if(cap)c+=cell('CaÃ—P',fmt(cap,1),cap>55?'cr':cap>50?'ca':'ct',cap>55?'âš ï¸è¡€ç®¡éˆ£åŒ–é¢¨éšª':'');
  if(pth>0){const tgt=egfr>0&&egfr<60?(egfr>=45?35:egfr>=30?70:150):65;c+=cell('PTH',`${pth} pg/mL`,pth>tgt*2?'cr':pth>tgt?'ca':'ct',`ç›®æ¨™<${tgt}`);}
  if(vitd>0)c+=cell('Vit D',`${vitd} ng/mL`,vitd<20?'cr':vitd<30?'ca':'ct',vitd<20?'ç¼ºä¹':vitd<30?'ä¸è¶³':'å……è¶³');
  if(mg>0)c+=cell('Mg',`${mg} mg/dL`,mg<1.7?'ca':mg>2.5?'ca':'ct',mg<1.7?'ä½é‚':'');
  if(tscore!==0&&tscore!==undefined&&sv('bn_tscore')!=='')c+=cell('T-score',`${tscore}`,tscore<=-2.5?'cr':tscore<=-1?'ca':'ct',tscore<=-2.5?'éª¨è³ªç–é¬†':tscore<=-1?'éª¨é‡æ¸›å°‘':'æ­£å¸¸');
  document.getElementById('bone-cells').innerHTML=c;
  let a='';
  if(cca!==null&&cca>12)a+=al('ar',`âš ï¸ æ ¡æ­£éˆ£ ${fmt(cca,2)} â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œé«˜éˆ£å±è±¡`);
  if(cca!==null&&cca<7)a+=al('ar',`âš ï¸ æ ¡æ­£éˆ£ ${fmt(cca,2)} â€” AI å»ºè­°ç«‹å³å°±é†«ï¼Œç—‡ç‹€æ€§ä½éˆ£`);
  if(egfr>0&&egfr<60){a+=al('ai',`ğŸ“‹ CKD G${egfr<30?'4-5':egfr<45?'3b':'3a'}ï¼šKDIGO å»ºè­°ç›£æ¸¬ Ca/P/PTH/Vit D`);}
  if(vitd>0&&vitd<20)a+=al('ay','Vit D ç¼ºä¹ï¼šè£œå…… D3 2000-4000 IU/å¤©ï¼Œ3å€‹æœˆå¾Œè¤‡æŸ¥');
  if(cap!==null&&cap>55)a+=al('ar',`âš ï¸ CaÃ—P ${fmt(cap,1)} >55 â€” ç•°ä½éˆ£åŒ–é¢¨éšªï¼Œéœ€ç©æ¥µé™ç£·`);
  document.getElementById('bone-alerts').innerHTML=a;
  document.getElementById('rp-bone').classList.add('on');
  document.getElementById('rp-bone').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ SENSITIVITY â”€â”€â”€
function calcSens(){
  let tp=v('s_tp'),fp=v('s_fp'),fn=v('s_fn'),tn=v('s_tn');
  const se_d=v('s_se'),sp_d=v('s_sp'),prev=v('s_prev');
  let se,sp,n=null;
  if(tp+fp+fn+tn>0){n=tp+fp+fn+tn;se=tp/(tp+fn);sp=tn/(tn+fp);}
  else if(se_d>0&&sp_d>0){se=se_d/100;sp=sp_d/100;}
  else{alert('è«‹è¼¸å…¥æ··æ·†çŸ©é™£æˆ–éˆæ•åº¦/ç‰¹ç•°åº¦');return;}
  const lr_p=se/(1-sp),lr_n=(1-se)/sp,youden=se+sp-1;
  const acc=n?((tp||0)+(tn||0))/n:null;
  let ppvb=null,npvb=null;
  if(prev>0){const p=prev/100;ppvb=se*p/(se*p+(1-sp)*(1-p));npvb=sp*(1-p)/(sp*(1-p)+(1-se)*p);}
  const ppv=n?tp/(tp+fp):null,npv=n?tn/(tn+fn):null;
  ['tp','fn','fp','tn'].forEach(k=>{const el=document.getElementById('cm-'+k),vals={tp,fn,fp,tn};if(el){const v2=vals[k];el.querySelector('div').textContent=v2!==null&&v2!==undefined?v2:'â€”';}});
  let c='';
  c+=cell('éˆæ•åº¦ Se',pct(se),se>=0.9?'ct':se>=0.7?'ca':'cr',se>=0.9?'å„ªï¼ˆç¯©æª¢ï¼‰':'');
  c+=cell('ç‰¹ç•°åº¦ Sp',pct(sp),sp>=0.95?'ct':sp>=0.8?'ca':'cr',sp>=0.95?'å„ªï¼ˆç¢ºè¨ºï¼‰':'');
  if(ppv!==null)c+=cell('PPV',pct(ppv),ppv>=0.8?'ct':'ca');
  if(npv!==null)c+=cell('NPV',pct(npv),npv>=0.9?'ct':'ca');
  if(ppvb!==null)c+=cell(`PPVï¼ˆç››è¡Œç‡${prev}%ï¼‰`,pct(ppvb),ppvb>=0.8?'ct':'ca','è²æ°ä¿®æ­£');
  if(npvb!==null)c+=cell(`NPVï¼ˆç››è¡Œç‡${prev}%ï¼‰`,pct(npvb),npvb>=0.9?'ct':'ca','è²æ°ä¿®æ­£');
  c+=cell('LR+',fmt(lr_p,2),lr_p>=10?'ct':lr_p>=5?'ca':'cr',lr_p>=10?'å¼·ç¢ºè¨ºåŠ›':'');
  c+=cell('LRâˆ’',fmt(lr_n,3),lr_n<=0.1?'ct':lr_n<=0.2?'ca':'cr',lr_n<=0.1?'å¼·æ’é™¤åŠ›':'');
  c+=cell("Youden's J",fmt(youden,3),youden>=0.7?'ct':youden>=0.5?'ca':'cr');
  if(acc!==null)c+=cell('æº–ç¢ºç‡',pct(acc),acc>=0.9?'ct':'ca');
  document.getElementById('sens-cells').innerHTML=c;
  document.getElementById('rp-sens').classList.add('on');
  document.getElementById('rp-sens').scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€ AI CHECK â”€â”€â”€
const SYMS_URGENT=['èƒ¸ç—›','å‘¼å¸å›°é›£','æ„è­˜ä¸æ¸…','å¤§é‡å‡ºè¡€'];
const SYMS_ALL=['é ­ç—›','é ­æšˆ','èƒ¸ç—›','å¿ƒæ‚¸','å‘¼å¸å›°é›£','å’³å—½','ç™¼ç‡’','è…¹ç—›','å™å¿ƒå˜”å','è…¹ç€‰','ä¾¿ç§˜','è¡€å°¿','æ°´è…«','ç–²å‹','é«”é‡æ¸›è¼•','å£æ¸´å¤šå°¿','è¦–åŠ›æ¨¡ç³Š','æ‰‹è…³éº»æœ¨','é—œç¯€ç–¼ç—›','çš®è†šé»ƒæŸ“','å¤±çœ ','é »å°¿','è„«é«®','çš®ç–¹','é ¸éƒ¨åƒµç¡¬','æ·‹å·´çµè…«å¤§','æ„è­˜ä¸æ¸…','å¤§é‡å‡ºè¡€','ç›œæ±—','é£Ÿæ…¾ä¸æŒ¯','æ’ä¾¿ç¿’æ…£æ”¹è®Š','èƒ¸æ‚¶','èƒŒç—›','å°ä¾¿é¡è‰²ç•°å¸¸'];
(()=>{const c=document.getElementById('sym-tags');if(!c)return;c.innerHTML=SYMS_ALL.map(s=>{const u=SYMS_URGENT.includes(s);return`<span class="stag ${u?'urgent':''}" onclick="togSym(this,'${s}')">${u?'âš ï¸':''}${s}</span>`;}).join('');})();
function togSym(el,s){const i=selSym.indexOf(s);if(i===-1){selSym.push(s);el.classList.add('on');}else{selSym.splice(i,1);el.classList.remove('on');}}
function clearAI(){selSym=[];document.querySelectorAll('.stag').forEach(e=>e.classList.remove('on'));['ai_note','ai_age','ai_med','ai_hx','ai_allergy'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});document.getElementById('ai_sev').value=5;document.getElementById('ai_sevv').textContent=5;document.getElementById('rp-ai').classList.remove('on');}
// â”€â”€â”€ API KEY LOCK/UNLOCK â”€â”€â”€
let aiApiUnlocked = false;

function onApiKeyChange(){
  const k = document.getElementById('ai_key').value;
  if(!k){ setAILocked(true); }
}

function setAILocked(locked){
  const container = document.getElementById('ai-fields-container');
  const badge = document.getElementById('ai-lock-badge');
  aiApiUnlocked = !locked;
  if(locked){
    container.className = 'ai-locked';
    badge.className = 'lock-badge';
    badge.textContent = 'ğŸ”’ è«‹å…ˆè¨­å®šä¸¦æ¸¬è©¦ API Key æ‰èƒ½ä½¿ç”¨';
  } else {
    container.className = 'ai-unlocked';
    badge.className = 'lock-badge unlocked';
    badge.textContent = 'ğŸ”“ API Key å·²é©—è­‰ï¼ŒåŠŸèƒ½å·²è§£é–';
  }
}

async function testAPIKey(){
  const k = document.getElementById('ai_key').value || localStorage.getItem('cc_key');
  if(!k){ alert('è«‹å…ˆè¼¸å…¥ Anthropic API Key'); return; }
  const statusEl = document.getElementById('ai-test-status');
  statusEl.className = 'test-status';
  statusEl.textContent = 'â³ æ¸¬è©¦ä¸­...';
  statusEl.style.display = 'inline-block';
  try{
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json','x-api-key':k,'anthropic-version':'2023-06-01'},
      body: JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:10,messages:[{role:'user',content:'ping'}]})
    });
    if(res.ok || res.status === 200){
      statusEl.className = 'test-status ok';
      statusEl.textContent = 'âœ“ é€£ç·šæˆåŠŸï¼åŠŸèƒ½å·²è§£é–';
      localStorage.setItem('cc_key', k);
      document.getElementById('dr_api').value = k;
      setAILocked(false);
    } else {
      const e = await res.json();
      statusEl.className = 'test-status fail';
      statusEl.textContent = 'âŒ ' + (e.error?.message || `éŒ¯èª¤ ${res.status}`);
      setAILocked(true);
    }
  } catch(e){
    statusEl.className = 'test-status fail';
    statusEl.textContent = 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message;
    setAILocked(true);
  }
}

function saveKey(){const k=document.getElementById('ai_key').value;if(k){localStorage.setItem('cc_key',k);alert('âœ“ API Key å·²å„²å­˜è‡³æœ¬æ©Ÿ');}}
async function runAI(){
  if(!document.getElementById('dis_agree').checked){alert('è«‹å…ˆé–±è®€ä¸¦å‹¾é¸åŒæ„å…è²¬è²æ˜');return;}
  const key=document.getElementById('ai_key').value||localStorage.getItem('cc_key');
  if(!key){alert('è«‹è¼¸å…¥ Anthropic API Key');return;}
  if(!selSym.length){alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹ç—‡ç‹€');return;}
  const urgentSelected=selSym.some(s=>SYMS_URGENT.includes(s));
  if(urgentSelected&&!confirm('âš ï¸ æ‚¨é¸æ“‡äº†å¯èƒ½ç·Šæ€¥çš„ç—‡ç‹€ã€‚è‹¥ç—‡ç‹€åš´é‡ï¼Œè«‹ç«‹å³å‰å¾€æ€¥è¨ºæˆ–æ’¥æ‰“119ï¼Œè€Œéä½¿ç”¨AIè©•ä¼°ã€‚\n\næ˜¯å¦ä»è¦ç¹¼çºŒ AI è©•ä¼°ï¼ˆè¼•ç—‡åƒè€ƒç”¨ï¼‰ï¼Ÿ'))return;
  showLoad('Claude AI ç—‡ç‹€åˆ†æä¸­...');
  try{
    const age=sv('ai_age'),sex=sv('ai_sex'),dur=sv('ai_dur'),sev=document.getElementById('ai_sev').value;
    const hx=sv('ai_hx'),med=sv('ai_med'),allergy=sv('ai_allergy'),note=sv('ai_note');
    const prompt=`ä½ æ˜¯å°ç£é†«ç™‚AIåŠ©æ‰‹ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼Œåˆ†æç—‡ç‹€ä¸¦æä¾›å»ºè­°ã€‚æ‰€æœ‰å»ºè­°éœ€æ¨™ç¤ºã€ŒAIå»ºè­°ã€å­—æ¨£ã€‚
å—æª¢è€…ï¼šå¹´é½¡${age||'æœªå¡«'}ï¼Œæ€§åˆ¥${sex||'æœªå¡«'}ï¼Œç—…å²ï¼š${hx||'ç„¡'}ï¼Œç”¨è—¥ï¼š${med||'ç„¡'}ï¼Œéæ•ï¼š${allergy||'ç„¡'}
ç—‡ç‹€ï¼š${selSym.join('ã€')}ã€‚æŒçºŒï¼š${dur||'æœªå¡«'}ã€‚åš´é‡åº¦è‡ªè©•ï¼š${sev}/10ã€‚è£œå……ï¼š${note||'ç„¡'}

è«‹ä»¥JSONå›æ‡‰ï¼š{"urgency":1-5,"label":"ç·Šæ€¥ç¨‹åº¦æè¿°","conditions":["å¯èƒ½è¨ºæ–·1","2","3"],"dept":"å»ºè­°ç§‘åˆ¥","home":["å±…å®¶å»ºè­°1","2","3"],"ai_see":["AIå»ºè­°å°±é†«æƒ…æ³1","2"],"warning":"è‹¥æœ‰ç·Šæ€¥è­¦ç¤ºå‰‡å¡«å…¥ï¼Œå¦å‰‡ç‚ºnull","follow":"å¾ŒçºŒè¿½è¹¤å»ºè­°"}`;
    const r=await callClaude(key,prompt,1000);
    const j=parseJ(r);
    if(j){
      const uc={1:'#00c9a7',2:'#65a30d',3:'#f59e0b',4:'#dc2626',5:'#dc2626'};
      document.getElementById('ai-main').innerHTML=`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1.5px;color:var(--teal);text-transform:uppercase;">AI ç—‡ç‹€è©•ä¼°ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰</div><div class="rbig" style="color:${uc[j.urgency]||uc[3]};font-size:22px;">${j.label||'å¾…è©•ä¼°'}</div>${j.warning?`<div class="al ar" style="margin-top:10px;">âš ï¸ AI å»ºè­°ç«‹å³å°±é†«ï¼š${j.warning}</div>`:''} ${j.urgency>=4?'<div class="al ar" style="margin-top:8px;">âš ï¸ AI å»ºè­°ç«‹å³å‰å¾€æ€¥è¨ºæˆ–æ’¥æ‰“ 119</div>':''}`;
      document.getElementById('ai-cells').innerHTML=cell('ç·Šæ€¥ç¨‹åº¦',`${j.urgency}/5`,j.urgency>=4?'cr':j.urgency>=3?'ca':'ct')+cell('å»ºè­°ç§‘åˆ¥',j.dept||'å®¶é†«ç§‘','cb');
      let d='';
      if(j.conditions?.length)d+=`<div class="aiblock"><div class="aih">å¯èƒ½ç›¸é—œç–¾ç—…ï¼ˆAI å»ºè­°åƒè€ƒï¼Œéè¨ºæ–·ï¼‰</div>${j.conditions.map(c=>`<div class="aipt"><div class="aidot"></div>${c}</div>`).join('')}</div>`;
      if(j.home?.length)d+=`<div class="aiblock"><div class="aih">å±…å®¶ç…§è­·å»ºè­°</div>${j.home.map(c=>`<div class="aipt"><div class="aidot"></div>${c}</div>`).join('')}</div>`;
      if(j.ai_see?.length)d+=`<div class="aiblock" style="border-color:rgba(244,63,94,.3);"><div class="aih" style="color:var(--rose);">AI å»ºè­°å°±é†«çš„æƒ…æ³</div>${j.ai_see.map(c=>`<div class="aipt"><div class="aidot" style="background:var(--rose);"></div>${c}</div>`).join('')}</div>`;
      if(j.follow)d+=`<div class="aiblock"><div class="aih">å¾ŒçºŒè¿½è¹¤</div><div class="aipt"><div class="aidot"></div>${j.follow}</div></div>`;
      document.getElementById('ai-detail').innerHTML=d;
      document.getElementById('rp-ai').classList.add('on');
      document.getElementById('rp-ai').scrollIntoView({behavior:'smooth'});
    }
  }catch(e){alert('AI è©•ä¼°å¤±æ•—ï¼š'+e.message);}finally{hideLoad();}
}

// â”€â”€â”€ DR SECTION â”€â”€â”€
let drSBMode=false;
// Date input events â€” handled by calcAgeFromPicker / calcAgeFromText
['dr_ht','dr_wt'].forEach(id=>{const e=document.getElementById(id);if(e)e.addEventListener('input',()=>{autoBMI();autoWHR();});});
document.getElementById('dr_hip')?.addEventListener('input',autoWHR);
['dr_fpg','dr_ins'].forEach(id=>{const e=document.getElementById(id);if(e)e.addEventListener('input',autoHOMA);});
['dr_tc','dr_hdl'].forEach(id=>{const e=document.getElementById(id);if(e)e.addEventListener('input',autoNHDL);});
document.getElementById('dr_cr')?.addEventListener('input',autoEGFR);
document.getElementById('dr_sex')?.addEventListener('change',()=>{autoEGFR();autoIBW();});
document.getElementById('dr_sex_b')?.addEventListener('change',()=>{autoEGFR();autoIBW();});

// â”€â”€â”€ DATE / AGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDobMode(mode){
  document.getElementById('dob-picker-mode').style.display = mode==='picker' ? '' : 'none';
  document.getElementById('dob-text-mode').style.display = mode==='text' ? '' : 'none';
}

function calcAgeFromPicker(){
  const y=parseInt(document.getElementById('dob_y')?.value||0);
  const m=parseInt(document.getElementById('dob_m')?.value||0);
  const d=parseInt(document.getElementById('dob_d')?.value||0);
  if(!y||!m||!d){document.getElementById('dr_age').value='';return;}
  const examDateEl=document.getElementById('dr_exam_date');
  const examDate=examDateEl?.value ? new Date(examDateEl.value) : new Date();
  const dob=new Date(y,m-1,d);
  let age=examDate.getFullYear()-dob.getFullYear();
  const mo=examDate.getMonth()-dob.getMonth();
  if(mo<0||(mo===0&&examDate.getDate()<dob.getDate()))age--;
  document.getElementById('dr_age').value=age>0&&age<130?age:'';
  // sync hidden field for storage
  document.getElementById('dr_dob').value=`${y}${String(m).padStart(2,'0')}${String(d).padStart(2,'0')}`;
  autoEGFR();autoIBW();
}

function syncExamDate(){
  const v=document.getElementById('dr_exam_date')?.value||'';
  if(v){const d=new Date(v);document.getElementById('dr_exam').value=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;}
  calcAgeFromPicker();
}

function calcAgeFromText(){
  const dob=document.getElementById('dr_dob_text')?.value||'';
  const exam=document.getElementById('dr_exam_text')?.value||'';
  const ageTarget=document.getElementById('dr_age_b');
  if(dob.length===8&&exam.length===8){
    const by=parseInt(dob.slice(0,4)),bm=parseInt(dob.slice(4,6)),bd=parseInt(dob.slice(6,8));
    const ey=parseInt(exam.slice(0,4)),em=parseInt(exam.slice(4,6)),ed=parseInt(exam.slice(6,8));
    let age=ey-by;
    if(em<bm||(em===bm&&ed<bd))age--;
    if(ageTarget)ageTarget.value=age>0&&age<130?age:'';
    // sync to main fields
    document.getElementById('dr_dob').value=dob;
    document.getElementById('dr_exam').value=exam;
    document.getElementById('dr_age').value=age>0?age:'';
    autoEGFR();autoIBW();
  }
}

function getDobMode(){
  const checked=document.querySelector('input[name="dob_mode"]:checked');
  return checked?checked.value:'picker';
}

function getDRSex(){
  const mode=getDobMode();
  if(mode==='text') return sv('dr_sex_b')||sv('dr_sex');
  return sv('dr_sex');
}

function getDRAge(){
  const mode=getDobMode();
  if(mode==='text'){
    const el=document.getElementById('dr_age_b');
    return el?parseInt(el.value)||null:null;
  }
  const el=document.getElementById('dr_age');
  return el?parseInt(el.value)||null:null;
}

// â”€â”€â”€ IDEAL BODY WEIGHT â”€â”€â”€
function autoIBW(){
  const ht=v('dr_ht'),wt=v('dr_wt');
  const sex=getDRSex();
  if(!ht||!sex){return;}
  let ibw;
  if(sex==='male') ibw=50+2.3*((ht/2.54)-60);
  else ibw=45.5+2.3*((ht/2.54)-60);
  ibw=Math.max(ibw,0);
  const ibwEl=document.getElementById('dr_ibw');
  const diffEl=document.getElementById('dr_wt_diff');
  const catEl=document.getElementById('dr_bmi_cat');
  if(ibwEl)ibwEl.value=ibw.toFixed(1)+' kg';
  if(diffEl&&wt)diffEl.value=(wt-ibw>0?'+':'')+(wt-ibw).toFixed(1)+' kg';
  if(catEl){
    const bmi=v('dr_bmi')||(ht&&wt?+(wt/((ht/100)**2)).toFixed(1):0);
    let cat='';
    if(bmi>0){if(bmi<18.5)cat='é«”é‡éè¼•';else if(bmi<24)cat='æ­£å¸¸é«”é‡';else if(bmi<27)cat='éé‡';else if(bmi<30)cat='è¼•åº¦è‚¥èƒ–';else if(bmi<35)cat='ä¸­åº¦è‚¥èƒ–';else cat='é‡åº¦è‚¥èƒ–';}
    catEl.value=cat;
  }
}
function autoBMI(){
  const ht=v('dr_ht'),wt=v('dr_wt');
  if(ht&&wt){document.getElementById('dr_bmi').value=(wt/((ht/100)**2)).toFixed(1);}
  autoIBW();
}
function autoWHR(){
  const w=v('dr_waist'),h=v('dr_hip');
  if(w&&h)document.getElementById('dr_whr').value=(w/h).toFixed(2);
}
function autoHOMA(){
  const fpg=v('dr_fpg'),ins=v('dr_ins');
  if(fpg&&ins)document.getElementById('dr_homa').value=(fpg*ins/405).toFixed(2);
}
function autoNHDL(){
  const tc=v('dr_tc'),hdl=v('dr_hdl');
  if(tc&&hdl)document.getElementById('dr_nhdl').value=tc-hdl;
}
function autoEGFR(){
  const cr=v('dr_cr');
  const sex=getDRSex();
  const age=getDRAge();
  if(cr&&sex&&age){const e=calcEGFR(cr,age,sex);if(e)document.getElementById('dr_egfr').value=e.toFixed(1);}
}

function getDRData(){
  const age=getDRAge();
  const ht=v('dr_ht'),wt=v('dr_wt');
  const bmi=ht&&wt?+(wt/((ht/100)**2)).toFixed(1):null;
  return{
    pid:sv('dr_pid')||(getDobMode()==='text'?sv('dr_pid_b'):''),exam_date:sv('dr_exam'),dob:sv('dr_dob'),sex:getDRSex(),age,
    ht,wt,bmi,sbp:v('dr_sbp')||null,dbp:v('dr_dbp')||null,hr:v('dr_hr')||null,
    waist:v('dr_waist')||null,hip:v('dr_hip')||null,bf:v('dr_bf')||null,
    fpg:v('dr_fpg')||null,hba1c:v('dr_hba1c')||null,ins:v('dr_ins')||null,cpep:v('dr_cpep')||null,
    tc:v('dr_tc')||null,tg:v('dr_tg')||null,ldl:v('dr_ldl')||null,hdl:v('dr_hdl')||null,
    ast:v('dr_ast')||null,alt:v('dr_alt')||null,cr:v('dr_cr')||null,
    egfr_calc:v('dr_cr')&&age&&getDRSex()?+(calcEGFR(v('dr_cr'),age,getDRSex())||0).toFixed(1):null,
    uacr:v('dr_uacr')||null,upcr:v('dr_upcr')||null,dip:sv('dr_dip'),
    ua:v('dr_ua')||null,bun:v('dr_bun')||null,k:v('dr_k')||null,
    hb:v('dr_hb')||null,wbc:v('dr_wbc')||null,plt:v('dr_plt')||null,mcv:v('dr_mcv')||null,hct:v('dr_hct')||null,
    hbsag:sv('dr_hbsag'),hcv:sv('dr_hcv'),hbsab:sv('dr_hbsab'),
    tsh:v('dr_tsh')||null,ft4:v('dr_ft4')||null,ca:v('dr_ca')||null,p:v('dr_p')||null,pth:v('dr_pth')||null,vitd:v('dr_vitd')||null,
    acs:sv('dr_acs')==='yes',cabg:sv('dr_cabg')==='yes',cvd:sv('dr_cvd')==='yes',
    dm:sv('dr_dm')==='yes',hl:sv('dr_hl')==='yes',htn:sv('dr_htn')==='yes',
    age_rf:sv('dr_agerf')==='yes',fh:sv('dr_fh')==='yes',smoke:sv('dr_smoke')==='yes',ckd:sv('dr_ckd')==='yes',
    edu:sv('dr_edu'),job:sv('dr_job'),eth:sv('dr_eth'),mar:sv('dr_mar'),
    etoh:sv('dr_etoh'),ex:sv('dr_ex'),diet:sv('dr_diet'),sleep:v('dr_sleep')||null,stress:sv('dr_stress'),
    sleep_work:v('dr_sleep_work')||null,
    smoke_detail:sv('dr_smoke_detail'),smoke_yrs:v('dr_smoke_yrs')||null,
    betel:sv('dr_betel'),
    ppg:v('dr_ppg')||null,
    fasting_hr:sv('dr_fasting'),
    ibw:sv('dr_ibw'),
    symptoms:sv('dr_symptoms'),pmh:sv('dr_pmh'),meds:sv('dr_meds'),allergy:sv('dr_allergy'),
    va_r:sv('dr_va_r'),va_l:sv('dr_va_l'),
    hear_r:sv('dr_hear_r'),hear_l:sv('dr_hear_l'),pe_note:sv('dr_pe_note'),
    ecg:sv('dr_ecg'),ecg_note:sv('dr_ecg_note'),
    xray:sv('dr_xray'),xray_note:sv('dr_xray_note'),
    oral:sv('dr_oral'),
    urine_color:sv('dr_urine_color'),urine_ph:v('dr_urine_ph')||null,urine_sg:v('dr_urine_sg')||null,
    urine_glu:sv('dr_urine_glu'),urine_ket:sv('dr_urine_ket'),urine_le:sv('dr_urine_le'),urine_nit:sv('dr_urine_nit'),
    urine_rbc:sv('dr_urine_rbc'),urine_wbc_m:sv('dr_urine_wbc_m'),urine_note:sv('dr_urine_note'),
    cea:v('dr_cea')||null,afp:v('dr_afp')||null,ca125:v('dr_ca125')||null,ca199:v('dr_ca199')||null,psa:v('dr_psa')||null,
    note:sv('dr_note'),doctor:sv('dr_docid')||drDocId,
  };
}

function judgeDR(d){
  const results=[];
  // 1. MetS
  const ms_w=d.waist>0&&(d.sex==='male'?d.waist>=90:d.waist>=80);
  const ms_t=d.tg>=150,ms_h=d.hdl>0&&(d.sex==='male'?d.hdl<40:d.hdl<50);
  const ms_b=d.sbp>=130||d.dbp>=85,ms_d=d.dm||d.fpg>=100||d.hba1c>=5.7;
  const msC=[ms_w,ms_t,ms_h,ms_b,ms_d].filter(Boolean).length;
  const msQ=ms_w&&msC>=3;
  results.push({name:'ğŸ¥ å¥ä¿ä»£è¬ç—‡å€™ç¾¤é˜²æ²»è¨ˆç•« æ”¶æ¡ˆè³‡æ ¼',qualified:msQ,partial:!ms_w&&msC>=3,
    items:[
      {ok:ms_w,text:`è…¹éƒ¨è‚¥èƒ–ï¼ˆç”·â‰¥90/å¥³â‰¥80 cmï¼‰â€” ç¾å€¼ï¼š${d.waist||'æœªå¡«'} cm`+(ms_w?' âœ“':'')},
      {ok:ms_t,text:`TG â‰¥150 mg/dL â€” ç¾å€¼ï¼š${d.tg||'æœªå¡«'}${ms_t?' âœ“':''}`},
      {ok:ms_h,text:`HDL ç”·&lt;40/å¥³&lt;50 â€” ç¾å€¼ï¼š${d.hdl||'æœªå¡«'}${ms_h?' âœ“':''}`},
      {ok:ms_b,text:`BP â‰¥130/85 mmHg â€” ç¾å€¼ï¼š${d.sbp||'â€”'}/${d.dbp||'â€”'}${ms_b?' âœ“':''}`},
      {ok:ms_d,text:`FPG â‰¥100 / HbA1c â‰¥5.7 / ç³–å°¿ç—… â€” ${d.fpg||d.hba1c||'â€”'}${ms_d?' âœ“':''}`},
    ],
    note:msQ?`âœ“ ç¬¦åˆæ”¶æ¡ˆï¼ˆè…¹åœå¿…å‚™+${msC}é …ï¼‰`:`è…°åœï¼š${ms_w?'âœ“ç¬¦åˆ':'âœ—æœªé”'} | ç¬¦åˆ${msC}/5é …ï¼Œéœ€è…°åœ+ä»»æ„3é …`
  });
  // 2. Early CKD
  const egfr=d.egfr_calc||null;
  const ckd_g3=egfr!==null&&egfr>=30&&egfr<60;
  const ckd_prot=d.uacr>=30||d.upcr>=150||(d.dip&&['1+','2+','3+'].includes(d.dip));
  const ckd_rf=d.dm||d.htn||d.ckd;
  const ckdQ=ckd_g3||(egfr!==null&&egfr<90&&ckd_prot&&ckd_rf);
  results.push({name:'ğŸ«˜ åˆæœŸæ…¢æ€§è…è‡Ÿç—…ï¼ˆEarly CKDï¼‰ç…§è­·è¨ˆç•« æ”¶æ¡ˆè³‡æ ¼',qualified:ckdQ,partial:ckd_prot&&!ckd_g3,
    items:[
      {ok:ckd_g3,text:`eGFR 30-59ï¼ˆG3a/G3bï¼‰â€” ç¾å€¼ï¼š${egfr?egfr.toFixed(1):'æœªå¡«ï¼ˆéœ€Cr/å¹´é½¡/æ€§åˆ¥ï¼‰'}`+(ckd_g3?' âœ“':'')},
      {ok:ckd_prot,text:`æŒçºŒè›‹ç™½å°¿ UACRâ‰¥30/UPCRâ‰¥150/è©¦ç´™1+ â€” UACR:${d.uacr||'â€”'} è©¦ç´™:${d.dip||'â€”'}`+(ckd_prot?' âœ“':'')},
      {ok:ckd_rf,warn:!ckd_rf,text:`åˆä½µå±éšªå› å­ï¼ˆç³–å°¿ç—…/é«˜è¡€å£“/CKDï¼‰â€” ${[d.dm&&'ç³–å°¿ç—…',d.htn&&'é«˜è¡€å£“',d.ckd&&'CKD'].filter(Boolean).join('/')||'æœªå¡«'}`+(ckd_rf?' âœ“':'')},
    ],
    note:ckdQ?`âœ“ ç¬¦åˆæ”¶æ¡ˆã€‚å»ºè­°æ¯3æœˆè¿½è¹¤eGFR/UACR/è¡€å£“/K+`:`eGFR ${egfr?egfr.toFixed(1):'æœªçŸ¥'}ï¼Œ${ckd_prot?'æœ‰è›‹ç™½å°¿':'ç„¡æ˜é¡¯è›‹ç™½å°¿'}ï¼Œ${ckd_rf?'æœ‰å±éšªå› å­':'ç„¡å±éšªå› å­'}`
  });
  // 3. Statin
  const rf_htn=d.htn,rf_age=d.age_rf,rf_fh=d.fh,rf_hdl=d.hdl>0&&d.hdl<40,rf_smoke=d.smoke;
  const rfC=[rf_htn,rf_age,rf_fh,rf_hdl,rf_smoke].filter(Boolean).length;
  const c1=d.acs||d.cabg||d.cvd;
  const c2=d.dm&&d.ldl>=100;
  const c3a=d.hl&&rfC>=2&&d.ldl>=130;
  const c3b=d.hl&&rfC<=1&&d.ldl>=160;
  const lipidQ=c1||c2||c3a||c3b;
  let ldl_tgt='';
  if(c1)ldl_tgt='LDL ç›®æ¨™ &lt;70 mg/dLï¼ˆæ¥µé«˜å±ï¼‰';
  else if(c2)ldl_tgt='LDL ç›®æ¨™ &lt;100 mg/dLï¼ˆç³–å°¿ç—…ï¼‰';
  else if(c3a||c3b)ldl_tgt='LDL ç›®æ¨™ &lt;130 mg/dL';
  results.push({name:'ğŸ’Š å…¨æ°‘å¥ä¿é™è†½å›ºé†‡è—¥ç‰©ï¼ˆStatinï¼‰é–‹ç«‹æ¢ä»¶',qualified:lipidQ,partial:false,
    items:[
      {ok:c1,text:`æ¢ä»¶ä¸€ï¼šACS/å† ç‹€å‹•è„ˆä»‹å…¥/å¿ƒè¡€ç®¡ç–¾ç—… â€” ${[d.acs&&'ACS',d.cabg&&'CABG',d.cvd&&'CVD'].filter(Boolean).join('/')||'å¦'}`+(c1?' âœ“':'')},
      {ok:c2,text:`æ¢ä»¶äºŒï¼šç³–å°¿ç—…+LDLâ‰¥100 â€” DM:${d.dm?'æ˜¯':'å¦'} LDL:${d.ldl||'â€”'}`+(c2?' âœ“':'')},
      {ok:c3a,text:`æ¢ä»¶ä¸‰Aï¼šé«˜è¡€è„‚ç—‡+â‰¥2å±éšªå› å­+LDLâ‰¥130 â€” RF:${rfC}å€‹ LDL:${d.ldl||'â€”'}`+(c3a?' âœ“':'')},
      {ok:c3b,text:`æ¢ä»¶ä¸‰Bï¼šé«˜è¡€è„‚ç—‡+â‰¤1å±éšªå› å­+LDLâ‰¥160 â€” RF:${rfC}å€‹ LDL:${d.ldl||'â€”'}`+(c3b?' âœ“':'')},
      {ok:false,warn:true,text:`å±éšªå› å­ï¼ˆ${rfC}/5ï¼‰ï¼š${[rf_htn&&'é«˜è¡€å£“',rf_age&&'å¹´é½¡',rf_fh&&'å®¶æ—å²',rf_hdl&&'HDL&lt;40',rf_smoke&&'å¸è¸'].filter(Boolean).join('ã€')||'ç„¡'}`},
    ],
    note:lipidQ?`âœ“ ç¬¦åˆå¥ä¿Statiné–‹ç«‹æ¢ä»¶ã€‚${ldl_tgt}`:`ç›®å‰ä¸ç¬¦åˆã€‚LDL:${d.ldl||'â€”'} å±éšªå› å­${rfC}å€‹`
  });
  return results;
}

// â”€â”€â”€ HEALTH REPORT GENERATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateHealthReport(d){
  const items = [];
  const bmi = d.bmi;
  const sex = d.sex;
  const age = d.age;

  // â”€â”€ BMI & é«”é‡ â”€â”€
  if(bmi){
    let cat='',rec='';
    if(bmi<18.5){cat='é«”é‡éè¼•';rec='å»ºè­°å¢åŠ ç†±é‡æ”å–ï¼Œå¯è«®è©¢ç‡Ÿé¤Šå¸«ã€‚';}
    else if(bmi<24){cat='æ­£å¸¸é«”é‡';rec='ç¶­æŒç¾æœ‰é£²é£ŸåŠé‹å‹•ç¿’æ…£ï¼Œå®šæœŸè¿½è¹¤ã€‚';}
    else if(bmi<27){cat='éé‡';rec='å»ºè­°æ¯é€±150åˆ†é˜ä»¥ä¸Šä¸­å¼·åº¦é‹å‹•ï¼Œæ¸›å°‘ç²¾ç·»æ¾±ç²‰åŠå«ç³–é£²æ–™ã€‚';}
    else if(bmi<30){cat='è¼•åº¦è‚¥èƒ–';rec='å»ºè­°ç©æ¥µæ¸›é‡ï¼Œç›®æ¨™æ¯æœˆ0.5-1kgï¼Œå¯è€ƒæ…®å°±é†«è©•ä¼°ã€‚';}
    else{cat='ä¸­é‡åº¦è‚¥èƒ–';rec='å»ºè­°å°±é†«è©•ä¼°ï¼Œè€ƒæ…®ä»£è¬ç—‡å€™ç¾¤ç¯©æª¢ï¼Œå¿…è¦æ™‚è½‰ä»‹è‚¥èƒ–ç—‡é–€è¨ºã€‚';}
    items.push({icon:'âš–ï¸',title:`BMI ${bmi}ï¼ˆ${cat}ï¼‰`,rec,level:bmi>=30?'danger':bmi>=27?'warn':bmi<18.5?'warn':'ok'});
  }

  // â”€â”€ è¡€å£“ â”€â”€
  if(d.sbp){
    let cat='',rec='';
    if(d.sbp>=180||d.dbp>=120){cat='é«˜è¡€å£“å±è±¡';rec='ç«‹å³å°±é†«ï¼é¿å…æ¿€çƒˆæ´»å‹•ã€‚';}
    else if(d.sbp>=140||d.dbp>=90){cat='é«˜è¡€å£“äºŒæœŸ';rec='å»ºè­°å°±é†«ï¼Œé™éˆ‰ï¼ˆ<6g/å¤©ï¼‰ã€DASHé£²é£Ÿã€è¦å¾‹é‹å‹•ã€æˆ’è¸ã€‚';}
    else if(d.sbp>=130){cat='é«˜è¡€å£“ä¸€æœŸ';rec='ç”Ÿæ´»å‹æ…‹ä»‹å…¥ï¼šæ¯é€±150åˆ†é˜æœ‰æ°§é‹å‹•ã€é™éˆ‰ã€æ§åˆ¶é«”é‡ã€‚';}
    else if(d.sbp>=120){cat='è¡€å£“åé«˜';rec='åŠ å¼·ç”Ÿæ´»å‹æ…‹æ”¹å–„ï¼Œ3-6å€‹æœˆå¾Œè¿½è¹¤ã€‚';}
    else{cat='æ­£å¸¸';rec='ç¶­æŒå¥åº·ç”Ÿæ´»å‹æ…‹ã€‚';}
    items.push({icon:'ğŸ©º',title:`è¡€å£“ ${d.sbp}/${d.dbp||'â€”'} mmHgï¼ˆ${cat}ï¼‰`,rec,level:d.sbp>=140||d.dbp>=90?'danger':d.sbp>=130?'warn':'ok'});
  }

  // â”€â”€ è¡€ç³– â”€â”€
  if(d.fpg||d.hba1c){
    const fpg=d.fpg||0,hba1c=d.hba1c||0;
    let title='',rec='',level='ok';
    if(fpg>=126||hba1c>=6.5){title=`è¡€ç³–ç•°å¸¸ï¼ˆFPG:${fpg||'â€”'} HbA1c:${hba1c||'â€”'}%ï¼‰`;rec='å»ºè­°å°±é†«ç¢ºèªç³–å°¿ç—…è¨ºæ–·ï¼Œè©•ä¼°é£²é£Ÿæ§åˆ¶ã€é‹å‹•åŠè—¥ç‰©æ²»ç™‚ã€‚';level='danger';}
    else if(fpg>=100||hba1c>=5.7){title=`å‰æœŸç³–å°¿ç—…ï¼ˆFPG:${fpg||'â€”'} HbA1c:${hba1c||'â€”'}%ï¼‰`;rec='ç”Ÿæ´»ä»‹å…¥å¯é™ä½50-60%é€²å±•é¢¨éšªï¼šé«”é‡æ¸›7%ã€æ¯é€±â‰¥150åˆ†é˜é‹å‹•ã€åœ°ä¸­æµ·å¼é£²é£Ÿã€‚';level='warn';}
    else{title=`è¡€ç³–æ­£å¸¸ï¼ˆFPG:${fpg||'â€”'} HbA1c:${hba1c||'â€”'}%ï¼‰`;rec='ç¶­æŒå¥åº·é£²é£Ÿï¼Œå®šæœŸè¿½è¹¤ã€‚';}
    items.push({icon:'ğŸ¬',title,rec,level});
  }
  if(d.ppg){
    let ppgRec='',ppgLevel='ok';
    if(d.ppg>=200){ppgRec='é£¯å¾Œè¡€ç³–â‰¥200ï¼Œç¬¦åˆç³–å°¿ç—…è¨ºæ–·ï¼ˆéœ€ç„¡ç—‡ç‹€è€…è¤‡æŸ¥ï¼‰ã€‚å»ºè­°å°±é†«ã€‚';ppgLevel='danger';}
    else if(d.ppg>=140){ppgRec='é£¯å¾Œè¡€ç³–åé«˜ï¼ˆå‰æœŸï¼‰ï¼šæ¸›å°‘é«˜GIé£Ÿç‰©ï¼Œé£¯å¾Œæ•£æ­¥15-30åˆ†é˜æœ‰åŠ©é™ä½ã€‚';ppgLevel='warn';}
    else ppgRec='é£¯å¾Œè¡€ç³–æ­£å¸¸ã€‚';
    items.push({icon:'ğŸš',title:`é£¯å¾Œè¡€ç³– ${d.ppg} mg/dL`,rec:ppgRec,level:ppgLevel});
  }

  // â”€â”€ è¡€è„‚ â”€â”€
  if(d.ldl){
    let ldlRec='',level='ok';
    if(d.ldl>=190){ldlRec='LDLæ¥µé«˜ï¼Œéœ€æ’é™¤å®¶æ—æ€§é«˜è†½å›ºé†‡è¡€ç—‡ï¼Œå»ºè­°å°±é†«è©•ä¼°Statinæ²»ç™‚ã€‚';level='danger';}
    else if(d.ldl>=160){ldlRec='LDLåé«˜ï¼šæ¸›å°‘é£½å’Œè„‚è‚ªï¼ˆç´…è‚‰ã€åŠ å·¥å“ï¼‰ã€å¢åŠ Omega-3ã€è¦å¾‹é‹å‹•ã€‚';level='warn';}
    else if(d.ldl>=130){ldlRec='LDLç¨é«˜ï¼šé£²é£Ÿèª¿æ•´ï¼Œä¾å¿ƒè¡€ç®¡é¢¨éšªæ±ºå®šæ˜¯å¦ç”¨è—¥ã€‚';}
    else ldlRec='LDLåœ¨ç›®æ¨™ç¯„åœå…§ã€‚';
    items.push({icon:'ğŸ©¸',title:`LDL ${d.ldl} mg/dL`,rec:ldlRec,level});
  }
  if(d.tg&&d.tg>=150){
    let tgRec='',level='warn';
    if(d.tg>=500){tgRec='TGâ‰¥500 æ€¥æ€§èƒ°è‡Ÿç‚é¢¨éšªï¼ç«‹å³å°±é†«ï¼Œåš´ç¦é£²é…’ã€‚';level='danger';}
    else if(d.tg>=200){tgRec='æˆ’é…’ã€æ¸›å°‘ç³–åˆ†ï¼ˆå«ç³–é£²æ–™ã€ç²¾ç·»æ¾±ç²‰ï¼‰ã€å¢åŠ Omega-3è„‚è‚ªé…¸ã€‚';level='warn';}
    else tgRec='TGåé«˜ï¼šå°‘ç³–å°‘é…’ï¼Œè¦å¾‹é‹å‹•ã€‚';
    items.push({icon:'ğŸ§ˆ',title:`ä¸‰é…¸ç”˜æ²¹é…¯ ${d.tg} mg/dL`,rec:tgRec,level});
  }

  // â”€â”€ è…åŠŸèƒ½ â”€â”€
  if(d.egfr_calc){
    let st='',rec='',level='ok';
    if(d.egfr_calc<15){st='G5è…è¡°ç«­';rec='ç«‹å³å°±é†«ï¼Œè©•ä¼°è…è‡Ÿæ›¿ä»£ç™‚æ³•ï¼ˆæ´—è…/ç§»æ¤ï¼‰ã€‚';level='danger';}
    else if(d.egfr_calc<30){st='G4é‡åº¦';rec='è…è‡Ÿç§‘è¿½è¹¤ï¼Œæº–å‚™è…æ›¿ä»£ç™‚æ³•ï¼Œåš´æ ¼æ§åˆ¶è¡€å£“/è¡€ç³–/è¡€è„‚ã€‚';level='danger';}
    else if(d.egfr_calc<60){st='G3ä¸­åº¦';rec='æ¯3-6å€‹æœˆè¿½è¹¤eGFR/UACRï¼Œæ§åˆ¶è¡€å£“<130/80ï¼Œè©•ä¼°SGLT2iä½¿ç”¨ã€‚';level='warn';}
    else if(d.egfr_calc<90){st='G2è¼•åº¦';rec='å®šæœŸè¿½è¹¤ï¼Œç•™æ„è›‹ç™½å°¿ï¼Œæ§åˆ¶ç³–å°¿ç—…/é«˜è¡€å£“ç­‰å±éšªå› å­ã€‚';}
    else{st='G1æ­£å¸¸';rec='ç¶­æŒå¥åº·ç”Ÿæ´»å‹æ…‹ï¼Œæ¯å¹´è¿½è¹¤ã€‚';}
    items.push({icon:'ğŸ«˜',title:`eGFR ${d.egfr_calc.toFixed(1)} mL/minï¼ˆ${st}ï¼‰`,rec,level});
  }

  // â”€â”€ æŠ½è¸ â”€â”€
  if(d.smoke_detail&&d.smoke_detail!=='never'&&d.smoke_detail!=='ex'&&d.smoke_detail!==''){
    items.push({icon:'ğŸš¬',title:`æŠ½è¸ï¼ˆ${d.smoke_detail}ï¼‰`,rec:'å»ºè­°æˆ’è¸ï¼æˆ’è¸å¾Œ1å¹´å† å¿ƒç—…é¢¨éšªæ¸›åŠï¼Œ10å¹´å¾Œæ¥è¿‘ä¸å¸è¸è€…ã€‚å¯åˆ©ç”¨æˆ’è¸é–€è¨ºï¼ˆå¥ä¿è£œåŠ©ï¼‰ã€å°¼å¤ä¸æ›¿ä»£ç™‚æ³•ã€‚',level:'danger'});
  }

  // â”€â”€ é£²é…’ â”€â”€
  if(d.etoh==='heavy'){
    items.push({icon:'ğŸº',title:'é‡åº¦é£²é…’',rec:'å»ºè­°æ¸›å°‘é£²é…’è‡³æ¯é€±â‰¤14æ¨™æº–æ¯ï¼ˆç”·æ€§ï¼‰ï¼Œæˆ–æ¯é€±â‰¤7æ¯ï¼ˆå¥³æ€§ï¼‰ã€‚éé‡é£²é…’å¢åŠ è‚ç—…ã€å¿ƒè¡€ç®¡ç–¾ç—…ã€ç™Œç—‡é¢¨éšªã€‚å¯è«®è©¢æˆç™®é†«å­¸é–€è¨ºã€‚',level:'danger'});
  } else if(d.etoh==='mild'){
    items.push({icon:'ğŸº',title:'è¼•åº¦é£²é…’',rec:'ç›®å‰é£²é…’é‡å°šå¯ï¼Œå»ºè­°å‹¿ç©ºè…¹é£²é…’ï¼Œé¿å…èˆ‡è—¥ç‰©ä½µç”¨ã€‚',level:'warn'});
  }

  // â”€â”€ æª³æ¦” â”€â”€
  if(d.betel&&d.betel!=='never'&&d.betel!==''){
    items.push({icon:'ğŸŒ¿',title:`åš¼æª³æ¦”ï¼ˆ${d.betel}ï¼‰`,rec:'å»ºè­°ç«‹å³æˆ’é™¤ï¼æª³æ¦”ç‚ºç¬¬ä¸€é¡è‡´ç™Œç‰©ï¼Œé¡¯è‘—å¢åŠ å£è…”ç™Œã€é£Ÿé“ç™Œã€å’½å–‰ç™Œé¢¨éšªã€‚å£è…”é»è†œéœ€å®šæœŸæª¢æŸ¥ã€‚',level:'danger'});
  }

  // â”€â”€ ç¡çœ  â”€â”€
  if(d.sleep&&(d.sleep<6||d.sleep>9)){
    const too=d.sleep<6?'ç¡çœ ä¸è¶³':'ç¡çœ éå¤š';
    const rec=d.sleep<6?'æ…¢æ€§ç¡çœ ä¸è¶³å¢åŠ ä»£è¬ç—‡å€™ç¾¤ã€å¿ƒè¡€ç®¡ç–¾ç—…é¢¨éšªã€‚å»ºè­°æ¯æ—¥7-9å°æ™‚ï¼Œå›ºå®šä½œæ¯ï¼Œé¿å…ç¡å‰ä½¿ç”¨3Cã€‚':'ç¡çœ éå¤šå¯èƒ½ç‚ºæ†‚é¬±æˆ–å…¶ä»–ç–¾ç—…å¾µå…†ï¼Œå»ºè­°å°±é†«è©•ä¼°ã€‚';
    items.push({icon:'ğŸ˜´',title:`${too}ï¼ˆ${d.sleep}hr/å¤©ï¼‰`,rec,level:'warn'});
  }

  // â”€â”€ é‹å‹• â”€â”€
  if(d.ex==='none'){
    items.push({icon:'ğŸƒ',title:'å¹¾ä¹ä¸é‹å‹•',rec:'å»ºè­°æ¯é€±è‡³å°‘150åˆ†é˜ä¸­å¼·åº¦æœ‰æ°§é‹å‹•ï¼ˆå¿«èµ°ã€æ¸¸æ³³ã€é¨è…³è¸è»Šï¼‰ï¼Œä¸¦åŠ å…¥æ¯é€±2æ¬¡è‚ŒåŠ›è¨“ç·´ã€‚è¦å¾‹é‹å‹•å¯é™ä½å¿ƒè¡€ç®¡ç–¾ç—…ã€ç³–å°¿ç—…ã€ç™Œç—‡é¢¨éšª30-50%ã€‚',level:'warn'});
  }

  // â”€â”€ Xå…‰ â”€â”€
  if(d.xray&&d.xray!=='æ­£å¸¸'&&d.xray!==''){
    const serious=['è‚ºçµç¯€','è‚ºæµ¸æ½¤','å¿ƒè‡Ÿæ“´å¤§','èƒ¸è…”ç©æ¶²'];
    const isSerious=serious.includes(d.xray);
    items.push({icon:'ğŸ“¸',title:`Xå…‰ï¼š${d.xray}${d.xray_note?' ('+d.xray_note+')':''}`,rec:isSerious?`å»ºè­°å°±é†«é€²ä¸€æ­¥è©•ä¼°ï¼Œå¯èƒ½éœ€è¦CTç­‰å½±åƒå­¸æª¢æŸ¥ã€‚${d.xray_note||''}`:`å»ºè­°è¿½è¹¤ï¼Œ${d.xray_note||'è«‹ä¾é†«å¸«æŒ‡ç¤º'}`,level:isSerious?'danger':'warn'});
  }

  // â”€â”€ ECG â”€â”€
  if(d.ecg&&d.ecg!=='æ­£å¸¸'&&d.ecg!==''){
    const serious=['å¿ƒæˆ¿é¡«å‹•','STè®ŠåŒ–'];
    const isSerious=serious.includes(d.ecg);
    items.push({icon:'ğŸ’“',title:`å¿ƒé›»åœ–ï¼š${d.ecg}${d.ecg_note?' ('+d.ecg_note+')':''}`,rec:isSerious?'å»ºè­°å¿ƒè‡Ÿç§‘å°±è¨ºï¼Œè©•ä¼°é€²ä¸€æ­¥æª¢æŸ¥åŠæ²»ç™‚ã€‚':'å»ºè­°è¿½è¹¤ï¼Œä¾ç—‡ç‹€åŠè‡¨åºŠåˆ¤æ–·ã€‚',level:isSerious?'danger':'warn'});
  }

  // â”€â”€ è…«ç˜¤æ¨™è¨˜ â”€â”€
  const tm=[];
  if(d.cea>5)tm.push(`CEA ${d.cea}ï¼ˆæ­£å¸¸<5ï¼‰`);
  if(d.afp>20)tm.push(`AFP ${d.afp}ï¼ˆæ­£å¸¸<20ï¼‰`);
  if(d.ca125>35)tm.push(`CA-125 ${d.ca125}ï¼ˆæ­£å¸¸<35ï¼‰`);
  if(d.ca199>37)tm.push(`CA 19-9 ${d.ca199}ï¼ˆæ­£å¸¸<37ï¼‰`);
  if(d.psa>4)tm.push(`PSA ${d.psa}ï¼ˆæ­£å¸¸<4ï¼‰`);
  if(tm.length){
    items.push({icon:'ğŸ”¬',title:`è…«ç˜¤æ¨™è¨˜ç•°å¸¸ï¼š${tm.join('ã€')}`,rec:'è…«ç˜¤æ¨™è¨˜å‡é«˜éœ€çµåˆè‡¨åºŠç—‡ç‹€èˆ‡å½±åƒåˆ¤è®€ï¼Œä¸ä»£è¡¨ç½¹ç™Œã€‚å»ºè­°å°±é†«è¤‡æŸ¥ä¸¦è¿½è¹¤ï¼Œå¿…è¦æ™‚è½‰ä»‹è…«ç˜¤ç§‘æˆ–ç›¸é—œç§‘åˆ¥ã€‚',level:'warn'});
  }

  return items;
}

function renderHealthReport(d){
  const items=generateHealthReport(d);
  if(!items.length)return '';
  const colorMap={danger:'var(--rose)',warn:'var(--amber)',ok:'var(--teal)'};
  const bgMap={danger:'rgba(244,63,94,.07)',warn:'rgba(245,158,11,.07)',ok:'rgba(0,201,167,.05)'};
  let html=`<div class="card" style="margin-top:16px;border-color:rgba(167,139,250,.2);">
    <div style="font-family:var(--ff-h);font-size:16px;font-weight:700;margin-bottom:14px;color:var(--violet);">ğŸ“‹ å¥åº·åˆ¤è®€å ±å‘Š</div>`;
  items.forEach(item=>{
    html+=`<div style="padding:12px 14px;border-radius:8px;margin-bottom:10px;background:${bgMap[item.level]||bgMap.ok};border-left:3px solid ${colorMap[item.level]||colorMap.ok};">
      <div style="font-weight:600;font-size:13px;margin-bottom:5px;">${item.icon} ${item.title}</div>
      <div style="font-size:12.5px;color:var(--t2);line-height:1.7;">ğŸ’¡ ${item.rec}</div>
    </div>`;
  });
  const dangerous=items.filter(i=>i.level==='danger').length;
  const warns=items.filter(i=>i.level==='warn').length;
  html+=`<div style="margin-top:14px;padding:10px 14px;background:var(--c2);border-radius:7px;font-size:12px;color:var(--t2);">
    <strong>æ‘˜è¦ï¼š</strong>ç™¼ç¾ <span style="color:var(--rose);">${dangerous} é …éœ€é—œæ³¨</span>ã€<span style="color:var(--amber);">${warns} é …å»ºè­°æ”¹å–„</span>ã€${items.filter(i=>i.level==='ok').length} é …æ­£å¸¸ã€‚
  </div>`;
  html+=`</div>`;
  return html;
}

async function runDR(withAI){
  const key=(document.getElementById('dr_api')?.value||localStorage.getItem('cc_key'));
  const d=getDRData();
  showLoad(withAI?'AI é†«å¸«åˆ¤è®€ä¸­...':'è¦å‰‡åˆ¤è®€ä¸­...');
  try{
    const qualify=judgeDR(d);
    let html='';
    if(d.pid)html+=`<div class="al ad" style="margin-bottom:10px;">ğŸ“‹ å—æª¢è€…ï¼š${d.pid}ã€€æ—¥æœŸï¼š${d.exam_date||'â€”'}ã€€æ€§åˆ¥ï¼š${d.sex==='male'?'ç”·æ€§':d.sex==='female'?'å¥³æ€§':'â€”'}ã€€å¹´é½¡ï¼š${d.age||'â€”'}æ­²ã€€eGFRï¼š${d.egfr_calc||'â€”'}</div>`;
    qualify.forEach(q=>{
      const ok=q.qualified,pt=q.partial;
      html+=`<div class="qbox" style="border-left-color:${ok?'var(--teal)':pt?'var(--amber)':'var(--t3)'};">
        <div class="qhead"><div class="qtit">${q.name}</div><span class="tag ${ok?'tt':pt?'ta':''}">${ok?'âœ“ ç¬¦åˆ':pt?'âš ï¸ éƒ¨åˆ†ç¬¦åˆ':'âœ— ä¸ç¬¦åˆ'}</span></div>
        <div class="qis">${q.items.map(i=>`<div class="qi"><div class="qdot ${i.ok?'qok':i.warn?'qwarn':'qno'}"></div><div>${i.text}</div></div>`).join('')}</div>
        ${q.note?`<div class="qnote">${q.note}</div>`:''}
      </div>`;
    });
    // Quick summary
    if(d.egfr_calc||d.fpg||d.ldl){
      const {s:st}=d.egfr_calc?getStage(d.egfr_calc):{s:''};
      html+=`<div class="card" style="margin-top:12px;"><div class="ch">é—œéµæ•¸å€¼å¿«è¦½</div><div style="display:grid;grid-template-columns:repeat(5,1fr);gap:9px;">${[
        d.bmi?`<div class="rcell"><div class="rl">BMI</div><div class="rv ${d.bmi>=27?'ca':'ct'}">${d.bmi}</div></div>`:'',
        d.egfr_calc?`<div class="rcell"><div class="rl">eGFR</div><div class="rv ${d.egfr_calc<60?'cr':d.egfr_calc<90?'ca':'ct'}">${d.egfr_calc}</div><div class="rs">${st}</div></div>`:'',
        d.hba1c?`<div class="rcell"><div class="rl">HbA1c</div><div class="rv ${d.hba1c>=6.5?'cr':d.hba1c>=5.7?'ca':'ct'}">${d.hba1c}%</div></div>`:'',
        d.ldl?`<div class="rcell"><div class="rl">LDL</div><div class="rv ${d.ldl>=190?'cr':d.ldl>=130?'ca':'ct'}">${d.ldl}</div></div>`:'',
        d.sbp?`<div class="rcell"><div class="rl">BP</div><div class="rv ${d.sbp>=140?'cr':d.sbp>=130?'ca':'ct'}">${d.sbp}/${d.dbp}</div></div>`:'',
      ].filter(Boolean).join('')}</div></div>`;
    }
    html += renderHealthReport(d);
    document.getElementById('dr-qualify').innerHTML=html;
    if(withAI){
      if(!key){document.getElementById('dr-ai').innerHTML=al('ay','æœªè¨­å®š API Keyï¼Œç„¡æ³•ä½¿ç”¨ AI é†«å¸«ã€‚è«‹è‡³ã€Œç³»çµ±è¨­å®šã€å¡«å…¥ã€‚');hideLoad();document.getElementById('rp-dr').classList.add('on');document.getElementById('rp-dr').scrollIntoView({behavior:'smooth'});return;}
      const prompt=`ä½ æ˜¯å°ç£å®¶é†«ç§‘/è…è‡Ÿç§‘AIé†«å¸«ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼Œåˆ†æå¥æª¢è³‡æ–™ä¸¦æä¾›å°ˆæ¥­å»ºè­°ã€‚æ‰€æœ‰å»ºè­°éœ€æ¨™ç¤ºã€ŒAIå»ºè­°ã€å­—æ¨£ã€‚
å¥æª¢è³‡æ–™ï¼š${JSON.stringify(d,null,0)}
åˆ¤è®€çµæœï¼š${qualify.map(q=>q.name+'ï¼š'+(q.qualified?'ç¬¦åˆ':'ä¸ç¬¦åˆ')).join('ï¼›')}
è«‹æä¾›ï¼š1.æ•´é«”å¥åº·é¢¨éšªè©•ä¼°ï¼ˆ2-3å¥ï¼‰2.æœ€éœ€é—œæ³¨çš„3å€‹å•é¡Œ 3.å…·é«”ç”Ÿæ´»åŠç”¨è—¥å»ºè­°3æ¢ 4.å»ºè­°è¿½è¹¤é …ç›®åŠé »ç‡
JSONï¼š{"overall":"æ•´é«”è©•ä¼°","top3":["å•é¡Œ1","å•é¡Œ2","å•é¡Œ3"],"lifestyle":["AIå»ºè­°1","AIå»ºè­°2","AIå»ºè­°3"],"follow_up":["è¿½è¹¤1é »ç‡","è¿½è¹¤2é »ç‡","è¿½è¹¤3é »ç‡"],"urgent":nullæˆ–"ç·Šæ€¥å°±é†«åŸå› "}`;
      const r=await callClaude(key,prompt,1500);
      const j=parseJ(r);
      if(j){
        document.getElementById('dr-ai').innerHTML=`<div class="aiblock" style="border-color:rgba(167,139,250,.3);">
          <div class="aih" style="color:var(--violet);">ğŸ¤– AI é†«å¸«ç¸½è©•ï¼ˆåƒ…ä¾›é†«å¸«åƒè€ƒï¼Œæ¨™ç¤ºã€ŒAIå»ºè­°ã€ï¼‰</div>
          ${j.urgent?`<div class="al ar" style="margin-bottom:12px;">âš ï¸ AI å»ºè­°ç«‹å³å°±é†«ï¼š${j.urgent}</div>`:''}
          <div style="font-size:13px;color:var(--t1);margin-bottom:12px;line-height:1.8;">${j.overall||''}</div>
          ${j.top3?.length?`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1px;color:var(--t3);text-transform:uppercase;margin:12px 0 8px;">æœ€éœ€é—œæ³¨å•é¡Œ</div>${j.top3.map(t=>`<div class="aipt"><div class="aidot"></div>${t}</div>`).join('')}`:''}
          ${j.lifestyle?.length?`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1px;color:var(--t3);text-transform:uppercase;margin:12px 0 8px;">ç”Ÿæ´»åŠç”¨è—¥å»ºè­°ï¼ˆAIå»ºè­°ï¼‰</div>${j.lifestyle.map(t=>`<div class="aipt"><div class="aidot"></div>${t}</div>`).join('')}`:''}
          ${j.follow_up?.length?`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1px;color:var(--t3);text-transform:uppercase;margin:12px 0 8px;">å»ºè­°è¿½è¹¤ï¼ˆAIå»ºè­°ï¼‰</div>${j.follow_up.map(t=>`<div class="aipt"><div class="aidot" style="background:var(--amber);"></div>${t}</div>`).join('')}`:''}
        </div>`;
      }else{document.getElementById('dr-ai').innerHTML=al('ay','AI å›æ‡‰è§£æå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');}
    }else document.getElementById('dr-ai').innerHTML='';
    document.getElementById('rp-dr').classList.add('on');
    document.getElementById('rp-dr').scrollIntoView({behavior:'smooth'});
  }catch(e){alert('åˆ¤è®€å¤±æ•—ï¼š'+e.message);}finally{hideLoad();}
}

function saveDraft(){
  const d=getDRData();
  const drafts=JSON.parse(localStorage.getItem('cc_drafts')||'[]');
  drafts.unshift({...d,saved_at:new Date().toISOString()});
  if(drafts.length>20)drafts.pop();
  localStorage.setItem('cc_drafts',JSON.stringify(drafts));
  alert('âœ“ å·²æš«å­˜ï¼ˆæœ€å¤š20ç­†ï¼‰');
}
function clearDR(){
  document.querySelectorAll('#s-dr .fi').forEach(e=>{if(!e.readOnly)e.value='';});
  document.querySelectorAll('#s-dr .fsel').forEach(e=>e.selectedIndex=0);
  ['dr_bmi','dr_egfr','dr_whr','dr_homa','dr_nhdl','dr_age','dr_age_b','dr_ibw','dr_wt_diff','dr_bmi_cat'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  ['dob_y','dob_m','dob_d'].forEach(id=>{const e=document.getElementById(id);if(e)e.selectedIndex=0;});
  const examDate=document.getElementById('dr_exam_date');if(examDate)examDate.value='';
  document.getElementById('rp-dr').classList.remove('on');
}
function exportDR(){
  const d=getDRData();const now=new Date().toLocaleString('zh-TW');
  const blob=new Blob([JSON.stringify({exported:now,...d},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`clincalc_${d.pid||'report'}_${Date.now()}.json`;a.click();
}

// â”€â”€â”€ SUPABASE â”€â”€â”€
function saveSB(){sbUrl=sv('sb_url');sbKey=sv('sb_key');localStorage.setItem('cc_sb_url',sbUrl);localStorage.setItem('cc_sb_key',sbKey);alert('âœ“ Supabase è¨­å®šå·²å„²å­˜');}
function loadStoredSB(){
  sbUrl=localStorage.getItem('cc_sb_url')||'';
  sbKey=localStorage.getItem('cc_sb_key')||'';
  const uk=localStorage.getItem('cc_key')||'';
  drDocId=localStorage.getItem('cc_docid')||'';
  if(sbUrl)document.getElementById('sb_url').value=sbUrl;
  if(sbKey)document.getElementById('sb_key').value=sbKey;
  if(uk){document.getElementById('ai_key').value=uk;document.getElementById('dr_api').value=uk;}
  if(drDocId)document.getElementById('dr_docid').value=drDocId;
  // Load multi-provider keys into Config
  ClinCalc.Config.ai.claudeKey = uk;
  ClinCalc.Config.ai.openaiKey = localStorage.getItem('cc_openai_key') || '';
  ClinCalc.Config.ai.geminiKey = localStorage.getItem('cc_gemini_key') || '';
  // Run retention purge if enabled
  if(ClinCalc.Config.retention.autoDelete) {
    const last = ClinCalc.Config.retention.lastCleanup;
    const now = new Date().toDateString();
    if(last !== now) {
      const purged = ClinCalc.Retention.purgeLocalDrafts();
      if(purged.deleted > 0) console.log(`[Retention] è‡ªå‹•æ¸…ç† ${purged.deleted} ç­†éæœŸè¨˜éŒ„`);
      localStorage.setItem('cc_last_cleanup', now);
      ClinCalc.Config.retention.lastCleanup = now;
    }
  }
}
function saveAPIKey(){
  const key=sv('dr_api');const docid=sv('dr_docid');
  if(key)localStorage.setItem('cc_key',key);
  if(docid){localStorage.setItem('cc_docid',docid);drDocId=docid;}
  document.getElementById('ai_key').value=key;
  alert('âœ“ å·²å„²å­˜');
}
async function testSB(){
  const url=sv('sb_url'),key=sv('sb_key');
  if(!url||!key){alert('è«‹å¡«å…¥ URL å’Œ Key');return;}
  showLoad('æ¸¬è©¦ Supabase é€£ç·š...');
  try{
    const r=await fetch(`${url}/rest/v1/patients?limit=1`,{headers:{'apikey':key,'Authorization':`Bearer ${key}`}});
    if(r.ok){document.getElementById('sb-status').innerHTML=al('ag','âœ“ Supabase é€£ç·šæˆåŠŸï¼è³‡æ–™è¡¨å·²å°±ç·’ã€‚');}
    else if(r.status===404){document.getElementById('sb-status').innerHTML=al('ay','âš ï¸ é€£ç·šæˆåŠŸä½†è³‡æ–™è¡¨ä¸å­˜åœ¨ï¼Œè«‹å…ˆåŸ·è¡Œä¸Šæ–¹ SQL å»ºç«‹è³‡æ–™è¡¨ã€‚');}
    else{document.getElementById('sb-status').innerHTML=al('ar',`âŒ é€£ç·šå¤±æ•—ï¼ˆ${r.status}ï¼‰ï¼Œè«‹ç¢ºèª URL å’Œ Keyã€‚`);}
  }catch(e){document.getElementById('sb-status').innerHTML=al('ar','âŒ é€£ç·šå¤±æ•—ï¼š'+e.message);}
  finally{hideLoad();}
}
async function saveToSB(){
  if(!sbUrl||!sbKey){alert('è«‹å…ˆè¨­å®š Supabase URL å’Œ Key');return;}
  const rawData=getDRData();
  if(!rawData.pid){alert('è«‹å¡«å…¥å—æª¢è€…ç·¨è™Ÿ');return;}
  // â”€â”€ DeID: sanitize before storing â”€â”€
  const deidWarnings = ClinCalc.DeID.audit(rawData);
  if(deidWarnings.length){
    if(!confirm(`âš ï¸ å»è­˜åˆ¥åŒ–è­¦å‘Šï¼š\n${deidWarnings.join('\n')}\n\nç¢ºå®šä»è¦ç¹¼çºŒå„²å­˜ï¼ˆç³»çµ±å°‡è‡ªå‹•éæ¿¾æ•æ„Ÿæ¬„ä½ï¼‰ï¼Ÿ`)) return;
  }
  const d = ClinCalc.DeID.sanitize(rawData);
  showLoad('å»è­˜åˆ¥åŒ–ä¸¦å„²å­˜è‡³ Supabase...');
  try{
    const qualify=judgeDR(rawData); // use raw for judgment
    const r=await fetch(`${sbUrl}/rest/v1/patients`,{method:'POST',
      headers:{'apikey':sbKey,'Authorization':`Bearer ${sbKey}`,'Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({
        doctor_id:d.doctor||drDocId,
        pid:d.pid_hash, // store pseudonymized ID only
        pid_display:d.pid_display,
        exam_date:d.exam_date,
        sex:d.sex,
        age:d.age,
        data:d, // sanitized data
        qualify_result:qualify,
        notes:null, // never store free-text notes
        expires_at: new Date(Date.now() + ClinCalc.Config.retention.days * 864e5).toISOString()
      })
    });
    if(r.ok||r.status===201){alert(`âœ“ å·²æˆåŠŸå„²å­˜è‡³ Supabaseï¼\nï¼ˆå»è­˜åˆ¥åŒ–ç‰ˆæœ¬ï¼Œä¿ç•™è‡³ ${new Date(Date.now()+ClinCalc.Config.retention.days*864e5).toLocaleDateString('zh-TW')}ï¼‰`);}
    else{const err=await r.json();alert('å„²å­˜å¤±æ•—ï¼š'+JSON.stringify(err));}
  }catch(e){alert('å„²å­˜å¤±æ•—ï¼š'+e.message);}
  finally{hideLoad();}
}
async function loadRecords(){
  const localDrafts=JSON.parse(localStorage.getItem('cc_drafts')||'[]');
  if(localDrafts.length){
    document.getElementById('local-records').innerHTML=`<div style="font-family:var(--ff-m);font-size:9px;letter-spacing:1px;color:var(--t3);text-transform:uppercase;margin-bottom:8px;">æœ¬æ©Ÿæš«å­˜è¨˜éŒ„ï¼ˆæœ€è¿‘${localDrafts.length}ç­†ï¼‰</div>`+
    localDrafts.map((d,i)=>`<div class="dbcard" onclick="showDetail(${i})">
      <div class="dbcard-h"><div class="dbcard-t">${d.pid||'ï¼ˆç„¡ç·¨è™Ÿï¼‰'}</div><span class="tag ${d.sex==='male'?'tb':'tv'}">${d.sex==='male'?'ç”·':'å¥³'} ${d.age||'â€”'}æ­²</span></div>
      <div class="dbcard-m">æ—¥æœŸï¼š${d.exam_date||'â€”'}ã€€eGFRï¼š${d.egfr_calc||'â€”'}ã€€HbA1cï¼š${d.hba1c||'â€”'}%ã€€LDLï¼š${d.ldl||'â€”'}</div>
      <div style="font-size:10.5px;color:var(--t3);margin-top:5px;">æš«å­˜ï¼š${new Date(d.saved_at).toLocaleString('zh-TW')}</div>
    </div>`).join('');
  }
  if(!sbUrl||!sbKey){document.getElementById('records-list').innerHTML=al('ad','å°šæœªé€£æ¥ Supabaseï¼Œé¡¯ç¤ºæœ¬æ©Ÿæš«å­˜è¨˜éŒ„ã€‚');return;}
  showLoad('è¼‰å…¥ Supabase è¨˜éŒ„...');
  try{
    const r=await fetch(`${sbUrl}/rest/v1/patients?order=created_at.desc&limit=50`,{headers:{'apikey':sbKey,'Authorization':`Bearer ${sbKey}`}});
    if(!r.ok){document.getElementById('records-list').innerHTML=al('ay','ç„¡æ³•è¼‰å…¥è¨˜éŒ„ï¼Œè«‹ç¢ºèªé€£ç·šè¨­å®š');return;}
    const data=await r.json();
    document.getElementById('records-list').innerHTML=data.length?data.map(rec=>`<div class="dbcard" onclick='showSBDetail(${JSON.stringify(rec).replace(/'/g,"&#39;")})'>
      <div class="dbcard-h"><div class="dbcard-t">${rec.pid||'ï¼ˆç„¡ç·¨è™Ÿï¼‰'}</div><span class="tag tt">å·²å„²å­˜</span></div>
      <div class="dbcard-m">æ—¥æœŸï¼š${rec.exam_date||'â€”'}ã€€é†«å¸«ï¼š${rec.doctor_id||'â€”'}</div>
      ${rec.notes?`<div class="dbcard-m" style="margin-top:4px;">${rec.notes}</div>`:''}
      <div style="font-size:10px;color:var(--t3);margin-top:4px;">${new Date(rec.created_at).toLocaleString('zh-TW')}</div>
    </div>`).join(''):al('ad','Supabase ä¸­å°šç„¡è¨˜éŒ„');
  }catch(e){document.getElementById('records-list').innerHTML=al('ar','è¼‰å…¥å¤±æ•—ï¼š'+e.message);}
  finally{hideLoad();}
}
async function searchRecords(){
  const pid=sv('search_pid');if(!pid){loadRecords();return;}
  if(!sbUrl||!sbKey){alert('è«‹å…ˆé€£æ¥ Supabase');return;}
  showLoad('æœå°‹ä¸­...');
  try{
    const r=await fetch(`${sbUrl}/rest/v1/patients?pid=eq.${encodeURIComponent(pid)}&order=created_at.desc`,{headers:{'apikey':sbKey,'Authorization':`Bearer ${sbKey}`}});
    const data=await r.json();
    document.getElementById('records-list').innerHTML=data.length?data.map(rec=>`<div class="dbcard"><div class="dbcard-t">${rec.pid}</div><div class="dbcard-m">${rec.exam_date} Â· eGFR:${rec.data?.egfr_calc||'â€”'} Â· HbA1c:${rec.data?.hba1c||'â€”'}%</div></div>`).join(''):al('ad','æœªæ‰¾åˆ°ç¬¦åˆè¨˜éŒ„');
  }catch(e){alert('æœå°‹å¤±æ•—ï¼š'+e.message);}finally{hideLoad();}
}
function showDetail(i){
  const drafts=JSON.parse(localStorage.getItem('cc_drafts')||'[]');
  const d=drafts[i];if(!d)return;
  document.getElementById('detail-content').innerHTML=`<div class="mt">${d.pid||'ï¼ˆç„¡ç·¨è™Ÿï¼‰'}</div><div class="ms">${d.exam_date||'â€”'} Â· ${d.sex==='male'?'ç”·':'å¥³'} ${d.age||'â€”'}æ­²</div><pre style="font-family:var(--ff-m);font-size:10px;color:var(--t2);overflow:auto;max-height:400px;background:var(--c2);padding:12px;border-radius:6px;">${JSON.stringify(d,null,2)}</pre>`;
  document.getElementById('modal-detail').classList.add('on');
}
function showSBDetail(rec){
  document.getElementById('detail-content').innerHTML=`<div class="mt">${rec.pid||'ï¼ˆç„¡ç·¨è™Ÿï¼‰'}</div><div class="ms">${rec.exam_date||'â€”'}</div><pre style="font-family:var(--ff-m);font-size:10px;color:var(--t2);overflow:auto;max-height:400px;background:var(--c2);padding:12px;border-radius:6px;">${JSON.stringify(rec.data,null,2)}</pre>`;
  document.getElementById('modal-detail').classList.add('on');
}

// â”€â”€â”€ REFS DB â”€â”€â”€
const REFS=[
  {id:'ada2026',title:'ADA 2026 Standards of Care in Diabetes',cat:'é†«ç™‚æŒ‡å¼•',date:'2026-01',url:'https://diabetesjournals.org/care/issue/49/Supplement_1',summary:'2026å¹´é‡å¤§æ›´æ–°ï¼š(1) CGM è¨ºæ–·æ™‚å³è€ƒæ…®ä½¿ç”¨ï¼›(2) GLP-1 RA é¦–æ¬¡æ¨è–¦ç”¨æ–¼ç¬¬1å‹ç³–å°¿ç—…åˆä½µè‚¥èƒ–ï¼›(3) é«˜å±æ‚£è€…è¡€å£“ç›®æ¨™æ›´æ–°ç‚º &lt;120 mmHgï¼›(4) SGLT2i æ“´å¤§ CKD ä¿è­·é©æ‡‰ç—‡ï¼›(5) æ–°å¢å¿ƒç†å¥åº·/ç„¦æ…®ç¯©æª¢ã€‚',status:'æœ€æ–°'},
  {id:'kdigo2024',title:'KDIGO 2024 CKD Evaluation and Management Guideline',cat:'é†«ç™‚æŒ‡å¼•',date:'2024',url:'https://kdigo.org/guidelines/ckd-evaluation-and-management/',summary:'CKD-EPI 2021 race-free eGFR å…¬å¼ã€‚å¼·åŒ– SGLT2i åœ¨ CKD çš„å¿ƒè…ä¿è­·è§’è‰²ã€‚UACR &lt;30/30-300/>300 ä¸‰ç´šåˆ†å±¤ã€‚å»ºè­°æ‰€æœ‰ CKD G3b-G5 è½‰ä»‹è…è‡Ÿç§‘ã€‚',status:'æœ‰æ•ˆ'},
  {id:'aha2022',title:'ACC/AHA 2022 High Blood Pressure Guideline',cat:'é†«ç™‚æŒ‡å¼•',date:'2022',url:'https://www.ahajournals.org/doi/10.1161/HYP.0000000000000065',summary:'å®šç¾©é«˜è¡€å£“ â‰¥130/80 mmHgã€‚å¼•å…¥ PCE å·¥å…·æ±ºå®šæ˜¯å¦å•Ÿå‹•é™å£“è—¥ã€‚å¼·èª¿ç”Ÿæ´»å‹æ…‹ä»‹å…¥å„ªå…ˆã€‚é«˜å±æ‚£è€…ç›®æ¨™ &lt;130/80 mmHgã€‚',status:'æœ‰æ•ˆ'},
  {id:'kdigo2017bone',title:'KDIGO 2017 CKD-MBD Guideline',cat:'é†«ç™‚æŒ‡å¼•',date:'2017',url:'https://kdigo.org/guidelines/ckd-mbd/',summary:'CKD G3b+ ç›£æ¸¬ Ca/P/PTH/Vit Dã€‚CaÃ—P ä¹˜ç©ç›®æ¨™ &lt;55 mgÂ²/dLÂ²ã€‚PTH ç›®æ¨™ä¾åˆ†æœŸèª¿æ•´ã€‚é¿å…å«éˆ£ç£·çµåˆåŠ‘éé‡ã€‚',status:'æœ‰æ•ˆ'},
  {id:'ata2023',title:'ATA 2023 Thyroid Guidelines',cat:'é†«ç™‚æŒ‡å¼•',date:'2023',url:'https://www.thyroid.org/thyroid-professionals/clinical-thyroidology/',summary:'TSH æ­£å¸¸å€¼ 0.4-4.0 mIU/Lã€‚å¦Šå¨ åˆæœŸç›®æ¨™ &lt;2.5ï¼Œä¸­æœ«æœŸ &lt;3.0ã€‚Graves ç—…é¦–é¸ ATD æ²»ç™‚ã€‚æ©‹æœ¬æ°ç”²ç‹€è…ºç‚æ¯å¹´ TSH ç›£æ¸¬ã€‚',status:'æœ‰æ•ˆ'},
  {id:'nhi_ms',title:'å°ç£å…¨æ°‘å¥ä¿ä»£è¬ç—‡å€™ç¾¤é˜²æ²»è¨ˆç•«',cat:'æ”¿åºœæ©Ÿé—œ',date:'2024',url:'https://www.nhi.gov.tw/Content_List.aspx?n=9AB97CA2A0A7C57D',summary:'æ”¶æ¡ˆè³‡æ ¼ï¼šè…¹éƒ¨è‚¥èƒ–ï¼ˆç”·â‰¥90/å¥³â‰¥80 cmï¼Œå¿…å‚™ï¼‰+ ä»»æ„3é …ä»£è¬ç•°å¸¸ï¼ˆTGâ‰¥150/HDLåä½/BPâ‰¥130/85/FPGâ‰¥100ï¼‰ã€‚å¥ä¿çµ¦ä»˜è¡›æ•™åŠè¿½è¹¤ã€‚',status:'æœ‰æ•ˆ'},
  {id:'nhi_ckd',title:'å°ç£å…¨æ°‘å¥ä¿æ—©æœŸæ…¢æ€§è…è‡Ÿç—…ç…§è­·è¨ˆç•«',cat:'æ”¿åºœæ©Ÿé—œ',date:'2023',url:'https://www.nhi.gov.tw/',summary:'æ”¶æ¡ˆå°è±¡ï¼šeGFR 30-59 (G3) æˆ– eGFR 60-89+æŒçºŒè›‹ç™½å°¿+å±éšªå› å­ï¼ˆç³–å°¿ç—…/é«˜è¡€å£“ï¼‰ã€‚æ¯3æœˆè¿½è¹¤è…åŠŸèƒ½/UACR/è¡€å£“ã€‚å¼·èª¿å»¶ç·©è…åŠŸèƒ½æƒ¡åŒ–ã€é™ä½é€æé¢¨éšªã€‚',status:'æœ‰æ•ˆ'},
  {id:'nhi_statin',title:'å…¨æ°‘å¥ä¿é™è†½å›ºé†‡è—¥ç‰©ï¼ˆStatinï¼‰çµ¦ä»˜è¦å®š',cat:'å¥ä¿è¦ç¯„',date:'2024',url:'https://www.nhi.gov.tw/Content_List.aspx?n=9AB97CA2A0A7C57D',summary:'çµ¦ä»˜æ¢ä»¶ï¼šâ‘  ACS/å† ç‹€å‹•è„ˆä»‹å…¥/CVDï¼›â‘¡ ç³–å°¿ç—…+LDLâ‰¥100ï¼›â‘¢ é«˜è¡€è„‚ç—‡+å±éšªå› å­ï¼ˆâ‰¥2å€‹RF:LDLâ‰¥130ï¼›â‰¤1å€‹RF:LDLâ‰¥160ï¼‰ã€‚å±éšªå› å­ï¼šé«˜è¡€å£“/å¹´é½¡/å®¶æ—å²/HDL&lt;40/å¸è¸ã€‚',status:'æœ‰æ•ˆ'},
  {id:'who_anemia',title:'WHO Haemoglobin Concentrations for Anaemia Diagnosis',cat:'åœ‹éš›æ©Ÿæ§‹',date:'2011',url:'https://www.who.int/publications/i/item/9789241598033',summary:'æˆäººè²§è¡€å®šç¾©ï¼šç”·æ€§ Hb &lt;13.5 g/dLï¼Œå¥³æ€§ &lt;12.0 g/dLï¼Œå¦Šå¨ æœŸå¥³æ€§ &lt;11.0 g/dLã€‚è¼•åº¦ï¼š10-12/10-13ï¼Œä¸­åº¦ï¼š8-9.9ï¼Œé‡åº¦ï¼š&lt;8ã€‚',status:'æœ‰æ•ˆ'},
  {id:'easl2023',title:'EASL Clinical Practice Guidelines on Non-Invasive Tests (MAFLD/MASLD)',cat:'é†«ç™‚æŒ‡å¼•',date:'2023',url:'https://easl.eu/publication/easl-clinical-practice-guidelines-on-non-invasive-tests-for-evaluation-of-liver-disease-severity-and-prognosis/',summary:'FIB-4 &lt;1.30 ä½çº–ç¶­åŒ–é¢¨éšªï¼Œâ‰¥3.25 é«˜çº–ç¶­åŒ–ã€‚APRI â‰¥2 é¡¯è‘—çº–ç¶­åŒ–ã€‚MASLDï¼ˆåŸNAFLDï¼‰å®šç¾©æ›´æ–°ï¼šä»£è¬å±éšªå› å­+è‚è„‚è‚ªè®Šæ€§+ç„¡å…¶ä»–ç—…å› ã€‚',status:'æœ‰æ•ˆ'},
  // â”€â”€â”€ å°ç£å­¸æœƒ â”€â”€â”€
  {id:'tas2024dm',title:'å°ç£ç³–å°¿ç—…å­¸æœƒ 2024 ç¬¬2å‹ç³–å°¿ç—…è‡¨åºŠç…§è­·æŒ‡å¼•',cat:'å°ç£å­¸æœƒ',date:'2024',url:'https://www.endo-dm.org.tw/dia/ALLDOC/dia2019_01/dia2019_01.asp',summary:'HbA1c ç›®æ¨™å€‹äººåŒ–ï¼ˆä¸€èˆ¬ <7%ï¼Œè¡°å¼±è€äºº <8.5%ï¼‰ã€‚SGLT2i/GLP-1 RA å„ªå…ˆç”¨æ–¼åˆä½µ ASCVD/CKD/HF çš„ç³–å°¿ç—…æ‚£è€…ã€‚CGM å»ºè­°ç”¨æ–¼ç¬¬1å‹åŠå¤šæ¬¡æ³¨å°„ç¬¬2å‹ã€‚',status:'æœ€æ–°'},
  {id:'tsn2023ckd',title:'å°ç£è…è‡Ÿé†«å­¸æœƒ CKD è¨ºç™‚æº–å‰‡ 2023',cat:'å°ç£å­¸æœƒ',date:'2023',url:'https://www.tsn.org.tw/UI/C/ClinicalGuideline.aspx',summary:'æ¡ç”¨ CKD-EPI 2021 race-free å…¬å¼è¨ˆç®— eGFRã€‚UACR åˆ†å±¤ï¼šæ­£å¸¸ <30ã€å¾®é‡ 30-300ã€å¤§é‡ >300 mg/gã€‚SGLT2i å»ºè­°ç”¨æ–¼ eGFR â‰¥20 + è›‹ç™½å°¿æ‚£è€…ã€‚è¡€å£“ç›®æ¨™ <130/80 mmHgã€‚',status:'æœ‰æ•ˆ'},
  {id:'tsh2023htn',title:'å°ç£é«˜è¡€å£“å­¸æœƒ 2023 é«˜è¡€å£“æŒ‡å¼•',cat:'å°ç£å­¸æœƒ',date:'2023',url:'https://www.hypertension.org.tw/',summary:'å®šç¾©ï¼šâ‰¥140/90 mmHgã€‚é«˜å±æ‚£è€…ï¼ˆDM/CKD/CVDï¼‰ç›®æ¨™ <130/80ã€‚ç”Ÿæ´»å‹æ…‹ä»‹å…¥ï¼šé™éˆ‰ <6g/æ—¥ã€DASH é£²é£Ÿã€è¦å¾‹é‹å‹•ã€æˆ’è¸ã€é™é…’ã€‚å°ç£ç™½è¢é«˜è¡€å£“ç››è¡Œç‡ç´„ 15-20%ã€‚',status:'æœ‰æ•ˆ'},
  {id:'tla2024lipid',title:'å°ç£è„‚è³ªå­¸æœƒ 2024 è¡€è„‚ç•°å¸¸è‡¨åºŠæ²»ç™‚æŒ‡å¼•',cat:'å°ç£å­¸æœƒ',date:'2024',url:'https://www.tla.org.tw/',summary:'ASCVD æ¥µé«˜å±ï¼šLDL ç›®æ¨™ <55 mg/dLã€‚é«˜å±ï¼ˆDM+é¶å™¨å®˜æå‚·ï¼‰ï¼šLDL <70 mg/dLã€‚ä¸€èˆ¬é«˜å±ï¼šLDL <100 mg/dLã€‚Statin + Ezetimibe + PCSK9i ä¸‰ç·šæ²»ç™‚ç­–ç•¥ã€‚',status:'æœ€æ–°'},
  // â”€â”€â”€ æ”¿åºœæ©Ÿé—œ â”€â”€â”€
  {id:'nhi_icd',title:'å¥ä¿ç½² ICD-10-CM å°ç£ç‰ˆï¼ˆTW-ICD-10-CMï¼‰å°ç…§è¡¨',cat:'æ”¿åºœæ©Ÿé—œ',date:'2024',url:'https://www.nhi.gov.tw/Content_List.aspx?n=D529DDFE5448BEAC',summary:'å°ç£å¥ä¿ç”³å ±ä½¿ç”¨ä¹‹ ICD-10-CM ç·¨ç¢¼æŸ¥è©¢å·¥å…·ã€‚åŒ…å«ä¸»è¦è¨ºæ–·ç¢¼ã€åˆä½µç—‡ç¢¼å°æ‡‰ã€‚æ¯å¹´10æœˆæ›´æ–°ï¼Œè‡¨åºŠç”³å ±å¿…å‚™åƒè€ƒã€‚',status:'æœ‰æ•ˆ'},
  {id:'nhi_drug',title:'å…¨æ°‘å¥ä¿è—¥å“æŸ¥è©¢ç³»çµ±ï¼ˆå¥ä¿ç½²ï¼‰',cat:'æ”¿åºœæ©Ÿé—œ',date:'2024',url:'https://www.nhi.gov.tw/QueryN/Query1.aspx',summary:'å¥ä¿çµ¦ä»˜è—¥å“æŸ¥è©¢ï¼šæˆåˆ†åã€å•†å“åã€å¥ä¿ç¢¼ã€çµ¦ä»˜è¦å®šã€å…±åŒè² æ“”ã€‚å¯æŸ¥è©¢æ˜¯å¦ç¬¦åˆå¥ä¿çµ¦ä»˜æ¢ä»¶åŠé™åˆ¶äº‹é …ã€‚æ¯æœˆæ›´æ–°ã€‚',status:'æœ‰æ•ˆ'},
  {id:'tfda_drug',title:'é£Ÿè—¥ç½²è—¥å“èªªæ˜æ›¸æŸ¥è©¢ï¼ˆTFDAï¼‰',cat:'æ”¿åºœæ©Ÿé—œ',date:'2024',url:'https://www.fda.gov.tw/TC/site.aspx?sid=3',summary:'å°ç£æ ¸å‡†è—¥å“ä»¿å–®ã€é©æ‡‰ç—‡ã€åŠ‘é‡ã€ç¦å¿Œã€å‰¯ä½œç”¨å®Œæ•´è³‡è¨Šã€‚æ˜¯å°ç£è—¥å“æ³•è¦æ ¸å‡†è³‡æ–™çš„æœ€çµ‚ä¾æ“šã€‚',status:'æœ‰æ•ˆ'},
  // â”€â”€â”€ å·¥å…·è³‡æº â”€â”€â”€
  {id:'mdcalc',title:'MDCalc â€” è‡¨åºŠè¨ˆç®—å™¨é›†åˆï¼ˆè‹±æ–‡ï¼‰',cat:'å·¥å…·è³‡æº',date:'2024',url:'https://www.mdcalc.com',summary:'æ”¶éŒ„ 500+ ç¶“éåŒå„•å¯©é–±çš„è‡¨åºŠè©•åˆ†å·¥å…·ï¼ŒåŒ…å« CHADS2-VAScã€CHA2DS2-VAScã€SOFAã€APACHE IIã€Framingham Risk Score ç­‰ã€‚é™„åŸå§‹æ–‡ç»å¼•ç”¨åŠè‡¨åºŠä½¿ç”¨èªªæ˜ã€‚',status:'æœ‰æ•ˆ'},
  {id:'drugs_com',title:'Drugs.com â€” è—¥ç‰©äº¤äº’ä½œç”¨æŸ¥è©¢ï¼ˆè‹±æ–‡ï¼‰',cat:'å·¥å…·è³‡æº',date:'2024',url:'https://www.drugs.com/drug_interactions.html',summary:'è—¥ç‰©äº¤äº’ä½œç”¨æŸ¥è©¢å·¥å…·ï¼Œæ”¯æ´å¤šç¨®è—¥ç‰©åŒæ™‚æª¢æŸ¥ã€‚åˆ†ç‚ºåš´é‡ï¼ˆSevereï¼‰ã€ä¸­ç­‰ï¼ˆModerateï¼‰ã€è¼•å¾®ï¼ˆMinorï¼‰ä¸‰ç´šã€‚è‡¨åºŠé–‹ç«‹å¤šç¨®è—¥ç‰©å‰å»ºè­°æŸ¥è©¢ã€‚',status:'æœ‰æ•ˆ'},
  {id:'uptodate_free',title:'å°ç£å¤§å­¸åœ–æ›¸é¤¨ UpToDate é€£ç·šèªªæ˜',cat:'å·¥å…·è³‡æº',date:'2024',url:'https://www.lib.ntu.edu.tw/',summary:'å°ç£å„å¤§é†«å­¸é™¢æ ¡åœ–æ›¸é¤¨æä¾› UpToDate æ ¡åœ’æˆæ¬Šã€‚è‡¨åºŠæ±ºç­–æ”¯æ´æœ€å®Œæ•´çš„å¾ªè­‰é†«å­¸è³‡æ–™åº«ï¼Œå« 30,000+ ä¸»é¡Œæ–‡ç« ï¼Œæ¯ 4-6 é€±æ›´æ–°ä¸€æ¬¡ã€‚è«‹é€éæ ¡åœ’ VPN æˆ–åœ–æ›¸é¤¨é€£ç·šä½¿ç”¨ã€‚',status:'æœ‰æ•ˆ'},
  {id:'pubmed',title:'PubMed / MEDLINE â€” é†«å­¸æ–‡ç»è³‡æ–™åº«ï¼ˆNLMï¼‰',cat:'å·¥å…·è³‡æº',date:'2024',url:'https://pubmed.ncbi.nlm.nih.gov',summary:'ç¾åœ‹åœ‹å®¶é†«å­¸åœ–æ›¸é¤¨æä¾›ä¹‹å…è²»é†«å­¸æ–‡ç»è³‡æ–™åº«ï¼Œæ”¶éŒ„ 3,500 è¬+ç¯‡æ–‡ç« ã€‚æ”¯æ´ MeSH è©å½™æŸ¥è©¢ã€è‡¨åºŠæŸ¥è©¢éæ¿¾å™¨ï¼ˆRCT/ç³»çµ±å›é¡§ï¼‰ã€‚æ˜¯é†«å­¸ç ”ç©¶æœå°‹çš„åŸºç¤å·¥å…·ã€‚',status:'æœ‰æ•ˆ'},
];
let refCatFilter = 'all';

function setCatFilter(cat, btn){
  refCatFilter = cat;
  document.querySelectorAll('.ref-cat-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  filterRefs();
}

function filterRefs(){
  const q = (document.getElementById('ref-search')?.value || '').toLowerCase();
  const filtered = REFS.filter(r => {
    const catOk = refCatFilter === 'all' || r.cat === refCatFilter;
    const textOk = !q || r.title.toLowerCase().includes(q) || r.summary.toLowerCase().includes(q) || r.cat.toLowerCase().includes(q);
    return catOk && textOk;
  });
  document.getElementById('refs-list').innerHTML = filtered.length ?
    filtered.map(r=>`<div class="dbcard" onclick="openRef('${r.id}')">
      <div class="dbcard-h">
        <div class="dbcard-t">${r.title}</div>
        <span class="tag ${r.status==='æœ€æ–°'?'tt':'tb'}">${r.status}</span>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:7px;">
        <span class="tag ta">${r.cat}</span>
        <span style="font-family:var(--ff-m);font-size:9px;color:var(--t3);">${r.date}</span>
      </div>
      <div class="dbcard-m">${r.summary}</div>
      <div class="dbcard-url">ğŸ”— <a href="${r.url}" target="_blank" onclick="event.stopPropagation()">${r.url}</a></div>
    </div>`).join('') :
    `<div class="al ad">æ‰¾ä¸åˆ°ç¬¦åˆã€Œ${q || refCatFilter}ã€çš„è³‡æ–™</div>`;
}

function renderRefs(){
  filterRefs();
}

function copySql(){
  const sql = document.getElementById('sql-block').textContent;
  navigator.clipboard.writeText(sql).then(()=>{ alert('âœ“ SQL å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿'); }).catch(()=>{ alert('è«‹æ‰‹å‹•è¤‡è£½ä¸Šæ–¹ SQL'); });
}
function openRef(id){
  const r=REFS.find(x=>x.id===id);if(!r)return;
  document.getElementById('detail-content').innerHTML=`<div class="mt">${r.title}</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;"><span class="tag ta">${r.cat}</span><span class="tag tb">${r.date}</span><span class="tag ${r.status==='æœ€æ–°'?'tt':'tb'}">${r.status}</span></div>
    <div class="al ai" style="margin-bottom:12px;"><div>${r.summary}</div></div>
    <div class="dbcard-url" style="font-size:13px;">ğŸ”— ä¾†æºï¼š<a href="${r.url}" target="_blank" style="color:var(--teal);">${r.url}</a></div>
    <div class="dis" style="margin-top:12px;">è‘—ä½œæ¬Šè²æ˜ï¼šæœ¬æ‘˜è¦ä¾†è‡ªå…¬é–‹æ‘˜è¦é é¢ï¼Œå®Œæ•´åŸæ–‡è«‹è‡³ä¸Šæ–¹é€£çµæŸ¥é–±ã€‚æœ¬ç³»çµ±ä¸è¤‡è£½å—ç‰ˆæ¬Šä¿è­·çš„å®Œæ•´æŒ‡å¼•å…§å®¹ã€‚</div>`;
  document.getElementById('modal-detail').classList.add('on');
}
// Custom sources
let customSources=JSON.parse(localStorage.getItem('cc_custom_src')||'[]');
function renderCustom(){
  document.getElementById('custom-list').innerHTML=customSources.length?customSources.map((s,i)=>`<div class="dbcard">
    <div class="dbcard-h"><div class="dbcard-t">${s.title}</div><span class="tag ta">è‡ªè¨‚</span></div>
    <div style="font-family:var(--ff-m);font-size:9px;color:var(--t3);margin-bottom:6px;">${s.cat} Â· ${s.date||'â€”'}</div>
    <div class="dbcard-m">${s.summary}</div>
    <div class="dbcard-url">ğŸ”— <a href="${s.url}" target="_blank">${s.url}</a></div>
    <button class="btn ba" style="margin-top:10px;padding:4px 10px;font-size:11px;" onclick="delCustom(${i})">ç§»é™¤</button>
  </div>`).join(''):al('ad','å°šç„¡è‡ªè¨‚ä¾†æº');
}
function addCustomSource(){
  const t=sv('cs_title'),u=sv('cs_url'),s=sv('cs_summary'),c=sv('cs_cat'),d=sv('cs_date');
  if(!t||!u){alert('è«‹å¡«å…¥æ¨™é¡Œå’Œç¶²å€');return;}
  customSources.unshift({title:t,url:u,summary:s,cat:c,date:d,added:new Date().toISOString()});
  localStorage.setItem('cc_custom_src',JSON.stringify(customSources));
  ['cs_title','cs_url','cs_summary','cs_date'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  renderCustom();alert('âœ“ å·²æ–°å¢è‡ªè¨‚ä¾†æº');
}
function delCustom(i){if(confirm('ç¢ºå®šç§»é™¤ï¼Ÿ')){customSources.splice(i,1);localStorage.setItem('cc_custom_src',JSON.stringify(customSources));renderCustom();}}

// â”€â”€â”€ API UTILS (Legacy wrappers â†’ delegate to ClinCalc.AI) â”€â”€â”€
async function callClaude(key,prompt,maxT=1000){
  // Delegate to unified provider â€” uses currently selected provider
  // but can be overridden with explicit key for legacy call
  const provider = ClinCalc.Config.ai.provider;
  return await ClinCalc.AI.call(prompt, maxT, {
    provider: key ? 'claude' : provider, // if explicit key given, force claude
    key: key || undefined
  });
}
function parseJ(txt){
  try{const s=txt.indexOf('{'),e=txt.lastIndexOf('}');if(s>-1&&e>s)return JSON.parse(txt.slice(s,e+1));}catch(e){}
  return null;
}
// Load stored keys
try{
  const k=localStorage.getItem('cc_key');
  if(k){
    ['ai_key','dr_api'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=k;});
    // If key was stored, still require re-test on page load for security
    // But show hint that key is present
    const statusEl = document.getElementById('ai-test-status');
    if(statusEl){ statusEl.className='test-status ok'; statusEl.textContent='â„¹ï¸ ç™¼ç¾å·²å„²å­˜çš„ Keyï¼Œè«‹é»ã€Œæ¸¬è©¦é€£ç·šã€é©—è­‰å¾Œè§£é–'; statusEl.style.display='inline-block'; }
  }
  // Initialize lock state
  setAILocked(true);
}catch(e){}
</script>
</body>
</html>
